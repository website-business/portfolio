<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>üöú Machine Fleet Dashboard ‚Äî V1 (Foundation Release)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-slate-100 text-slate-800">

<div class="max-w-7xl mx-auto p-4">

  <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
    <h1 class="text-2xl font-bold">üöú Machine Fleet Dashboard ‚Äî V1</h1>
    <div class="flex gap-2">
      <button id="reloadBtn" class="px-3 py-1 rounded bg-blue-600 text-white">üîÑ Reload</button>
    </div>
  </header>

  <!-- KPI -->
  <section class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
    <div class="bg-white p-3 rounded shadow">
      <div class="text-sm text-gray-500">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
      <div id="kpiTotal" class="text-2xl font-bold">-</div>
    </div>
    <div class="bg-white p-3 rounded shadow">
      <div class="text-sm text-gray-500">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
      <div id="kpiActive" class="text-2xl font-bold">-</div>
    </div>
    <div class="bg-white p-3 rounded shadow">
      <div class="text-sm text-gray-500">‡∏ã‡πà‡∏≠‡∏°</div>
      <div id="kpiRepair" class="text-2xl font-bold">-</div>
    </div>
    <div class="bg-white p-3 rounded shadow">
      <div class="text-sm text-gray-500">‡∏ß‡πà‡∏≤‡∏á</div>
      <div id="kpiIdle" class="text-2xl font-bold">-</div>
    </div>
  </section>

  <!-- Charts -->
  <section class="grid md:grid-cols-2 gap-4 mb-6">
    <div class="bg-white p-4 rounded shadow">
      <h2 class="font-semibold mb-2">‚õΩ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
      <canvas id="fuelChart"></canvas>
    </div>
    <div class="bg-white p-4 rounded shadow">
      <h2 class="font-semibold mb-2">üõ† ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
      <canvas id="maintChart"></canvas>
    </div>
  </section>

  <!-- Machine Table -->
  <section class="bg-white p-4 rounded shadow">
    <h2 class="font-semibold mb-2">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</h2>
    <div class="overflow-auto">
      <table class="w-full text-sm border">
        <thead class="bg-slate-200">
          <tr>
            <th class="p-2 border">‡∏£‡∏´‡∏±‡∏™</th>
            <th class="p-2 border">‡∏ä‡∏∑‡πà‡∏≠</th>
            <th class="p-2 border">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
            <th class="p-2 border">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th class="p-2 border">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
            <th class="p-2 border">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</th>
          </tr>
        </thead>
        <tbody id="machineTable"></tbody>
      </table>
    </div>
  </section>

</div>

<script>
// =========================
// üöÄ Version Name
// =========================
const VERSION = "V1 ‚Äî Foundation Release";

// =========================
// üîó Google Sheet CSV URLs (PUT YOUR LINKS HERE)
// =========================
const SHEETS = {
  machines: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQk9jak3sAnetueFVqbVYLXhHUYKFE7S7CxSZsEB_NQT_8vRyeN7j_B3OoIORlSPjRBLdDYU53k6fUl/pub?gid=2036292301&single=true&output=csv",
  fuel: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQk9jak3sAnetueFVqbVYLXhHUYKFE7S7CxSZsEB_NQT_8vRyeN7j_B3OoIORlSPjRBLdDYU53k6fUl/pub?gid=1215465404&single=true&output=csv",
  maintenance: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQk9jak3sAnetueFVqbVYLXhHUYKFE7S7CxSZsEB_NQT_8vRyeN7j_B3OoIORlSPjRBLdDYU53k6fUl/pub?gid=513299430&single=true&output=csv"
};

// =========================
// üì¶ Data Store
// =========================
const dataStore = {
  machines: [],
  fuel: [],
  maintenance: []
};

let fuelChart, maintChart;

// =========================
// üîÑ Load CSV Helper
// =========================
function loadCSV(url) {
  return new Promise((resolve, reject) => {
    Papa.parse(url, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: (result) => {
        if (result.errors && result.errors.length) {
          console.error("CSV Parse Error:", result.errors);
        }
        console.log("Loaded", url, "rows:", result.data.length);
        resolve(result.data);
      },
      error: (err) => {
        console.error("CSV Load Error:", err);
        reject(err);
      }
    });
  });
});
  });
}

// =========================
// üöÄ Load All Data
// =========================
async function loadData() {
  document.getElementById("reloadBtn").innerText = "‚è≥ Loading...";

  const [machines, fuel, maintenance] = await Promise.all([
    loadCSV(SHEETS.machines),
    loadCSV(SHEETS.fuel),
    loadCSV(SHEETS.maintenance)
  ]);

  dataStore.machines = machines;
  dataStore.fuel = fuel;
  dataStore.maintenance = maintenance;

  renderDashboard();

  document.getElementById("reloadBtn").innerText = "üîÑ Reload";
}

// =========================
// üìä Render Dashboard
// =========================
function renderDashboard() {
  renderKPI();
  renderMachineTable();
  renderFuelChart();
  renderMaintenanceChart();
}

// =========================
// üî¢ KPI
// =========================
function renderKPI() {
  const total = dataStore.machines.length;

  const active = dataStore.machines.filter(m => m["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"] === "‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô").length;
  const repair = dataStore.machines.filter(m => m["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"] === "‡∏ã‡πà‡∏≠‡∏°").length;
  const idle = total - active - repair;

  document.getElementById("kpiTotal").innerText = total;
  document.getElementById("kpiActive").innerText = active;
  document.getElementById("kpiRepair").innerText = repair;
  document.getElementById("kpiIdle").innerText = idle;
}

// =========================
// üìã Machine Table
// =========================
function renderMachineTable() {
  const tbody = document.getElementById("machineTable");
  tbody.innerHTML = "";

  dataStore.machines.forEach(m => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="border p-1">${m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"]}</td>
      <td class="border p-1">${m["‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"]}</td>
      <td class="border p-1">${m["‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó"]}</td>
      <td class="border p-1">${m["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"]}</td>
      <td class="border p-1">${m["‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô"]}</td>
      <td class="border p-1 text-right">${m["‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô"]}</td>
    `;
    tbody.appendChild(tr);
  });
}

// =========================
// ‚õΩ Fuel Chart (Monthly Sum)
// =========================
function renderFuelChart() {
  const monthly = {};

  dataStore.fuel.forEach(f => {
    if (!f["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"]) return;
    const month = f["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"].slice(0, 7); // YYYY-MM
    const cost = Number(f["‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢(‡∏ö‡∏≤‡∏ó)"] || 0);

    monthly[month] = (monthly[month] || 0) + cost;
  });

  const labels = Object.keys(monthly).sort();
  const values = labels.map(m => monthly[m]);

  if (fuelChart) fuelChart.destroy();

  fuelChart = new Chart(document.getElementById("fuelChart"), {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)",
        data: values
      }]
    }
  });
}

// =========================
// üõ† Maintenance Chart (Monthly Sum)
// =========================
function renderMaintenanceChart() {
  const monthly = {};

  dataStore.maintenance.forEach(m => {
    if (!m["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ã‡πà‡∏≠‡∏°"]) return;
    const month = m["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ã‡πà‡∏≠‡∏°"].slice(0, 7);
    const cost = Number(m["‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢(‡∏ö‡∏≤‡∏ó)"] || 0);

    monthly[month] = (monthly[month] || 0) + cost;
  });

  const labels = Object.keys(monthly).sort();
  const values = labels.map(m => monthly[m]);

  if (maintChart) maintChart.destroy();

  maintChart = new Chart(document.getElementById("maintChart"), {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)",
        data: values
      }]
    }
  });
}

// =========================
// üîò Events
// =========================
document.getElementById("reloadBtn").addEventListener("click", loadData);

// Auto load
loadData();
</script>

</body>
</html>