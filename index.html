<!DOCTYPE html>
<html lang="th" class="light">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
   <title>Fleet Management Dashboard v2.1 (Fuel Added)</title>
   
   <!-- Libraries -->
   <script src="https://cdn.tailwindcss.com"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
   <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
   <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
   
   <!-- Tailwind Config -->
   <script>
       tailwind.config = {
           darkMode: 'class',
           theme: { extend: { colors: { slate: { 850: '#1e293b', 900: '#0f172a' } } } }
       }
   </script>

   <style>
       @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
       body { font-family: 'Sarabun', sans-serif; -webkit-tap-highlight-color: transparent; }
       .fade-in { animation: fadeIn 0.4s ease-in-out; }
       @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
       .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
       .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
       .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
       .dark .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #475569; }
   </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-200 pb-20 transition-colors duration-300">

   <!-- Loading -->
   <div id="loading-overlay" class="fixed inset-0 bg-white/90 dark:bg-slate-900/90 z-[70] flex flex-col items-center justify-center backdrop-blur-sm">
       <div class="animate-spin rounded-full h-12 w-12 border-4 border-slate-200 dark:border-slate-700 border-t-blue-600 mb-4"></div>
       <p class="text-slate-600 dark:text-slate-300 font-semibold animate-pulse">กำลังประมวลผลข้อมูล...</p>
   </div>

   <!-- Navbar -->
   <nav class="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 sticky top-0 z-40 px-4 py-3 shadow-sm transition-colors duration-300">
       <div class="container mx-auto flex flex-wrap justify-between items-center gap-2">
           <div class="flex items-center gap-3">
               <div class="bg-blue-600 text-white p-2 rounded-lg shadow-md shadow-blue-100 dark:shadow-none">
                   <i class="fas fa-truck-moving text-lg"></i>
               </div>
               <div>
                   <h1 class="text-lg font-bold tracking-tight leading-tight text-slate-800 dark:text-white">Fleet Manager</h1>
                   <p class="text-[10px] text-slate-500 dark:text-slate-400 font-medium flex items-center gap-1">
                       <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span> Online v2.1
                   </p>
               </div>
           </div>
           
           <div class="flex items-center gap-2">
               <div class="hidden md:flex bg-slate-100 dark:bg-slate-700 p-1 rounded-lg border border-slate-200 dark:border-slate-600 mr-2">
                   <button onclick="setDeviceView('mobile')" id="btn-view-mobile" class="p-1.5 rounded text-slate-400 hover:text-blue-500" title="Mobile"><i class="fas fa-mobile-alt"></i></button>
                   <button onclick="setDeviceView('tablet')" id="btn-view-tablet" class="p-1.5 rounded text-slate-400 hover:text-blue-500" title="Tablet"><i class="fas fa-tablet-alt"></i></button>
                   <button onclick="setDeviceView('desktop')" id="btn-view-desktop" class="p-1.5 rounded bg-white dark:bg-slate-600 text-blue-600 dark:text-blue-400 shadow-sm" title="Desktop"><i class="fas fa-desktop"></i></button>
               </div>
               <button onclick="toggleDarkMode()" class="w-9 h-9 flex items-center justify-center rounded-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-yellow-400">
                   <i class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:block"></i>
               </button>
           </div>
       </div>
   </nav>

   <!-- Main Wrapper -->
   <div id="main-wrapper" class="w-full transition-all duration-300 mx-auto">
       <main class="p-4 space-y-6 mt-2 fade-in hidden" id="main-content">
           
           <!-- Global Filter: Year Selector -->
           <div class="flex justify-end mb-4">
               <div class="flex items-center gap-2 bg-white dark:bg-slate-800 px-4 py-2 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700">
                   <i class="fas fa-calendar-alt text-slate-400"></i>
                   <span class="text-sm font-bold text-slate-600 dark:text-slate-300">ปีงบประมาณ:</span>
                   <select id="global-year-filter" onchange="applyGlobalFilter()" class="bg-transparent text-sm font-bold text-blue-600 dark:text-blue-400 outline-none cursor-pointer">
                       <option value="ALL">ทั้งหมด</option>
                   </select>
               </div>
           </div>

           <!-- Tab Navigation -->
           <div class="flex justify-center mb-6 overflow-x-auto">
               <div class="bg-white dark:bg-slate-800 p-1.5 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 inline-flex gap-2 min-w-max">
                   <button onclick="switchTab('dashboard')" id="btn-dashboard" class="px-5 py-2 rounded-lg text-sm font-bold bg-blue-600 text-white shadow-md transition-all flex items-center gap-2"><i class="fas fa-chart-pie"></i> ภาพรวม</button>
                   <button onclick="switchTab('maintenance')" id="btn-maintenance" class="px-5 py-2 rounded-lg text-sm font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 transition-all flex items-center gap-2"><i class="fas fa-tools"></i> ซ่อมบำรุง</button>
                   <button onclick="switchTab('fuel')" id="btn-fuel" class="px-5 py-2 rounded-lg text-sm font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 transition-all flex items-center gap-2"><i class="fas fa-gas-pump"></i> น้ำมันเชื้อเพลิง</button>
                   <button onclick="switchTab('insurance')" id="btn-insurance" class="px-5 py-2 rounded-lg text-sm font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 transition-all flex items-center gap-2"><i class="fas fa-shield-alt"></i> ประกันภัย</button>
               </div>
           </div>

           <!-- VIEW 1: DASHBOARD -->
           <div id="view-dashboard" class="space-y-6 fade-in">
              ... (dashboard unchanged, omitted here to save space) ...
           </div>

           <!-- VIEW 2: MAINTENANCE -->
           <div id="view-maintenance" class="space-y-6 hidden fade-in">
              <!-- Search & Overview -->
              <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                 <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                    <div>
                       <h2 class="text-lg font-bold text-slate-800 dark:text-white"><i class="fas fa-tools text-purple-500 mr-2"></i>ระบบซ่อมบำรุง</h2>
                       <p class="text-xs text-slate-500 dark:text-slate-400">ประวัติและค่าใช้จ่ายซ่อมบำรุง</p>
                    </div>
                    <div class="relative w-full md:w-1/3">
                       <select id="maint-car-select" onchange="renderMaintenanceHistory()" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-3 text-slate-700 dark:text-slate-200 outline-none focus:ring-2 focus:ring-purple-500 cursor-pointer appearance-none">
                          <option value="">-- ดูภาพรวมทั้งหมด --</option>
                       </select>
                    </div>
                 </div>

                 <!-- ADDED: Maintenance KPIs (placeholders) -->
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                       <div class="text-xs text-slate-400 uppercase font-bold">รวมค่าใช้จ่ายซ่อม</div>
                       <div class="text-2xl font-bold text-slate-800 dark:text-white" id="kpi-maint-total">฿0</div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                       <div class="text-xs text-slate-400 uppercase font-bold">จำนวนรายการ</div>
                       <div class="text-2xl font-bold text-slate-800 dark:text-white" id="kpi-maint-count">0</div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                       <div class="text-xs text-slate-400 uppercase font-bold">เฉลี่ยต่อรายการ</div>
                       <div class="text-2xl font-bold text-slate-800 dark:text-white" id="kpi-maint-avg">฿0</div>
                    </div>
                 </div>

                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="maint-charts-area">
                    <div class="h-64 relative"><canvas id="maintTypeChart"></canvas></div>
                    <div class="h-64 relative"><canvas id="maintCostChart"></canvas></div>
                 </div>
              </div>

              <!-- History Table -->
              <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden">
                 <div class="p-4 border-b border-slate-100 dark:border-slate-700 font-bold text-slate-700 dark:text-slate-200 bg-slate-50/50 dark:bg-slate-800/50">รายการซ่อมบำรุงล่าสุด</div>
                 <div class="overflow-x-auto max-h-[600px] custom-scrollbar">
                    <table class="w-full text-sm text-left"><tbody id="maint-table-body" class="divide-y divide-slate-100 dark:divide-slate-700 bg-white dark:bg-slate-800"></tbody></table>
                 </div>
              </div>
           </div>

           <!-- VIEW 3: FUEL (NEW) -->
           <div id="view-fuel" class="space-y-6 hidden fade-in">
              ... (fuel view unchanged) ...
           </div>

           <!-- VIEW 4: INSURANCE -->
           <div id="view-insurance" class="space-y-6 hidden fade-in">
              ... (insurance view unchanged) ...
           </div>
       </main>
   </div>

   <script>
       // --- 1. CONFIG LINKS ---
       const LINKS = {
         CARS: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSWS4RbhZlYQ1RnZCM41Pz3UPYXVb5lFId8T6S8vyQyuYzox44BylJQdnzlUdmRzE4f0u7sPy75SuqY/pub?gid=0&single=true&output=csv",
         FUEL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSWS4RbhZlYQ1RnZCM41Pz3UPYXVb5lFId8T6S8vyQyuYzox44BylJQdnzlUdmRzE4f0u7sPy75SuqY/pub?gid=1526088813&single=true&output=csv",
         INS:  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSWS4RbhZlYQ1RnZCM41Pz3UPYXVb5lFId8T6S8vyQyuYzox44BylJQdnzlUdmRzE4f0u7sPy75SuqY/pub?gid=63476950&single=true&output=csv",
         MAINT: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSWS4RbhZlYQ1RnZCM41Pz3UPYXVb5lFId8T6S8vyQyuYzox44BylJQdnzlUdmRzE4f0u7sPy75SuqY/pub?gid=1747475810&single=true&output=csv"
       };

       // Global Data
       let rawData = { cars: [], fuel: [], ins: [], maint: [] };
       let charts = {};
       let availableYears = new Set();

       // --- Init ---
       window.onload = async () => {
           if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
               document.documentElement.classList.add('dark');
           }
           await loadData();
           // Default view logic
           if(window.innerWidth < 768) setActiveViewBtn('mobile');
           else if(window.innerWidth < 1024) setActiveViewBtn('tablet');
           else setActiveViewBtn('desktop');
       };

       async function loadData() {
           try {
               const [cars, fuel, ins, maint] = await Promise.all([
                   fetchCSV(LINKS.CARS), fetchCSV(LINKS.FUEL), fetchCSV(LINKS.INS), fetchCSV(LINKS.MAINT)
               ]);
               
               rawData.cars = cars.filter(r => r['ทะเบียนรถ']); 
               rawData.ins = ins.filter(r => r['ทะเบียนรถ']);
               
               // Process Dates & Years
               rawData.fuel = fuel.filter(r => r['วันที่']).map(r => {
                   r.dateObj = parseDate(r['วันที่']);
                   if(r.dateObj) availableYears.add(r.dateObj.getFullYear());
                   return r;
               });
               rawData.maint = maint.filter(r => r['วันที่']).map(r => {
                   r.dateObj = parseDate(r['วันที่']);
                   if(r.dateObj) availableYears.add(r.dateObj.getFullYear());
                   return r;
               });

               initYearFilter();
               initDashboard();
               initMaintenance();
               initFuelView();
               initInsurance();
               
               document.getElementById('loading-overlay').classList.add('hidden');
               document.getElementById('main-content').classList.remove('hidden');
           } catch (error) {
               console.error(error);
               alert("เกิดข้อผิดพลาดในการโหลดข้อมูล (ตรวจสอบ Link CSV)");
               document.getElementById('loading-overlay').classList.add('hidden');
           }
       }

       function fetchCSV(url) {
           return new Promise((resolve, reject) => {
               Papa.parse(url, { download: true, header: true, skipEmptyLines: true, complete: (res) => resolve(res.data), error: (err) => reject(err) });
           });
       }

       function initYearFilter() {
           const select = document.getElementById('global-year-filter');
           const years = Array.from(availableYears).sort((a,b) => b-a);
           select.innerHTML = '<option value="ALL">ทั้งหมด</option>';
           years.forEach(y => {
               const opt = document.createElement('option'); opt.value = y; opt.innerText = y; select.appendChild(opt);
           });
           if(years.length > 0) select.value = years[0]; 
       }

       function applyGlobalFilter() {
           initDashboard();
           renderMaintenanceHistory();
           renderFuelView();
       }

       // --- DASHBOARD ---
       function initDashboard() {
           const selectedYear = document.getElementById('global-year-filter').value;
           document.getElementById('kpi-total-cars').innerText = rawData.cars.length;
           const activeCount = rawData.cars.filter(c => c['สถานะ (ใช้งาน/ซ่อม)'] === 'ใช้งาน').length;
           document.getElementById('kpi-active-cars').innerText = activeCount;

           let fuelData = rawData.fuel;
           if(selectedYear !== 'ALL') {
               fuelData = fuelData.filter(r => r.dateObj && r.dateObj.getFullYear() == selectedYear);
           }
           
           const totalFuelCost = fuelData.reduce((sum, r) => sum + cleanNumber(r['ราคารวม']), 0);
           document.getElementById('kpi-fuel-cost').innerText = '฿' + totalFuelCost.toLocaleString();
           
           let months = 12;
           if(selectedYear !== 'ALL') {
               const distinctMonths = new Set(fuelData.map(r => r.dateObj.getMonth())).size;
               months = distinctMonths || 1;
           }
           const avgFuel = totalFuelCost / months;
           document.getElementById('kpi-fuel-avg').innerText = `เฉลี่ยต่อเดือน: ฿${avgFuel.toLocaleString(undefined, {maximumFractionDigits:0})}`;

           renderFuelChart(fuelData, selectedYear);
           renderStatusChart(activeCount, rawData.cars.length - activeCount);
       }

       function renderFuelChart(data, year) {
           const ctx = document.getElementById('fuelChart').getContext('2d');
           const textColor = document.documentElement.classList.contains('dark') ? '#94a3b8' : '#64748b';
           const monthlySum = new Array(12).fill(0);
           data.forEach(r => { if(r.dateObj) monthlySum[r.dateObj.getMonth()] += cleanNumber(r['ราคารวม']); });
           const labels = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
           
           if (charts.fuel) charts.fuel.destroy();
           charts.fuel = new Chart(ctx, {
               type: 'bar',
               data: { labels: labels, datasets: [{ label: 'ค่าน้ำมัน (บาท)', data: monthlySum, backgroundColor: '#3b82f6', borderRadius: 4 }] },
               options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: textColor } }, y: { grid: { color: document.documentElement.classList.contains('dark') ? '#334155' : '#e2e8f0' }, ticks: { color: textColor } } } }
           });
       }

       function renderStatusChart(active, repair) {
           const ctx = document.getElementById('statusChart').getContext('2d');
           if (charts.status) charts.status.destroy();
           charts.status = new Chart(ctx, {
               type: 'doughnut',
               data: { labels: ['ใช้งาน', 'ซ่อม'], datasets: [{ data: [active, repair], backgroundColor: ['#10b981', '#cbd5e1'], borderWidth: 0 }] },
               options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, color: document.documentElement.classList.contains('dark') ? '#e2e8f0' : '#475569' } } } }
           });
       }

       // --- FUEL VIEW (NEW) ---
       function initFuelView() {
           const select = document.getElementById('fuel-car-select');
           const carSet = new Set(rawData.fuel.map(r => r['ทะเบียนรถ']));
           [...carSet].sort().forEach(c => {
               const opt = document.createElement('option'); opt.value = c; opt.innerText = c; select.appendChild(opt);
           });
           renderFuelView();
       }

       function renderFuelView() {
           const carId = document.getElementById('fuel-car-select').value;
           const selectedYear = document.getElementById('global-year-filter').value;
           let data = rawData.fuel;

           if(selectedYear !== 'ALL') data = data.filter(r => r.dateObj && r.dateObj.getFullYear() == selectedYear);
           if(carId) data = data.filter(r => r['ทะเบียนรถ'] === carId);

           // KPIs
           const totalCost = data.reduce((s,r) => s + cleanNumber(r['ราคารวม']), 0);
           const totalLiters = data.reduce((s,r) => s + cleanNumber(r['จำนวนลิตร']), 0);
           
           // Calculate Distance (Max Odo - Min Odo)
           let distance = 0;
           if(data.length > 1) {
               const odos = data.map(r => cleanNumber(r['เลขไมล์ (Odometer)'])).filter(o => o > 0);
               if(odos.length > 0) distance = Math.max(...odos) - Math.min(...odos);
           }

           document.getElementById('kpi-f-cost').innerText = '฿' + totalCost.toLocaleString();
           document.getElementById('kpi-f-liter').innerText = totalLiters.toLocaleString() + ' L';
           document.getElementById('kpi-f-dist').innerText = distance.toLocaleString() + ' km';
           
           const costPerKm = distance > 0 ? totalCost / distance : 0;
           document.getElementById('kpi-f-rate').innerText = `อัตราสิ้นเปลือง: ฿${costPerKm.toFixed(2)}/กม.`;

           // Chart & Table
           renderFuelDetailChart(data, carId);
           renderFuelTable(data);
       }

       function renderFuelDetailChart(data, carId) {
           const ctx = document.getElementById('fuelDetailChart').getContext('2d');
           const textColor = document.documentElement.classList.contains('dark') ? '#94a3b8' : '#64748b';
           if (charts.fuelDetail) charts.fuelDetail.destroy();

           if (!carId) {
               // Top 10 Cars
               document.getElementById('fuel-chart-title').innerText = "10 อันดับรถที่ใช้น้ำมันสูงสุด";
               const carSum = {};
               data.forEach(r => {
                   const c = r['ทะเบียนรถ'];
                   if(!carSum[c]) carSum[c] = 0;
                   carSum[c] += cleanNumber(r['ราคารวม']);
               });
               const sorted = Object.keys(carSum).sort((a,b)=>carSum[b]-carSum[a]).slice(0,10);
               
               charts.fuelDetail = new Chart(ctx, {
                   type: 'bar',
                   data: { labels: sorted, datasets: [{ label: 'บาท', data: sorted.map(c=>carSum[c]), backgroundColor: '#3b82f6', borderRadius: 4 }] },
                   options: { responsive:true, maintainAspectRatio:false, scales: { x:{grid:{display:false}, ticks:{color:textColor}}, y:{grid:{display:false}, ticks:{color:textColor}} },
                   onClick: (e, els, chart) => {
                       if(els.length > 0) {
                           const label = chart.data.labels[els[0].index];
                           const sel = document.getElementById('fuel-car-select');
                           if([...sel.options].some(o=>o.value===label)) { sel.value = label; renderFuelView(); }
                       }
                   }, onHover: (e, el) => { e.native.target.style.cursor = el[0]?'pointer':'default'; }
                   }
               });
           } else {
               // Monthly for Car
               document.getElementById('fuel-chart-title').innerText = `ประวัติการเติมน้ำมัน: ${carId}`;
               const monthly = new Array(12).fill(0);
               data.forEach(r => { if(r.dateObj) monthly[r.dateObj.getMonth()] += cleanNumber(r['ราคารวม']); });
               const labels = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
               
               charts.fuelDetail = new Chart(ctx, {
                   type: 'line',
                   data: { labels: labels, datasets: [{ label: 'บาท', data: monthly, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4 }] },
                   options: { responsive:true, maintainAspectRatio:false, scales: { x:{grid:{display:false}, ticks:{color:textColor}}, y:{grid:{color:textColor}, ticks:{color:textColor}} } }
               });
           }
       }

       function renderFuelTable(data) {
           const tbody = document.getElementById('fuel-table-body');
           tbody.innerHTML = '';
           data.sort((a,b) => (b.dateObj||0) - (a.dateObj||0)).slice(0, 50).forEach(r => {
               tbody.innerHTML += `
               <tr class="hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors border-b border-slate-100 dark:border-slate-700">
                   <td class="px-4 py-3 font-mono text-slate-500">${r['วันที่']}</td>
                   <td class="px-4 py-3 font-bold text-slate-700 dark:text-slate-200">${r['ทะเบียนรถ']}</td>
                   <td class="px-4 py-3 text-right text-slate-600 dark:text-slate-300 font-mono">${cleanNumber(r['เลขไมล์ (Odometer)']).toLocaleString()}</td>
                   <td class="px-4 py-3 text-right text-slate-600 dark:text-slate-300">${r['จำนวนลิตร']}</td>
                   <td class="px-4 py-3 text-right text-slate-600 dark:text-slate-300">${r['ราคาต่อลิตร']}</td>
                   <td class="px-4 py-3 text-right font-bold text-slate-800 dark:text-white">฿${cleanNumber(r['ราคารวม']).toLocaleString()}</td>
               </tr>`;
           });
       }

       // --- MAINTENANCE VIEW ---
       function initMaintenance() {
           const select = document.getElementById('maint-car-select');
           const carSet = new Set(rawData.maint.map(r => r['ทะเบียนรถ']));
           [...carSet].sort().forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.innerText = c; select.appendChild(opt); });
           renderMaintenanceHistory();
       }

       function renderMaintenanceHistory() {
           const carId = document.getElementById('maint-car-select').value;
           const selectedYear = document.getElementById('global-year-filter').value;
           let data = rawData.maint;
           if(selectedYear !== 'ALL') data = data.filter(r => r.dateObj && r.dateObj.getFullYear() == selectedYear);
           if(carId) data = data.filter(r => r['ทะเบียนรถ'] === carId);

           const totalCost = data.reduce((s,r) => s + cleanNumber(r['ค่าใช้จ่าย']), 0);
           // Guard: update KPIs only if elements exist
           const elTotal = document.getElementById('kpi-maint-total');
           const elCount = document.getElementById('kpi-maint-count');
           const elAvg = document.getElementById('kpi-maint-avg');
           if (elTotal) elTotal.innerText = '฿' + totalCost.toLocaleString();
           if (elCount) elCount.innerText = data.length.toLocaleString();
           if (elAvg) elAvg.innerText = '฿' + (data.length ? (totalCost/data.length).toLocaleString(undefined,{maximumFractionDigits:0}) : 0);

           const ctx1 = document.getElementById('maintTypeChart').getContext('2d');
           const typeSum = {}; data.forEach(r => { const t = r['ประเภทการซ่อม']||'อื่นๆ'; typeSum[t] = (typeSum[t]||0) + cleanNumber(r['ค่าใช้จ่าย']); });
           if(charts.maintType) charts.maintType.destroy();
           charts.maintType = new Chart(ctx1, { type: 'doughnut', data: { labels: Object.keys(typeSum), datasets: [{ data: Object.values(typeSum), backgroundColor: ['#3b82f6','#ef4444','#10b981','#f59e0b','#8b5cf6'], borderWidth:0 }] }, options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right'}} } });

           const ctx2 = document.getElementById('maintCostChart').getContext('2d');
           if(charts.maintCost) charts.maintCost.destroy();
           if(!carId) {
               const carSum = {}; data.forEach(r => { carSum[r['ทะเบียนรถ']] = (carSum[r['ทะเบียนรถ']]||0) + cleanNumber(r['ค่าใช้จ่าย']); });
               const sorted = Object.keys(carSum).sort((a,b)=>carSum[b]-carSum[a]).slice(0,10);
               charts.maintCost = new Chart(ctx2, { type: 'bar', data: { labels: sorted, datasets: [{ label: '10 อันดับซ่อมแพง', data: sorted.map(c=>carSum[c]), backgroundColor: '#8b5cf6', borderRadius: 4 }] }, options: { responsive:true, maintainAspectRatio:false, scales:{x:{grid:{display:false}},y:{grid:{display:false}}}, onClick:(e,els,c)=>{ if(els.length){ const l=c.data.labels[els[0].index]; const s=document.getElementById('maint-car-select'); if([...s.options].some(o=>o.value===l)){ s.value=l; renderMaintenanceHistory(); } } }, onHover:(e,el)=>{e.native.target.style.cursor=el[0]?'pointer':'default';} } });
           } else {
               const monthSum = new Array(12).fill(0); data.forEach(r => { if(r.dateObj) monthSum[r.dateObj.getMonth()] += cleanNumber(r['ค่าใช้จ่าย']); });
               charts.maintCost = new Chart(ctx2, { type: 'bar', data: { labels: ["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."], datasets: [{ label: 'ค่าซ่อมรายเดือน', data: monthSum, backgroundColor: '#8b5cf6', borderRadius: 4 }] }, options: { responsive:true, maintainAspectRatio:false, scales:{x:{grid:{display:false}},y:{grid:{display:false}}} } });
           }

           const tbody = document.getElementById('maint-table-body'); tbody.innerHTML = '';
           data.sort((a,b) => (b.dateObj||0) - (a.dateObj||0)).slice(0, 50).forEach(r => {
               tbody.innerHTML += `<tr class="hover:bg-slate-50 dark:hover:bg-slate-700 border-b border-slate-100 dark:border-slate-700"><td class="px-4 py-3 font-mono text-slate-500">${r['วันที่']}</td><td class="px-4 py-3 font-bold text-slate-700 dark:text-slate-200">${r['ทะเบียนรถ']}</td><td class="px-4 py-3"><span class="px-2 py-1 bg-slate-100 dark:bg-slate-600 rounded text-xs">${r['ประเภทการซ่อม']}</span></td><td class="px-4 py-3 text-slate-600 dark:text-slate-300">${r['รายการซ่อม']}</td><td class="px-4 py-3 text-right font-bold text-slate-800 dark:text-white">฿${cleanNumber(r['ค่าใช้จ่าย']).toLocaleString()}</td><td class="px-4 py-3 text-xs text-slate-400">${r['ร้าน/ศูนย์บริการ']||'-'}</td></tr>`;
           });
       }

       // --- INSURANCE VIEW ---
       function initInsurance() {
           const select = document.getElementById('ins-car-select');
           [...new Set(rawData.ins.map(i => i['ทะเบียนรถ']))].forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.innerText = c; select.appendChild(opt); });
       }
       function renderInsuranceCompare() {
           const carId = document.getElementById('ins-car-select').value;
           const resArea = document.getElementById('ins-result-area');
           if (!carId) { resArea.classList.add('hidden'); return; }
           const deals = rawData.ins.filter(i => i['ทะเบียนรถ'] === carId);
           if (deals.length === 0) { resArea.classList.add('hidden'); return; }
           resArea.classList.remove('hidden');
           let best = null, max = -1;
           deals.forEach(d => { const s = cleanNumber(d['ค่าเบี้ยประกัน']) > 0 ? cleanNumber(d['ทุนประกัน']) / cleanNumber(d['ค่าเบี้ยประกัน']) : 0; d.score = s; if(s > max){ max = s; best = d; } });
           if(best) { document.getElementById('ins-best-provider').innerText = best['บริษัทประกัน (ที่เสนอราคา)']; document.getElementById('ins-best-price').innerText = '฿'+cleanNumber(best['ค่าเบี้ยประกัน']).toLocaleString(); document.getElementById('ins-best-cover').innerText = '฿'+cleanNumber(best['ทุนประกัน']).toLocaleString(); }
           const ctx = document.getElementById('insChart').getContext('2d');
           if(charts.ins) charts.ins.destroy();
           charts.ins = new Chart(ctx, { type: 'bar', data: { labels: deals.map(d=>d['บริษัทประกัน (ที่เสนอราคา)']), datasets: [{label:'เบี้ย', data:deals.map(d=>cleanNumber(d['ค่าเบี้ยประกัน'])), backgroundColor:'#f87171'}, {label:'ทุน', data:deals.map(d=>cleanNumber(d['ทุนประกัน'])), backgroundColor:'#34d399'}] }, options: { responsive:true, maintainAspectRatio:false, scales:{ x:{grid:{display:false}}, y:{grid:{display:false}} } } });
           const tbody = document.getElementById('ins-table-body'); tbody.innerHTML = '';
           deals.sort((a,b)=>b.score-a.score).forEach((d,i)=>{ tbody.innerHTML += `<tr class="${i===0?'bg-emerald-50 dark:bg-emerald-900/20':''} border-b border-slate-100 dark:border-slate-700"><td class="px-4 py-3 font-bold text-slate-700 dark:text-slate-200">${d['บริษัทประกัน (ที่เสนอราคา)']}</td><td class="px-4 py-3 text-right text-slate-600 dark:text-slate-300">${d['ทุนประกัน']}</td><td class="px-4 py-3 text-right font-bold text-slate-800 dark:text-white">${d['ค่าเบี้ยประกัน']}</td><td class="px-4 py-3 text-center">${i===0?'<span class="text-[10px] bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full">BEST</span>':d.score.toFixed(1)}</td></tr>`; });
       }

       // --- Helpers ---
       function setDeviceView(mode) { const w = document.getElementById('main-wrapper'); setActiveViewBtn(mode); if(mode==='mobile') w.className="max-w-[480px] mx-auto border-x border-slate-200 dark:border-slate-700 shadow-xl transition-all duration-300"; else if(mode==='tablet') w.className="max-w-[768px] mx-auto border-x border-slate-200 dark:border-slate-700 shadow-xl transition-all duration-300"; else w.className="w-full mx-auto transition-all duration-300"; }
       function setActiveViewBtn(mode) { ['mobile','tablet','desktop'].forEach(m => { document.getElementById('btn-view-'+m).className = (m===mode) ? "p-1.5 rounded bg-white dark:bg-slate-600 text-blue-600 dark:text-blue-400 shadow-sm transition-all" : "p-1.5 rounded text-slate-400 hover:text-blue-500 hover:bg-white dark:hover:bg-slate-600 transition-all"; }); }
       function switchTab(tab) { ['dashboard','maintenance','fuel','insurance'].forEach(t => { document.getElementById('view-'+t).classList.add('hidden'); document.getElementById('btn-'+t).className = "px-5 py-2 rounded-lg text-sm font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 transition-all flex items-center gap-2"; }); document.getElementById('view-'+tab).classList.remove('hidden'); document.getElementById('btn-'+tab).className = "px-5 py-2 rounded-lg text-sm font-bold bg-blue-600 text-white shadow-md transition-all flex items-center gap-2"; }
       function toggleDarkMode() { document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); initDashboard(); renderMaintenanceHistory(); renderFuelView(); }
       function cleanNumber(val) { return parseFloat(String(val).replace(/,/g, '')) || 0; }
       function parseDate(str) { if (!str) return null; if (str.includes('-')) { const p = str.split('-'); if (p[0].length === 4) return new Date(p[0], p[1] - 1, p[2]); } if (str.includes('/')) { const p = str.split('/'); return new Date(p[2], p[1]-1, p[0]); } return new Date(str); }
       function formatDate(date) { return date ? date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' }) : '-'; }
   </script>
</body>
</html>