<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>üöú FleetManager ‚Äî V3 (Analytics + Alerts)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-slate-100 text-slate-800">

<div class="max-w-7xl mx-auto p-3">

<header class="flex items-center justify-between mb-3">
  <h1 class="text-xl font-bold">üöú FleetManager <span class="text-sm text-gray-500">V3 ‚Äî Analytics + Alerts</span></h1>
  <button id="reloadBtn" class="px-3 py-1 rounded bg-blue-600 text-white">üîÑ Reload</button>
</header>

<!-- NAV -->
<nav class="grid grid-cols-6 gap-2 mb-3">
  <button class="tabBtn bg-blue-600 text-white rounded p-2" data-tab="dashboard">üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
  <button class="tabBtn bg-white rounded p-2" data-tab="machines">üöú ‡∏£‡∏ñ</button>
  <button class="tabBtn bg-white rounded p-2" data-tab="fuel">‚õΩ ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</button>
  <button class="tabBtn bg-white rounded p-2" data-tab="maintenance">üõ† ‡∏ã‡πà‡∏≠‡∏°</button>
  <button class="tabBtn bg-white rounded p-2" data-tab="location">üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</button>
  <button class="tabBtn bg-white rounded p-2" data-tab="insurance">üõ° ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</button>
</nav>

<!-- DASHBOARD -->
<section id="tab-dashboard" class="tab">
  <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3">
    <div class="bg-white p-3 rounded shadow">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î<div id="kpiTotal" class="text-xl font-bold">-</div></div>
    <div class="bg-white p-3 rounded shadow">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô<div id="kpiActive" class="text-xl font-bold">-</div></div>
    <div class="bg-white p-3 rounded shadow">‡∏ã‡πà‡∏≠‡∏°<div id="kpiRepair" class="text-xl font-bold">-</div></div>
    <div class="bg-white p-3 rounded shadow">Idle > 30 ‡∏ß‡∏±‡∏ô<div id="kpiIdleLong" class="text-xl font-bold text-red-600">-</div></div>
  </div>

  <div class="bg-yellow-100 border border-yellow-300 p-3 rounded mb-3">
    <div class="font-semibold mb-1">‚è∞ Alert ‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (30 ‡∏ß‡∏±‡∏ô)</div>
    <ul id="alertBox" class="text-sm list-disc ml-4"></ul>
  </div>

  <div class="grid md:grid-cols-2 gap-3">
    <div class="bg-white p-3 rounded shadow">
      <div class="font-semibold mb-1">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠ Drilldown)</div>
      <canvas id="fuelChart"></canvas>
    </div>
    <div class="bg-white p-3 rounded shadow">
      <div class="font-semibold mb-1">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ã‡πà‡∏≠‡∏° (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠ Drilldown)</div>
      <canvas id="maintChart"></canvas>
    </div>
  </div>
</section>

<!-- MACHINES -->
<section id="tab-machines" class="tab hidden">
  <div class="flex gap-2 mb-2">
    <select id="machineFilter" class="border p-1 rounded">
      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ --</option>
    </select>
    <button id="sortLatestBtn" class="px-3 py-1 bg-gray-200 rounded">‚è± ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
  </div>

  <div class="bg-white p-3 rounded shadow overflow-auto max-h-[65vh]">
    <table class="w-full text-sm border">
      <thead class="bg-slate-200 sticky top-0">
        <tr>
          <th class="p-1 border">‡∏£‡∏´‡∏±‡∏™</th>
          <th class="p-1 border">‡∏ä‡∏∑‡πà‡∏≠</th>
          <th class="p-1 border">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
          <th class="p-1 border">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th class="p-1 border">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
          <th class="p-1 border">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</th>
        </tr>
      </thead>
      <tbody id="machineTable"></tbody>
    </table>
  </div>
</section>

<!-- FUEL -->
<section id="tab-fuel" class="tab hidden">
  <div class="flex gap-2 mb-2">
    <input id="fuelYear" type="number" placeholder="‡∏õ‡∏µ" class="border p-1 rounded w-24" />
    <input id="fuelMonth" type="number" placeholder="‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" class="border p-1 rounded w-24" />
    <button id="fuelFilterBtn" class="px-3 py-1 bg-blue-600 text-white rounded">‡∏Å‡∏£‡∏≠‡∏á</button>
  </div>

  <div class="bg-white p-3 rounded shadow overflow-auto max-h-[65vh]">
    <table class="w-full text-sm border">
      <thead class="bg-slate-200 sticky top-0">
        <tr>
          <th class="p-1 border">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
          <th class="p-1 border">‡∏£‡∏´‡∏±‡∏™</th>
          <th class="p-1 border">‡∏•‡∏¥‡∏ï‡∏£</th>
          <th class="p-1 border">‡∏ö‡∏≤‡∏ó</th>
          <th class="p-1 border">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
        </tr>
      </thead>
      <tbody id="fuelTable"></tbody>
    </table>
  </div>
</section>

<!-- MAINT -->
<section id="tab-maintenance" class="tab hidden">
  <div class="flex gap-2 mb-2">
    <input id="maintYear" type="number" placeholder="‡∏õ‡∏µ" class="border p-1 rounded w-24" />
    <input id="maintMonth" type="number" placeholder="‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" class="border p-1 rounded w-24" />
    <button id="maintFilterBtn" class="px-3 py-1 bg-blue-600 text-white rounded">‡∏Å‡∏£‡∏≠‡∏á</button>
  </div>

  <div class="bg-white p-3 rounded shadow overflow-auto max-h-[65vh]">
    <table class="w-full text-sm border">
      <thead class="bg-slate-200 sticky top-0">
        <tr>
          <th class="p-1 border">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ã‡πà‡∏≠‡∏°</th>
          <th class="p-1 border">‡∏£‡∏´‡∏±‡∏™</th>
          <th class="p-1 border">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</th>
          <th class="p-1 border">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</th>
          <th class="p-1 border">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤</th>
        </tr>
      </thead>
      <tbody id="maintTable"></tbody>
    </table>
  </div>
</section>

<!-- LOCATION -->
<section id="tab-location" class="tab hidden">
  <div class="bg-white p-3 rounded shadow overflow-auto max-h-[70vh]">
    <table class="w-full text-sm border">
      <thead class="bg-slate-200 sticky top-0">
        <tr>
          <th class="p-1 border">‡∏£‡∏´‡∏±‡∏™</th>
          <th class="p-1 border">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
          <th class="p-1 border">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</th>
          <th class="p-1 border">‡πÄ‡∏Ç‡πâ‡∏≤</th>
          <th class="p-1 border">‡∏≠‡∏≠‡∏Å</th>
        </tr>
      </thead>
      <tbody id="locationTable"></tbody>
    </table>
  </div>
</section>

<!-- INSURANCE -->
<section id="tab-insurance" class="tab hidden">
  <div class="bg-white p-3 rounded shadow overflow-auto max-h-[70vh]">
    <table class="w-full text-sm border">
      <thead class="bg-slate-200 sticky top-0">
        <tr>
          <th class="p-1 border">‡∏£‡∏´‡∏±‡∏™</th>
          <th class="p-1 border">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th>
          <th class="p-1 border">‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</th>
          <th class="p-1 border">‡∏´‡∏°‡∏î‡∏†‡∏≤‡∏©‡∏µ</th>
        </tr>
      </thead>
      <tbody id="insuranceTable"></tbody>
    </table>
  </div>
</section>

</div>

<script>
const SHEETS = {
  machines: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQk9jak3sAnetueFVqbVYLXhHUYKFE7S7CxSZsEB_NQT_8vRyeN7j_B3OoIORlSPjRBLdDYU53k6fUl/pub?gid=2036292301&single=true&output=csv",
  fuel: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQk9jak3sAnetueFVqbVYLXhHUYKFE7S7CxSZsEB_NQT_8vRyeN7j_B3OoIORlSPjRBLdDYU53k6fUl/pub?gid=1215465404&single=true&output=csv",
  maintenance: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQk9jak3sAnetueFVqbVYLXhHUYKFE7S7CxSZsEB_NQT_8vRyeN7j_B3OoIORlSPjRBLdDYU53k6fUl/pub?gid=513299430&single=true&output=csv",
  location: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQk9jak3sAnetueFVqbVYLXhHUYKFE7S7CxSZsEB_NQT_8vRyeN7j_B3OoIORlSPjRBLdDYU53k6fUl/pub?gid=613103968&single=true&output=csv",
  insurance: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQk9jak3sAnetueFVqbVYLXhHUYKFE7S7CxSZsEB_NQT_8vRyeN7j_B3OoIORlSPjRBLdDYU53k6fUl/pub?gid=1698787286&single=true&output=csv"
};

const dataStore = { machines:[], fuel:[], maintenance:[], location:[], insurance:[] };
let fuelChart, maintChart;

function loadCSV(url) {
  return new Promise(resolve => {
    Papa.parse(url, { download:true, header:true, skipEmptyLines:true, transformHeader:h=>(h||'').trim(), complete:r=>resolve(r.data) });
  });
}

async function loadData() {
  const [m,f,ma,l,i] = await Promise.all([
    loadCSV(SHEETS.machines), loadCSV(SHEETS.fuel), loadCSV(SHEETS.maintenance), loadCSV(SHEETS.location), loadCSV(SHEETS.insurance)
  ]);

  Object.assign(dataStore,{ machines:m, fuel:f, maintenance:ma, location:l, insurance:i });
  buildMachineFilter();
  renderAll();
}

function renderAll(){
  renderKPI();
  renderAlerts();
  renderMachineTable();
  renderFuelTable();
  renderMaintTable();
  renderLocation();
  renderInsurance();
  renderFuelChart();
  renderMaintChart();
}

// KPI + Idle >30d
function renderKPI(){
  const total = dataStore.machines.length;
  const active = dataStore.machines.filter(m=>m['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞']==='‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô').length;
  const repair = dataStore.machines.filter(m=>m['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞']==='‡∏ã‡πà‡∏≠‡∏°').length;

  const today = new Date();
  const idleLong = dataStore.location.filter(r=>!r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å']).filter(r=>{
    const d = new Date(r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤']);
    return (today-d)/86400000 > 30;
  }).length;

  kpiTotal.innerText = total;
  kpiActive.innerText = active;
  kpiRepair.innerText = repair;
  kpiIdleLong.innerText = idleLong;
}

// Alerts Insurance
function renderAlerts(){
  alertBox.innerHTML='';
  const today = new Date();
  dataStore.insurance.forEach(r=>{
    const exp = new Date(r['‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô']);
    const diff = (exp-today)/86400000;
    if(diff>0 && diff<30){
      const li = document.createElement('li');
      li.textContent = `${r['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á']} ‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÉ‡∏ô ${Math.ceil(diff)} ‡∏ß‡∏±‡∏ô`;
      alertBox.appendChild(li);
    }
  });
}

// Machines
function buildMachineFilter(){
  machineFilter.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ --</option>';
  dataStore.machines.forEach(m=>{
    const op=document.createElement('option');
    op.value=m['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á'];
    op.textContent=m['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á'];
    machineFilter.appendChild(op);
  });
}

function renderMachineTable(){
  machineTable.innerHTML='';
  let rows = dataStore.machines;
  if(machineFilter.value) rows = rows.filter(r=>r['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á']===machineFilter.value);

  rows.forEach(m=>{
    machineTable.innerHTML += `<tr>
      <td class='border p-1'>${m['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á']}</td>
      <td class='border p-1'>${m['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á']}</td>
      <td class='border p-1'>${m['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó']}</td>
      <td class='border p-1'>${m['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞']}</td>
      <td class='border p-1'>${m['‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô']}</td>
      <td class='border p-1 text-right'>${m['‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô']}</td>
    </tr>`;
  });
}

sortLatestBtn.onclick = ()=>{
  dataStore.machines.sort((a,b)=>Number(b['‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô']||0)-Number(a['‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô']||0));
  renderMachineTable();
};

machineFilter.onchange = renderMachineTable;

// Fuel
function renderFuelTable(){
  fuelTable.innerHTML='';
  let rows = dataStore.fuel;
  if(fuelYear.value) rows = rows.filter(r=>r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']?.startsWith(fuelYear.value));
  if(fuelMonth.value) rows = rows.filter(r=>r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']?.slice(5,7)===fuelMonth.value.padStart(2,'0'));

  rows.slice(-300).forEach(r=>{
    fuelTable.innerHTML += `<tr>
      <td class='border p-1'>${r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']}</td>
      <td class='border p-1'>${r['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á']}</td>
      <td class='border p-1 text-right'>${r['‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì(‡∏•‡∏¥‡∏ï‡∏£)']}</td>
      <td class='border p-1 text-right'>${r['‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢(‡∏ö‡∏≤‡∏ó)']}</td>
      <td class='border p-1'>${r['‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà']}</td>
    </tr>`;
  });
}

fuelFilterBtn.onclick = renderFuelTable;

// Maintenance
function renderMaintTable(){
  maintTable.innerHTML='';
  let rows = dataStore.maintenance;
  if(maintYear.value) rows = rows.filter(r=>r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ã‡πà‡∏≠‡∏°']?.startsWith(maintYear.value));
  if(maintMonth.value) rows = rows.filter(r=>r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ã‡πà‡∏≠‡∏°']?.slice(5,7)===maintMonth.value.padStart(2,'0'));

  rows.slice(-300).forEach(r=>{
    maintTable.innerHTML += `<tr>
      <td class='border p-1'>${r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ã‡πà‡∏≠‡∏°']}</td>
      <td class='border p-1'>${r['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á']}</td>
      <td class='border p-1'>${r['‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢']}</td>
      <td class='border p-1 text-right'>${r['‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢(‡∏ö‡∏≤‡∏ó)']}</td>
      <td class='border p-1'>${r['‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤']}</td>
    </tr>`;
  });
}

maintFilterBtn.onclick = renderMaintTable;

// Location
function renderLocation(){
  locationTable.innerHTML='';
  dataStore.location.slice(-500).forEach(r=>{
    locationTable.innerHTML += `<tr>
      <td class='border p-1'>${r['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á']}</td>
      <td class='border p-1'>${r['‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà']}</td>
      <td class='border p-1'>${r['‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£']}</td>
      <td class='border p-1'>${r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤']}</td>
      <td class='border p-1'>${r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å']||'-'}</td>
    </tr>`;
  });
}

// Insurance
function renderInsurance(){
  insuranceTable.innerHTML='';
  dataStore.insurance.forEach(r=>{
    insuranceTable.innerHTML += `<tr>
      <td class='border p-1'>${r['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á']}</td>
      <td class='border p-1'>${r['‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô']}</td>
      <td class='border p-1'>${r['‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô']}</td>
      <td class='border p-1'>${r['‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏†‡∏≤‡∏©‡∏µ']}</td>
    </tr>`;
  });
}

// Charts + Drilldown
function renderFuelChart(){
  const monthly={};
  dataStore.fuel.forEach(f=>{
    if(!f['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'])return;
    const m=f['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'].slice(0,7);
    monthly[m]=(monthly[m]||0)+Number(f['‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢(‡∏ö‡∏≤‡∏ó)']||0);
  });
  const labels=Object.keys(monthly).sort();
  const values=labels.map(k=>monthly[k]);
  if(fuelChart)fuelChart.destroy();
  fuelChart=new Chart(fuelChartCanvas,{
    type:'bar',
    data:{labels,datasets:[{label:'‡∏ö‡∏≤‡∏ó',data:values}]},
    options:{onClick:(e,els)=>{
      if(!els.length)return;
      const month=labels[els[0].index];
      fuelYear.value = month.slice(0,4);
      fuelMonth.value = month.slice(5,7);
      renderFuelTable();
      switchTab('fuel');
    }}
  });
}

function renderMaintChart(){
  const monthly={};
  dataStore.maintenance.forEach(f=>{
    if(!f['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ã‡πà‡∏≠‡∏°'])return;
    const m=f['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ã‡πà‡∏≠‡∏°'].slice(0,7);
    monthly[m]=(monthly[m]||0)+Number(f['‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢(‡∏ö‡∏≤‡∏ó)']||0);
  });
  const labels=Object.keys(monthly).sort();
  const values=labels.map(k=>monthly[k]);
  if(maintChart)maintChart.destroy();
  maintChart=new Chart(maintChartCanvas,{
    type:'bar',
    data:{labels,datasets:[{label:'‡∏ö‡∏≤‡∏ó',data:values}]},
    options:{onClick:(e,els)=>{
      if(!els.length)return;
      const month=labels[els[0].index];
      maintYear.value = month.slice(0,4);
      maintMonth.value = month.slice(5,7);
      renderMaintTable();
      switchTab('maintenance');
    }}
  });
}

// Navigation
const tabs=document.querySelectorAll('.tab');
function switchTab(name){
  document.querySelectorAll('.tabBtn').forEach(b=>b.classList.replace('bg-blue-600','bg-white'));
  document.querySelector(`[data-tab=${name}]`).classList.replace('bg-white','bg-blue-600');
  tabs.forEach(t=>t.classList.add('hidden'));
  document.getElementById('tab-'+name).classList.remove('hidden');
}

document.querySelectorAll('.tabBtn').forEach(btn=>{
  btn.onclick=()=>switchTab(btn.dataset.tab);
});

reloadBtn.onclick = loadData;

const fuelChartCanvas=document.getElementById('fuelChart');
const maintChartCanvas=document.getElementById('maintChart');

loadData();
</script>
</body>
</html>
