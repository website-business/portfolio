<!DOCTYPE html>
<html lang="th" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบควบคุมไซต์งานเครื่องจักรกลหนัก</title>
    
    <!-- CSS Framework: Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart Library: Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- CSV Parser: PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <!-- Icons: FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Saira+Stencil+One&family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- Theme Variables --- */
        :root {
            --bg-body: #0f172a;
            --bg-card: linear-gradient(145deg, #1e293b, #0f172a);
            --bg-panel: #1e293b;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --safety-yellow: #fbbf24;
            --safety-orange: #f97316;
            --hazard-stripe-1: #111;
            --hazard-stripe-2: #fbbf24;
            --chart-grid: rgba(255,255,255,0.1);
            --chart-text: #94a3b8;
            
            --status-blue: #3b82f6;
            --status-red: #ef4444;
            --status-yellow: #d4ac0d;
            --status-green: #22c55e;
            --status-purple: #a855f7;
            --status-orange: #f97316;
        }

        [data-theme="light"] {
            --bg-body: #f1f5f9;
            --bg-card: linear-gradient(145deg, #ffffff, #f8fafc);
            --bg-panel: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #cbd5e1;
            --safety-yellow: #d97706;
            --safety-orange: #ea580c;
            --hazard-stripe-1: #e2e8f0;
            --hazard-stripe-2: #fbbf24;
            --chart-grid: rgba(0,0,0,0.1);
            --chart-text: #475569;

            --status-blue: #2563eb;
            --status-red: #dc2626;
            --status-green: #16a34a;
            --status-purple: #9333ea;
            --status-orange: #ea580c;
        }

        body {
            font-family: 'Prompt', sans-serif;
            background-color: var(--bg-body);
            background-image: 
                linear-gradient(rgba(100, 116, 139, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(100, 116, 139, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text-main);
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        h1, h2, h3, .stat-value, .brand-font {
            font-family: 'Saira Stencil One', cursive;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .hazard-stripe {
            background: repeating-linear-gradient(
                45deg,
                var(--hazard-stripe-1),
                var(--hazard-stripe-1) 10px,
                var(--hazard-stripe-2) 10px,
                var(--hazard-stripe-2) 20px
            );
            border-bottom: 4px solid var(--border-color);
        }

        .industrial-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            position: relative;
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%);
            box-shadow: 4px 4px 0px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }

        .industrial-card::after {
            content: '';
            position: absolute;
            bottom: 0; right: 0;
            width: 15px; height: 15px;
            background: var(--safety-yellow);
            clip-path: polygon(0 100%, 100% 0, 100% 100%);
        }

        .card-interactive:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0px rgba(0,0,0,0.3);
            border-color: var(--safety-yellow);
        }
        
        .card-interactive:active {
            transform: translate(0, 0);
            box-shadow: 2px 2px 0px rgba(0,0,0,0.4);
        }

        .status-blue { border-left: 4px solid var(--status-blue); }
        .status-red { border-left: 4px solid var(--status-red); }
        .status-yellow { border-left: 4px solid #eab308; }
        .status-green { border-left: 4px solid #16a34a; }
        .status-purple { border-left: 4px solid var(--status-purple); }
        .status-orange { border-left: 4px solid var(--status-orange); }

        .card-selected {
            background: var(--bg-panel);
            border: 2px solid var(--safety-yellow);
        }
        .card-selected::before {
            content: 'เลือกแล้ว';
            position: absolute;
            top: 0; right: 0;
            background: var(--safety-yellow);
            color: white;
            font-size: 9px;
            font-weight: bold;
            padding: 2px 6px;
            font-family: 'Prompt', sans-serif;
        }

        .construct-btn {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            font-family: 'Prompt', sans-serif;
            font-weight: 600;
            padding: 4px 12px;
            transition: all 0.2s;
            font-size: 0.85rem;
            cursor: pointer;
        }
        .construct-btn:hover { background: var(--border-color); color: var(--text-main); }
        .construct-btn.active { background: var(--safety-yellow); color: white; border-color: var(--safety-orange); }
        
        .toggle-btn { @apply construct-btn; }

        .loading-overlay {
            position: fixed; inset: 0; background: var(--bg-body); z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .loader-gear {
            font-size: 60px; color: var(--safety-yellow);
            animation: spin-gear 4s infinite linear;
        }
        @keyframes spin-gear { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Modal Transitions */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            backdrop-filter: blur(2px);
            display: none; justify-content: center; align-items: center; z-index: 100;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .modal-overlay.show { display: flex; opacity: 1; }
        .modal-content {
            background: var(--bg-panel);
            border: 2px solid var(--safety-yellow);
            width: 95%; max-width: 800px; max-height: 90vh; 
            display: flex; flex-direction: column;
            transform: scale(0.95); transition: transform 0.3s;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            color: var(--text-main);
        }
        .modal-overlay.show .modal-content { transform: scale(1); }

        .blueprint-container {
            background-color: var(--bg-panel);
            border: 1px solid var(--border-color);
            position: relative;
        }

        .theme-toggle {
            cursor: pointer; padding: 4px; border-radius: 9999px;
            background-color: var(--border-color); position: relative;
            width: 48px; height: 24px; transition: background-color 0.3s;
        }
        .theme-toggle-circle {
            width: 16px; height: 16px; background-color: white;
            border-radius: 50%; position: absolute; top: 4px; left: 4px;
            transition: transform 0.3s;
        }
        [data-theme="light"] .theme-toggle-circle { transform: translateX(24px); }

    </style>
</head>
<body class="antialiased text-sm">

    <!-- Loading Screen -->
    <div id="loading" class="loading-overlay">
        <i class="fas fa-cog loader-gear mb-4"></i>
        <div class="text-xl font-bold text-[var(--safety-yellow)] tracking-widest font-[Black Ops One]">กำลังโหลดข้อมูล...</div>
        <div class="text-[var(--text-muted)] font-mono mt-1 text-xs">เชื่อมต่อฐานข้อมูลเครื่องจักร...</div>
    </div>

    <!-- Modal Popup -->
    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <div class="bg-[var(--safety-yellow)] text-white px-4 py-3 flex justify-between items-center">
                <h3 class="text-lg font-bold flex items-center gap-2">
                    <i class="fas fa-clipboard-list"></i> <span id="modal-title">รายงาน</span>
                </h3>
                <button onclick="closeModal()" class="text-white hover:text-black transition">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            
            <!-- Search & Filter Bar -->
            <div id="modal-filter-bar" class="px-4 py-3 bg-[var(--bg-body)] border-b border-[var(--border-color)] hidden">
                <div class="flex flex-col sm:flex-row gap-3">
                    <div class="relative flex-grow">
                        <i class="fas fa-search absolute left-3 top-2.5 text-[var(--text-muted)]"></i>
                        <input type="text" id="machine-search" oninput="filterModalList()" placeholder="พิมพ์ค้นหา รหัส หรือ ทะเบียน..." 
                            class="w-full bg-[var(--bg-panel)] border border-[var(--border-color)] text-[var(--text-main)] pl-9 pr-3 py-2 rounded focus:outline-none focus:border-[var(--safety-yellow)] text-sm">
                    </div>
                    <div class="relative min-w-[150px]">
                        <select id="machine-type-filter" onchange="filterModalList()" class="w-full appearance-none bg-[var(--bg-panel)] border border-[var(--border-color)] text-[var(--text-main)] pl-3 pr-8 py-2 rounded focus:outline-none focus:border-[var(--safety-yellow)] text-sm cursor-pointer">
                            <option value="">ทั้งหมด (ทุกประเภท)</option>
                        </select>
                        <i class="fas fa-filter absolute right-3 top-2.5 text-[var(--text-muted)] pointer-events-none"></i>
                    </div>
                </div>
            </div>

            <div class="p-4 overflow-y-auto bg-[var(--bg-body)]" style="min-height: 200px;" id="modal-body-container">
                <div id="modal-body" class="space-y-2"></div>
            </div>
            <div class="px-4 py-3 bg-[var(--bg-panel)] border-t border-[var(--border-color)] text-right">
                <button onclick="closeModal()" class="construct-btn px-4">ปิดหน้าต่าง</button>
            </div>
        </div>
    </div>

    <!-- Top Hazard Bar -->
    <div class="h-1.5 w-full hazard-stripe fixed top-0 z-50"></div>

    <!-- Main Content -->
    <div class="container mx-auto px-2 sm:px-4 py-6 mt-4 max-w-[1600px]">
        
        <!-- Header Section -->
        <header class="mb-6 pb-4 border-b border-[var(--border-color)] flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4 w-full md:w-auto">
                <div class="w-12 h-12 bg-[var(--safety-yellow)] flex items-center justify-center rounded shadow-lg text-white">
                    <i class="fas fa-hard-hat text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-black text-[var(--text-main)] uppercase leading-none">
                        ระบบจัดการ<span class="text-[var(--safety-yellow)]">เครื่องจักร</span>
                    </h1>
                    <p class="text-[var(--text-muted)] text-xs mt-1 font-mono">
                        หน่วยควบคุมไซต์งาน: อัลฟ่า (Alpha)
                    </p>
                </div>
            </div>
            
            <div class="flex items-center gap-4 self-end md:self-center">
                <!-- Theme Toggle -->
                <div class="flex items-center gap-2">
                    <i class="fas fa-moon text-[var(--text-muted)] text-xs"></i>
                    <div class="theme-toggle" onclick="toggleTheme()">
                        <div class="theme-toggle-circle"></div>
                    </div>
                    <i class="fas fa-sun text-[var(--text-muted)] text-xs"></i>
                </div>

                <div class="bg-[var(--bg-panel)] border border-[var(--border-color)] px-3 py-1.5 rounded flex items-center gap-2 shadow-sm">
                    <i class="fas fa-calendar-alt text-[var(--text-muted)]"></i>
                    <div class="text-right">
                        <div class="text-[9px] text-[var(--text-muted)] font-mono leading-none">วันที่ข้อมูล</div>
                        <div class="text-sm font-bold text-[var(--safety-yellow)] font-mono leading-none" id="current-date">--/--/----</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Stats Overview Grid -->
        <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-6 gap-3 mb-6">
            <div class="industrial-card card-interactive status-blue p-3 cursor-pointer" onclick="openModal('all')">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="text-[var(--text-muted)] text-[10px] font-bold tracking-wider mb-1">เครื่องจักรทั้งหมด</div>
                        <div class="text-2xl font-black text-[var(--text-main)] stat-value" id="total-machines">-</div>
                    </div>
                    <i class="fas fa-truck-monster text-[var(--status-blue)] opacity-50 text-xl"></i>
                </div>
            </div>
            <div class="industrial-card card-interactive status-red p-3 cursor-pointer" onclick="openModal('expired')">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="text-[var(--status-red)] text-[10px] font-bold tracking-wider mb-1 flex items-center gap-1">
                            <i class="fas fa-exclamation-circle animate-pulse"></i> ทะเบียนขาด
                        </div>
                        <div class="text-2xl font-black text-[var(--status-red)] stat-value" id="total-expired">-</div>
                    </div>
                </div>
            </div>
            <div class="industrial-card card-interactive status-yellow p-3 cursor-pointer" onclick="openModal('warning')">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="text-[var(--safety-yellow)] text-[10px] font-bold tracking-wider mb-1">ใกล้หมด (30 วัน)</div>
                        <div class="text-2xl font-black text-[var(--safety-yellow)] stat-value" id="total-warning">-</div>
                    </div>
                    <i class="fas fa-bell text-[var(--safety-yellow)] opacity-50 text-xl"></i>
                </div>
            </div>
            
            <!-- Fuel Card -->
            <div id="card-fuel" class="industrial-card card-interactive status-green p-3 cursor-pointer card-selected" onclick="switchGraphMode('fuel')">
                <div class="flex justify-between items-start">
                    <div class="overflow-hidden">
                        <div class="text-[var(--status-green)] text-[10px] font-bold tracking-wider mb-1" id="label-total-fuel">ข้อมูลน้ำมัน</div>
                        <div class="text-2xl font-black text-[var(--text-main)] stat-value truncate" id="total-fuel">- ลิตร</div>
                    </div>
                    <i class="fas fa-gas-pump text-[var(--status-green)] opacity-50 text-xl"></i>
                </div>
            </div>

            <!-- Maintenance Card -->
            <div id="card-maintenance" class="industrial-card card-interactive status-purple p-3 cursor-pointer" onclick="switchGraphMode('maintenance')">
                <div class="flex justify-between items-start">
                    <div class="overflow-hidden">
                        <div class="text-[var(--status-purple)] text-[10px] font-bold tracking-wider mb-1">ค่าซ่อมบำรุง</div>
                        <div class="text-2xl font-black text-[var(--text-main)] stat-value truncate" id="total-maintenance">...</div>
                    </div>
                    <i class="fas fa-wrench text-[var(--status-purple)] opacity-50 text-xl"></i>
                </div>
            </div>

            <!-- New: Project Card -->
            <div id="card-project" class="industrial-card card-interactive status-orange p-3 cursor-pointer" onclick="switchGraphMode('project')">
                <div class="flex justify-between items-start">
                    <div class="overflow-hidden">
                        <div class="text-[var(--safety-orange)] text-[10px] font-bold tracking-wider mb-1">สรุปโครงการ</div>
                        <div class="text-2xl font-black text-[var(--text-main)] stat-value" id="total-projects">-</div>
                    </div>
                    <i class="fas fa-building text-[var(--safety-orange)] opacity-50 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Main Chart Section -->
        <div class="blueprint-container p-4 rounded-lg shadow-md min-h-[450px] flex flex-col">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-end mb-4 gap-3 border-b border-[var(--border-color)] pb-3">
                <div>
                    <div class="text-[var(--status-blue)] font-mono text-[10px] tracking-widest mb-0.5">// การแสดงผลข้อมูลกราฟ</div>
                    <h2 class="text-xl font-bold text-[var(--text-main)] flex items-center gap-2">
                        <i class="fas fa-chart-bar text-[var(--safety-yellow)]" id="chart-icon"></i>
                        <span id="chart-title">สถิติน้ำมันเชื้อเพลิง</span>
                    </h2>
                    <div id="chart-breadcrumb" class="text-xs text-[var(--text-muted)] mt-1 font-mono flex items-center gap-2 bg-[var(--bg-body)] px-2 py-0.5 rounded border border-[var(--border-color)] inline-flex">
                        <span class="w-1.5 h-1.5 bg-[var(--safety-yellow)] rounded-full animate-pulse inline-block"></span>
                        พร้อมทำงาน
                    </div>
                </div>
                
                <div class="flex flex-wrap items-center gap-2 w-full sm:w-auto">
                    <!-- Standard Toggles (Fuel/Maint) -->
                    <div id="view-toggles" class="bg-[var(--bg-body)] p-0.5 border border-[var(--border-color)] rounded flex gap-0.5">
                        <button class="construct-btn toggle-btn text-xs active" id="btn-trend" data-view="trend">แนวโน้ม</button>
                        <button class="construct-btn toggle-btn text-xs" id="btn-top10" data-view="top10">10 อันดับ</button>
                    </div>

                    <!-- Project Toggles (Hidden by default) -->
                    <div id="project-toggles" class="bg-[var(--bg-body)] p-0.5 border border-[var(--border-color)] rounded flex gap-0.5 hidden">
                        <button class="construct-btn toggle-btn text-xs active" id="btn-proj-fuel" data-view="fuel">ปริมาณน้ำมัน</button>
                        <button class="construct-btn toggle-btn text-xs" id="btn-proj-cost" data-view="cost">ค่าซ่อมบำรุง</button>
                    </div>
                    
                    <button id="chart-home-btn" class="hidden construct-btn" title="หน้าแรก"><i class="fas fa-home"></i></button>
                    <button id="chart-back-btn" class="hidden construct-btn" title="ย้อนกลับ"><i class="fas fa-undo"></i> ย้อนกลับ</button>
                    
                    <div class="relative group w-full sm:w-auto" id="machine-select-container">
                        <select id="machine-select" class="appearance-none bg-[var(--bg-body)] border border-[var(--border-color)] text-[var(--text-main)] py-1.5 px-3 pr-8 rounded font-mono text-xs focus:outline-none focus:border-[var(--safety-yellow)] w-full sm:w-48 cursor-pointer">
                            <option value="ALL">>> เครื่องจักรทั้งหมด</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-[var(--text-muted)]">
                            <i class="fas fa-chevron-down text-[10px]"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="relative flex-grow w-full min-h-[350px]">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script>
        // --- Configuration ---
        Chart.defaults.font.family = "'Prompt', sans-serif";
        Chart.defaults.font.size = 11;
        Chart.defaults.responsive = true;
        Chart.defaults.maintainAspectRatio = false;

        const SHEET_URLS = {
            machines: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRLxlqlfXntTk-z4x45kGjZ1OjHFnpCeaqjGZGpkfohr3difiJQsI-p-3iZwgyM7UO35kRztltMKgbd/pub?gid=0&single=true&output=csv',
            fuel: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRLxlqlfXntTk-z4x45kGjZ1OjHFnpCeaqjGZGpkfohr3difiJQsI-p-3iZwgyM7UO35kRztltMKgbd/pub?gid=700157187&single=true&output=csv',
            maintenance: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRLxlqlfXntTk-z4x45kGjZ1OjHFnpCeaqjGZGpkfohr3difiJQsI-p-3iZwgyM7UO35kRztltMKgbd/pub?gid=1964968763&single=true&output=csv'
        };

        let appData = { machines: [], fuel: [], maintenance: [], alerts: { expired: [], warning: [], all: [] } };
        let currentGraphMode = 'fuel'; // 'fuel', 'maintenance', 'project'
        let chartState = { instance: null, view: 'year', subView: 'trend', selectedMachine: 'ALL', selectedYear: null, selectedMonth: null, selectedDay: null };
        let lastModalType = 'all'; 
        
        let modalFuelChartInstance = null;
        let modalMaintChartInstance = null;
        let modalChartState = { view: 'year', year: null, month: null, machineCode: null }; 

        // --- Helpers ---
        function parseDate(dateStr) {
            if (!dateStr) return null;
            let d = new Date(dateStr);
            if (!isNaN(d.getTime())) {
                 if (d.getFullYear() > 2400) { d.setFullYear(d.getFullYear() - 543); }
                 return d;
            }
            if (dateStr.includes('/')) {
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    let day = parseInt(parts[0]);
                    let month = parseInt(parts[1]) - 1; 
                    let year = parseInt(parts[2]);
                    if (year > 2400) year -= 543;
                    const d2 = new Date(year, month, day);
                    if (!isNaN(d2.getTime())) return d2;
                }
            }
            return null;
        }
        function formatDateTH(date) { return date ? date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' }) : '-'; }
        function formatNumber(num) { return num.toLocaleString('th-TH', { maximumFractionDigits: 0 }); }
        function getCssVar(name) { return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

        // --- Theme ---
        function toggleTheme() {
            const html = document.documentElement;
            const newTheme = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('site_theme', newTheme);
            updateChartColors();
        }
        (function() { document.documentElement.setAttribute('data-theme', localStorage.getItem('site_theme') || 'dark'); })();

        function updateChartColors() {
            Chart.defaults.color = getCssVar('--chart-text');
            Chart.defaults.borderColor = getCssVar('--chart-grid');
            if(currentGraphMode === 'project') renderProjectChart();
            else if(currentGraphMode === 'fuel') updateChart();
            else renderMaintenanceChart();
            
            if(document.getElementById('modal').classList.contains('show') && modalChartState.machineCode) {
                updateModalCharts();
            }
        }

        // --- App Init ---
        async function loadData() {
            const fetchTimeout = new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 3000));
            try {
                const [machinesRes, fuelRes, maintRes] = await Promise.race([
                    Promise.all([
                        fetch(SHEET_URLS.machines).then(r => { if (!r.ok) throw new Error("Net"); return r.text(); }),
                        fetch(SHEET_URLS.fuel).then(r => { if (!r.ok) throw new Error("Net"); return r.text(); }),
                        fetch(SHEET_URLS.maintenance).then(r => { if (!r.ok) return ""; return r.text(); }).catch(() => "") 
                    ]),
                    fetchTimeout
                ]);
                
                appData.machines = cleanCSV(Papa.parse(machinesRes, { header: true, skipEmptyLines: true }).data);
                appData.fuel = cleanCSV(Papa.parse(fuelRes, { header: true, skipEmptyLines: true }).data);
                if (maintRes) {
                    const parsedMaint = Papa.parse(maintRes, { header: true, skipEmptyLines: true }).data;
                    appData.maintenance = cleanCSV(parsedMaint);
                    // Normalize 'ค่าใช้จ่าย' to 'ค่าซ่อมบำรุง'
                    appData.maintenance.forEach(row => {
                        if (row['ค่าใช้จ่าย'] && !row['ค่าซ่อมบำรุง']) { row['ค่าซ่อมบำรุง'] = row['ค่าใช้จ่าย']; }
                    });
                }

                if(!appData.machines.length || !appData.fuel.length) throw new Error("Empty Data");
                if (!appData.maintenance.length) generateMockMaintenanceData(); 

                finalizeLoad();
            } catch (error) {
                console.warn("Loading Failed. Using Mock Data.", error);
                loadMockData(); 
            }
        }

        function cleanCSV(data) {
            if (!data || data.length === 0) return [];
            return data.map(row => {
                const newRow = {};
                Object.keys(row).forEach(key => {
                    const cleanKey = key.trim();
                    newRow[cleanKey] = row[key] ? row[key].trim() : "";
                });
                return newRow;
            });
        }

        function generateMockMaintenanceData() {
             appData.maintenance = [];
             const machines = appData.machines.map(m => m['รหัส']).filter(c => c);
             if(machines.length === 0) return;
             const start = new Date(); start.setFullYear(start.getFullYear() - 1);
             const end = new Date();
             for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                if (Math.random() > 0.95) {
                    const m = machines[Math.floor(Math.random() * machines.length)];
                    appData.maintenance.push({
                        'วันที่': `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`,
                        'รหัสรถ': m,
                        'ค่าซ่อมบำรุง': Math.floor(Math.random() * 5000) + 1000,
                        'โครงการ': Math.random() > 0.5 ? 'Project A' : 'Project B'
                    });
                }
             }
        }

        function loadMockData() {
            appData.machines = [
                { 'รหัส': 'S-A02', 'ทะเบียน': 'กข-1234', 'ประเภทรถ': 'รถเกรด', 'ยี่ห้อรถ': 'CAT' },
                { 'รหัส': 'X-B05', 'ทะเบียน': 'ฮฮ-5555', 'ประเภทรถ': 'รถตัก', 'ยี่ห้อรถ': 'KOMATSU' }
            ];
            appData.fuel = []; appData.maintenance = [];
            finalizeLoad();
        }

        function finalizeLoad() {
            appData.fuel.sort((a, b) => { const da = parseDate(a['วันที่']); const db = parseDate(b['วันที่']); return (da && db) ? da - db : 0; });
            appData.maintenance.sort((a, b) => { const da = parseDate(a['วันที่']); const db = parseDate(b['วันที่']); return (da && db) ? da - db : 0; });
            initializeApp();
        }

        function updateMaintenanceStats() {
             let totalCost = 0;
             appData.maintenance.forEach(item => { totalCost += parseFloat(item['ค่าซ่อมบำรุง']) || 0; });
             document.getElementById('total-maintenance').innerText = formatNumber(totalCost) + " บาท";
             
             // Count Projects
             const projects = new Set();
             appData.fuel.forEach(f => { if(f['โครงการ']) projects.add(f['โครงการ']); });
             appData.maintenance.forEach(m => { if(m['โครงการ']) projects.add(m['โครงการ']); });
             document.getElementById('total-projects').innerText = projects.size + " โครงการ";
        }

        function initializeApp() {
            document.getElementById('current-date').innerText = new Date().toLocaleDateString('th-TH');
            document.getElementById('total-machines').innerText = appData.machines.length;
            
            updateMaintenanceStats();
            updateChartColors();
            processAlerts();
            setupFuelChart();
            document.getElementById('loading').style.opacity = '0';
            setTimeout(() => document.getElementById('loading').style.display = 'none', 500);
        }

        function processAlerts() {
            const today = new Date(); today.setHours(0,0,0,0);
            appData.alerts.all = []; appData.alerts.expired = []; appData.alerts.warning = [];
            const machineMap = new Map();
            appData.machines.forEach(machine => {
                const code = machine['รหัส']; if (!code) return;
                if(!machineMap.has(code)) { machineMap.set(code, { info: machine, expiredIssues: [], warningIssues: [] }); }
                const entry = machineMap.get(code);
                const checks = [
                    { key: 'วันที่ทะเบียนขาด', label: 'License', date: parseDate(machine['วันที่ทะเบียนขาด']) },
                    { key: 'วันที่ประกัน+พรบ.ขาด', label: 'Insurance', date: parseDate(machine['วันที่ประกัน+พรบ.ขาด']) }
                ];
                checks.forEach(check => {
                    if (!check.date) return;
                    const diffDays = Math.ceil((check.date - today) / (1000 * 60 * 60 * 24));
                    const issueText = `${check.label}: ${formatDateTH(check.date)} (${diffDays <= 0 ? 'Expired' : diffDays + ' Days'})`;
                    if (diffDays <= 0) entry.expiredIssues.push(issueText);
                    else if (diffDays <= 30) entry.warningIssues.push(issueText);
                });
            });
            machineMap.forEach(data => {
                appData.alerts.all.push(data);
                if (data.expiredIssues.length > 0) appData.alerts.expired.push(data);
                if (data.warningIssues.length > 0) appData.alerts.warning.push(data);
            });
            document.getElementById('total-expired').innerText = appData.alerts.expired.length;
            document.getElementById('total-warning').innerText = appData.alerts.warning.length;
        }

        // --- Modal Logic ---
        function openModal(type) {
            lastModalType = type;
            const modal = document.getElementById('modal'), title = document.getElementById('modal-title'), body = document.getElementById('modal-body');
            body.innerHTML = '';
            let dataList = [], headerText = '', emptyText = '';
            if (type === 'all') { headerText = 'บัญชีเครื่องจักรทั้งหมด'; dataList = appData.alerts.all; emptyText = 'ไม่พบข้อมูล'; }
            else if (type === 'expired') { headerText = 'รายการแจ้งเตือนวิกฤต (หมดอายุ)'; dataList = appData.alerts.expired; emptyText = 'ไม่มีรายการหมดอายุ'; }
            else if (type === 'warning') { headerText = 'คาดการณ์ซ่อมบำรุง (30 วัน)'; dataList = appData.alerts.warning; emptyText = 'ไม่มีการแจ้งเตือน'; }
            title.innerText = headerText;
            
            const filterBar = document.getElementById('modal-filter-bar');
            if (type === 'all') {
                filterBar.classList.remove('hidden');
                document.getElementById('machine-search').value = '';
                populateTypeFilter();
            } else {
                filterBar.classList.add('hidden');
            }

            if (dataList.length > 0 && type !== 'all') {
                 const listHTML = dataList.map(item => generateCardHTML(item, type)).join('');
                 body.innerHTML = listHTML;
            } else if (type === 'all') {
                 filterModalList(); 
            } else {
                 body.innerHTML = `<div class="text-center text-[var(--text-muted)] py-8 font-mono">${emptyText}</div>`;
            }
            modal.classList.add('show');
        }
        
        function populateTypeFilter() {
            const select = document.getElementById('machine-type-filter');
            select.innerHTML = '<option value="">ทั้งหมด (ทุกประเภท)</option>';
            const types = [...new Set(appData.machines.map(m => m['ประเภทรถ']).filter(t => t))].sort();
            types.forEach(type => {
                const opt = document.createElement('option'); opt.value = type; opt.innerText = type; select.appendChild(opt);
            });
        }

        function filterModalList() {
            const type = lastModalType;
            const body = document.getElementById('modal-body');
            let sourceList = appData.alerts.all;
            const searchText = document.getElementById('machine-search').value.toLowerCase().trim();
            const filterType = document.getElementById('machine-type-filter').value;
            const filteredList = sourceList.filter(item => {
                const matchesSearch = !searchText || 
                    (item.info['รหัส'] || '').toLowerCase().includes(searchText) || 
                    (item.info['ทะเบียน'] || '').toLowerCase().includes(searchText);
                const matchesType = !filterType || (item.info['ประเภทรถ'] === filterType);
                return matchesSearch && matchesType;
            });
            if (filteredList.length === 0) {
                body.innerHTML = `<div class="text-center text-[var(--text-muted)] py-8 font-mono">ไม่พบข้อมูล</div>`;
            } else {
                const listHTML = filteredList.map(item => generateCardHTML(item, type)).join('');
                body.innerHTML = listHTML;
            }
        }
        function closeModal() { document.getElementById('modal').classList.remove('show'); }
        window.onclick = function(event) { if (event.target == document.getElementById('modal')) closeModal(); }

        function generateCardHTML(item, type) {
            const { info, expiredIssues, warningIssues } = item;
            const code = info['รหัส'], plate = info['ทะเบียน'] || '-', typeName = info['ประเภทรถ'] || '';
            let borderColor = '', statusIcon = '', bgClass = 'bg-[var(--bg-card)]', issuesHtml = '';
            if (type === 'all') {
                borderColor = 'border-l-4 border-[var(--status-blue)]';
                statusIcon = '<span class="text-[var(--text-muted)] font-bold text-[10px] bg-[var(--bg-body)] px-2 py-0.5 rounded-sm border border-[var(--border-color)]">รายการ</span>';
            } else {
                if (expiredIssues.length > 0) { borderColor = 'border-l-4 border-[var(--status-red)]'; statusIcon = '<span class="text-white font-bold text-[10px] bg-[var(--status-red)] px-2 py-0.5 rounded-sm">วิกฤต</span>'; bgClass = 'bg-red-500/10'; }
                else if (warningIssues.length > 0) { borderColor = 'border-l-4 border-[var(--safety-yellow)]'; statusIcon = '<span class="text-black font-bold text-[10px] bg-[var(--safety-yellow)] px-2 py-0.5 rounded-sm">เตือน</span>'; bgClass = 'bg-yellow-500/10'; }
                else { borderColor = 'border-l-4 border-[var(--status-green)]'; statusIcon = '<span class="text-white font-bold text-[10px] bg-[var(--status-green)] px-2 py-0.5 rounded-sm">ปกติ</span>'; }
            }
            if(type !== 'all' && (expiredIssues.length > 0 || warningIssues.length > 0)) {
                issuesHtml = '<div class="mt-2 pl-[44px] space-y-1 border-t border-[var(--border-color)] pt-1">';
                expiredIssues.forEach(txt => issuesHtml += `<div class="text-xs text-[var(--status-red)] font-mono mt-1"><i class="fas fa-times-circle"></i> ${txt}</div>`);
                warningIssues.forEach(txt => issuesHtml += `<div class="text-xs text-[var(--safety-yellow)] font-mono mt-1"><i class="fas fa-exclamation-triangle"></i> ${txt}</div>`);
                issuesHtml += '</div>';
            }
            return `<div onclick="showMachineDetails('${code}')" class="${bgClass} border border-[var(--border-color)] ${borderColor} p-3 mb-2 shadow-sm rounded cursor-pointer hover:shadow-lg transition">
                <div class="flex justify-between items-start"><div class="flex items-center gap-3"><div class="w-8 h-8 bg-[var(--bg-body)] flex items-center justify-center text-[var(--text-muted)] border border-[var(--border-color)] rounded"><i class="fas fa-truck-pickup text-sm"></i></div><div><div class="flex items-center gap-2"><span class="font-bold text-[var(--text-main)] font-[Black Ops One] text-base">${code}</span>${statusIcon}</div><div class="text-[10px] text-[var(--text-muted)] font-mono">${plate} // ${typeName}</div></div></div><i class="fas fa-chevron-right text-[var(--text-muted)] text-xs mt-2"></i></div>${issuesHtml}</div>`;
        }

        // --- Detail View ---
        function showMachineDetails(code, initialContext = {}) {
            const machine = appData.machines.find(m => m['รหัส'] === code);
            if (!machine) return;
            const modal = document.getElementById('modal');
            if (!modal.classList.contains('show')) { lastModalType = 'all'; modal.classList.add('show'); }
            document.getElementById('modal-filter-bar').classList.add('hidden');
            document.getElementById('modal-title').innerText = `รายละเอียด: ${code}`;
            
            modalChartState = { machineCode: code, view: initialContext.view || 'year', year: initialContext.year || null, month: initialContext.month || null };
            
            document.getElementById('modal-body').innerHTML = `
                <div class="space-y-4 animate-fade-in">
                    <button onclick="openModal(lastModalType)" class="construct-btn text-xs mb-2 flex items-center gap-1"><i class="fas fa-arrow-left"></i> ย้อนกลับ</button>
                    <div class="bg-[var(--bg-body)] p-3 rounded border border-[var(--border-color)]">
                        <div class="grid grid-cols-2 gap-3 text-xs">
                            <div><span class="text-[var(--text-muted)] block">ทะเบียน</span> <div class="text-[var(--text-main)] font-bold text-sm">${machine['ทะเบียน'] || '-'}</div></div>
                            <div><span class="text-[var(--text-muted)] block">ประเภท</span> <div class="text-[var(--text-main)]">${machine['ประเภทรถ'] || '-'}</div></div>
                            <div><span class="text-[var(--text-muted)] block">ยี่ห้อ</span> <div class="text-[var(--text-main)]">${machine['ยี่ห้อรถ'] || '-'}</div></div>
                            <div><span class="text-[var(--text-muted)] block">เลขเครื่อง</span> <div class="text-[var(--text-main)]">${machine['เลขเครื่อง'] || '-'}</div></div>
                            <div><span class="text-[var(--text-muted)] block">เลขตัวรถ</span> <div class="text-[var(--text-main)]">${machine['เลขตัวรถ'] || '-'}</div></div>
                            <div><span class="text-[var(--text-muted)] block">กรรมสิทธิ์</span> <div class="text-[var(--text-main)]">${machine['กรรมสิทธิ์'] || '-'}</div></div>
                            <div class="border-t border-[var(--border-color)] pt-2 mt-1 col-span-2 grid grid-cols-2 gap-3">
                                <div><span class="text-[var(--text-muted)] block">ทะเบียนขาด</span> <div class="text-[var(--status-red)] font-bold">${machine['วันที่ทะเบียนขาด'] || '-'}</div></div>
                                <div><span class="text-[var(--text-muted)] block">ประกันขาด</span> <div class="text-[var(--status-red)] font-bold">${machine['วันที่ประกัน+พรบ.ขาด'] || '-'}</div></div>
                            </div>
                            <div class="col-span-2 border-t border-[var(--border-color)] pt-2 mt-1"><span class="text-[var(--text-muted)] block">หมายเหตุ</span> <div class="text-[var(--text-main)]">${machine['หมายเหตุ'] || '-'}</div></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="bg-[var(--bg-body)] p-3 rounded border border-[var(--border-color)]">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-[var(--safety-yellow)] text-xs font-bold flex items-center gap-2"><i class="fas fa-gas-pump"></i> <span id="modal-fuel-title">สถิติน้ำมัน</span></h4>
                                
                                <div class="flex items-center gap-2">
                                    <span id="val-modal-fuel" class="text-[10px] text-[var(--safety-yellow)] font-mono font-bold"></span>
                                    <button id="btn-back-modal-fuel" onclick="stepBackModalCharts()" class="hidden text-[var(--text-muted)] hover:text-white text-[10px] border border-[var(--border-color)] px-2 rounded"><i class="fas fa-arrow-up"></i></button>
                                </div>
                            </div>
                            <div class="h-40 relative"><canvas id="modalFuelChart"></canvas></div>
                        </div>
                        <div class="bg-[var(--bg-body)] p-3 rounded border border-[var(--border-color)]">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-[var(--status-purple)] text-xs font-bold flex items-center gap-2"><i class="fas fa-wrench"></i> <span id="modal-maint-title">ค่าซ่อมบำรุง</span></h4>
                                
                                <div class="flex items-center gap-2">
                                    <span id="val-modal-maint" class="text-[10px] text-[var(--status-purple)] font-mono font-bold"></span>
                                    <button id="btn-back-modal-maint" onclick="stepBackModalCharts()" class="hidden text-[var(--text-muted)] hover:text-white text-[10px] border border-[var(--border-color)] px-2 rounded"><i class="fas fa-arrow-up"></i></button>
                                </div>
                            </div>
                            <div class="h-40 relative"><canvas id="modalMaintChart"></canvas></div>
                        </div>
                    </div>
                </div>`;
            setTimeout(() => { updateModalCharts(); }, 50);
        }

        // --- Shared Logic for Modal Charts ---

        function stepBackModalCharts() {
            if (modalChartState.view === 'day') {
                modalChartState.view = 'month';
                modalChartState.month = null;
            } else if (modalChartState.view === 'month') {
                modalChartState.view = 'year';
                modalChartState.year = null;
            }
            updateModalCharts();
        }

        function updateModalCharts() {
            renderModalFuelChart();
            renderModalMaintChart();
            
            // Update Back Buttons Visibility
            const isRoot = modalChartState.view === 'year';
            ['btn-back-modal-fuel', 'btn-back-modal-maint'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                   if (isRoot) el.classList.add('hidden');
                   else el.classList.remove('hidden');
                }
            });
        }

        function renderModalFuelChart() {
            const code = modalChartState.machineCode;
            const machineFuel = appData.fuel.filter(f => f['รหัสรถ'] === code);
            const titleElem = document.getElementById('modal-fuel-title');
            const valElem = document.getElementById('val-modal-fuel');
            
            let labels = [], data = [], color = getCssVar('--safety-yellow'), total = 0;

            if (modalChartState.view === 'year') {
                if(titleElem) titleElem.innerText = `สถิติน้ำมัน (รายปี)`;
                const grouped = {}; machineFuel.forEach(item => { const d = parseDate(item['วันที่']); if (d) { const val = parseFloat(item['ปริมาณ(ลิตร)'])||0; grouped[d.getFullYear()] = (grouped[d.getFullYear()] || 0) + val; total += val; } });
                labels = Object.keys(grouped).sort(); data = labels.map(y => grouped[y]); color = getCssVar('--status-blue');
            } else if (modalChartState.view === 'month') {
                if (!modalChartState.year) { const years = [...new Set(machineFuel.map(i => parseDate(i['วันที่'])?.getFullYear()).filter(y => y))].sort((a,b) => b-a); modalChartState.year = years.length > 0 ? years[0] : new Date().getFullYear(); }
                if(titleElem) titleElem.innerText = `สถิติน้ำมัน (ปี ${modalChartState.year})`;
                const monthsTH = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
                const grouped = new Array(12).fill(0); machineFuel.forEach(item => { const d = parseDate(item['วันที่']); if (d && d.getFullYear() === modalChartState.year) { const val = parseFloat(item['ปริมาณ(ลิตร)'])||0; grouped[d.getMonth()] += val; total += val; } });
                labels = monthsTH; data = grouped; color = getCssVar('--safety-yellow');
            } else if (modalChartState.view === 'day') {
                const mName = new Date(modalChartState.year, modalChartState.month).toLocaleString('th-TH', { month: 'short' });
                if(titleElem) titleElem.innerText = `สถิติน้ำมัน (${mName} ${modalChartState.year})`;
                const daysInMonth = new Date(modalChartState.year, modalChartState.month + 1, 0).getDate();
                const grouped = new Array(daysInMonth).fill(0); machineFuel.forEach(item => { const d = parseDate(item['วันที่']); if (d && d.getFullYear() === modalChartState.year && d.getMonth() === modalChartState.month) { const val = parseFloat(item['ปริมาณ(ลิตร)'])||0; grouped[d.getDate() - 1] += val; total += val; } });
                labels = Array.from({length: daysInMonth}, (_, i) => i + 1); data = grouped; color = getCssVar('--status-red');
            }

            if(valElem) valElem.innerText = `${formatNumber(total)} ลิตร`;

            if (modalFuelChartInstance) modalFuelChartInstance.destroy();
            const ctx = document.getElementById('modalFuelChart').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 300); gradient.addColorStop(0, color); gradient.addColorStop(1, 'rgba(0,0,0,0.1)');
            
            modalFuelChartInstance = new Chart(ctx, {
                type: 'bar', data: { labels: labels, datasets: [{ label: 'ลิตร', data: data, backgroundColor: color, borderRadius: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                    scales: { x: { display: true, ticks: { color: getCssVar('--text-muted'), font: { size: 9 } }, grid: { display: false } }, y: { display: true, ticks: { color: getCssVar('--text-muted'), font: { size: 9 } }, grid: { color: getCssVar('--chart-grid') } } },
                    onClick: (e, activeEls) => { if (activeEls.length > 0) { 
                        const index = activeEls[0].index; 
                        if (modalChartState.view === 'year') { modalChartState.year = parseInt(labels[index]); modalChartState.view = 'month'; updateModalCharts(); } 
                        else if (modalChartState.view === 'month') { modalChartState.month = index; modalChartState.view = 'day'; updateModalCharts(); } 
                    } },
                    onHover: (e, els) => e.native.target.style.cursor = els[0] ? 'pointer' : 'default'
                }
            });
        }

        function renderModalMaintChart() {
            const code = modalChartState.machineCode;
            const machineMaint = appData.maintenance.filter(m => m['รหัสรถ'] === code);
            const titleElem = document.getElementById('modal-maint-title');
            const valElem = document.getElementById('val-modal-maint');
            
            let labels = [], data = [], color = getCssVar('--status-purple'), total = 0;

            // Logic mirroring Fuel Chart
             if (modalChartState.view === 'year') {
                if(titleElem) titleElem.innerText = `ค่าซ่อม (รายปี)`;
                const grouped = {}; machineMaint.forEach(item => { const d = parseDate(item['วันที่']); if (d) { const val = parseFloat(item['ค่าซ่อมบำรุง'])||0; grouped[d.getFullYear()] = (grouped[d.getFullYear()] || 0) + val; total += val; } });
                labels = Object.keys(grouped).sort(); data = labels.map(y => grouped[y]);
            } else if (modalChartState.view === 'month') {
                if (!modalChartState.year) { const years = [...new Set(machineMaint.map(i => parseDate(i['วันที่'])?.getFullYear()).filter(y => y))].sort((a,b) => b-a); modalChartState.year = years.length > 0 ? years[0] : new Date().getFullYear(); }
                if(titleElem) titleElem.innerText = `ค่าซ่อม (ปี ${modalChartState.year})`;
                const monthsTH = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
                const grouped = new Array(12).fill(0); machineMaint.forEach(item => { const d = parseDate(item['วันที่']); if (d && d.getFullYear() === modalChartState.year) { const val = parseFloat(item['ค่าซ่อมบำรุง'])||0; grouped[d.getMonth()] += val; total += val; } });
                labels = monthsTH; data = grouped; 
            } else if (modalChartState.view === 'day') {
                const mName = new Date(modalChartState.year, modalChartState.month).toLocaleString('th-TH', { month: 'short' });
                if(titleElem) titleElem.innerText = `ค่าซ่อม (${mName} ${modalChartState.year})`;
                const daysInMonth = new Date(modalChartState.year, modalChartState.month + 1, 0).getDate();
                const grouped = new Array(daysInMonth).fill(0); machineMaint.forEach(item => { const d = parseDate(item['วันที่']); if (d && d.getFullYear() === modalChartState.year && d.getMonth() === modalChartState.month) { const val = parseFloat(item['ค่าซ่อมบำรุง'])||0; grouped[d.getDate() - 1] += val; total += val; } });
                labels = Array.from({length: daysInMonth}, (_, i) => i + 1); data = grouped;
            }

            if(valElem) valElem.innerText = `${formatNumber(total)} บ.`;

            if (modalMaintChartInstance) modalMaintChartInstance.destroy();
            
            modalMaintChartInstance = new Chart(document.getElementById('modalMaintChart'), {
                type: 'line', 
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        label: 'บาท', 
                        data: data, 
                        borderColor: color, 
                        borderWidth: 2, 
                        pointRadius: 2, 
                        tension: 0.4 
                    }] 
                },
                options: { 
                    plugins: { legend: { display: false } }, 
                    scales: { x: { display: true, ticks: { color: getCssVar('--text-muted'), font: { size: 9 } }, grid: { display: false } }, y: { display: true, ticks: { color: getCssVar('--text-muted'), font: { size: 9 } }, grid: { color: getCssVar('--chart-grid') } } },
                    onClick: (e, activeEls) => { if (activeEls.length > 0) { 
                        const index = activeEls[0].index; 
                        if (modalChartState.view === 'year') { modalChartState.year = parseInt(labels[index]); modalChartState.view = 'month'; updateModalCharts(); } 
                        else if (modalChartState.view === 'month') { modalChartState.month = index; modalChartState.view = 'day'; updateModalCharts(); } 
                    } },
                    onHover: (e, els) => e.native.target.style.cursor = els[0] ? 'pointer' : 'default'
                }
            });
        }

        // --- Main Chart ---
        function setupFuelChart() {
            const selector = document.getElementById('machine-select');
            const codes = [...new Set(appData.machines.map(m => m['รหัส']).filter(c => c))].sort();
            codes.forEach(code => { const opt = document.createElement('option'); opt.value = code; opt.innerText = code; selector.appendChild(opt); });
            selector.addEventListener('change', (e) => { chartState.selectedMachine = e.target.value; resetChartToYear(); });
            document.getElementById('chart-back-btn').addEventListener('click', goBackLevel);
            document.getElementById('chart-home-btn').addEventListener('click', () => { chartState.selectedMachine = 'ALL'; document.getElementById('machine-select').value = 'ALL'; resetChartToYear(); });
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active'); chartState.subView = e.target.dataset.view; updateChart();
                });
            });
            updateChart(); 
        }

        function switchGraphMode(mode) {
            currentGraphMode = mode;
            const cardFuel = document.getElementById('card-fuel');
            const cardMaint = document.getElementById('card-maintenance');
            const cardProj = document.getElementById('card-project'); // Project Card

            // Reset visual states
            cardFuel.classList.remove('card-selected'); 
            cardMaint.classList.remove('card-selected');
            cardProj.classList.remove('card-selected');

            // Set new state
            const chartTitle = document.getElementById('chart-title');
            const chartIcon = document.getElementById('chart-icon');
            const machineSelectDiv = document.getElementById('machine-select-container');
            const viewTogglesDiv = document.getElementById('view-toggles'); // Get Toggle Container
            
            // Default: Show buttons
            viewTogglesDiv.classList.remove('hidden'); 
            // Re-show project-specific buttons if we hid them (we will re-render HTML for simplicity or just show/hide)
            // Actually, let's just swap innerHTML of the toggle container for simplicity
            
            if (mode === 'fuel') {
                cardFuel.classList.add('card-selected');
                chartTitle.innerText = 'สถิติน้ำมันเชื้อเพลิง'; 
                chartIcon.className = 'fas fa-chart-bar text-[var(--safety-yellow)]';
                machineSelectDiv.style.visibility = 'visible'; 
                
                // Set Toggles for Fuel
                viewTogglesDiv.innerHTML = `
                    <button class="construct-btn toggle-btn text-xs active" id="btn-trend" onclick="setSubView('trend', this)">แนวโน้ม</button>
                    <button class="construct-btn toggle-btn text-xs" id="btn-top10" onclick="setSubView('top10', this)">10 อันดับ</button>
                `;
                
                resetChartToYear();
            } else if (mode === 'maintenance') {
                cardMaint.classList.add('card-selected');
                chartTitle.innerText = 'ค่าซ่อมบำรุงรายเดือน'; 
                chartIcon.className = 'fas fa-tools text-[var(--status-purple)]';
                machineSelectDiv.style.visibility = 'visible';
                
                // Set Toggles for Maint (Same as fuel)
                viewTogglesDiv.innerHTML = `
                    <button class="construct-btn toggle-btn text-xs active" id="btn-trend" onclick="setSubView('trend', this)">แนวโน้ม</button>
                    <button class="construct-btn toggle-btn text-xs" id="btn-top10" onclick="setSubView('top10', this)">10 อันดับ</button>
                `;
                
                resetChartToYear();
            } else if (mode === 'project') {
                cardProj.classList.add('card-selected');
                chartTitle.innerText = 'สรุปแยกตามโครงการ';
                chartIcon.className = 'fas fa-building text-[var(--safety-orange)]';
                machineSelectDiv.style.visibility = 'hidden'; // Hide machine selector for project view
                
                // Set Toggles for Project
                viewTogglesDiv.innerHTML = `
                    <button class="construct-btn toggle-btn text-xs active" id="btn-proj-fuel" onclick="setSubView('fuel', this)">ปริมาณน้ำมัน</button>
                    <button class="construct-btn toggle-btn text-xs" id="btn-proj-cost" onclick="setSubView('cost', this)">ค่าซ่อมบำรุง</button>
                `;
                
                // Set default subview for project
                chartState.subView = 'fuel'; 
                chartState.view = 'year'; // Force year view (Project is a summary view)
                updateChart();
            }
        }
        
        // Helper for new dynamic buttons
        function setSubView(view, btn) {
             document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
             btn.classList.add('active');
             chartState.subView = view;
             updateChart();
        }

        function resetChartToYear() {
            // Unified reset logic
            chartState.view = 'year'; chartState.selectedYear = null; chartState.selectedMonth = null; chartState.selectedDay = null; chartState.subView = 'trend';
            
            // Visual reset of toggles if not project mode
            if(currentGraphMode !== 'project') {
                const btnTrend = document.getElementById('btn-trend');
                if(btnTrend) btnTrend.click(); // Simulate click to set active state and subView
            }
            
            updateChart();
        }

        function goBackLevel() {
            // Unified back logic
            if (chartState.view === 'single_day') { chartState.view = 'day'; chartState.selectedDay = null; chartState.subView = 'trend'; }
            else if (chartState.view === 'day') { chartState.view = 'month'; chartState.selectedMonth = null; chartState.subView = 'trend'; }
            else if (chartState.view === 'month') { chartState.view = 'year'; chartState.selectedYear = null; chartState.subView = 'trend'; }
            // document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active')); document.getElementById('btn-trend').classList.add('active');
            updateChart();
        }

        function updateChart() {
            let labels = [], values = [], labelText = '', breadcrumb = '', showToggles = false;
            let currentTotal = 0, currentScopeLabel = 'ทั้งหมด';
            const isAllMachines = chartState.selectedMachine === 'ALL';
            
            document.getElementById('chart-back-btn').classList.toggle('hidden', chartState.view === 'year');
            document.getElementById('chart-home-btn').classList.toggle('hidden', chartState.view === 'year');
            // document.getElementById('view-toggles').classList.toggle('hidden', !(isAllMachines && chartState.view !== 'single_day')); // Logic moved to switchGraphMode

            // --- PROJECT MODE RENDER ---
            if (currentGraphMode === 'project') {
                document.getElementById('chart-breadcrumb').innerHTML = `<span class="text-[var(--safety-orange)]">สรุปภาพรวมโครงการ</span>`;
                
                // Aggregate Data by Project
                const projData = {};
                
                if (chartState.subView === 'fuel') {
                    appData.fuel.forEach(item => {
                        const p = item['โครงการ'] || 'ไม่ระบุ';
                        const v = parseFloat(item['ปริมาณ(ลิตร)']) || 0;
                        projData[p] = (projData[p] || 0) + v;
                        currentTotal += v;
                    });
                    labelText = 'ปริมาณน้ำมัน (ลิตร)';
                } else { // cost
                     appData.maintenance.forEach(item => {
                        const p = item['โครงการ'] || 'ไม่ระบุ';
                        const v = parseFloat(item['ค่าซ่อมบำรุง']) || 0;
                        projData[p] = (projData[p] || 0) + v;
                        currentTotal += v;
                    });
                    labelText = 'ค่าใช้จ่าย (บาท)';
                }

                // Sort by Value
                const sorted = Object.entries(projData).sort(([,a], [,b]) => b - a);
                labels = sorted.map(k => k[0]); 
                values = sorted.map(k => k[1]);
                
                renderCanvas(labels, values, labelText, (ctx) => {
                     const gradient = ctx.createLinearGradient(0, 0, 0, 400); 
                     gradient.addColorStop(0, getCssVar('--safety-orange')); 
                     gradient.addColorStop(1, '#c2410c');
                     return gradient;
                });
                return; // Exit function for Project Mode
            }

            // --- STANDARD MODES (Fuel / Maintenance) ---
            
            let dataSource = currentGraphMode === 'fuel' ? appData.fuel : appData.maintenance;
            let valueKey = currentGraphMode === 'fuel' ? 'ปริมาณ(ลิตร)' : 'ค่าซ่อมบำรุง';
            let unitLabel = currentGraphMode === 'fuel' ? 'ลิตร' : 'บาท';

            const colorBarBg = (ctx) => {
                const gradient = ctx.createLinearGradient(0, 0, 0, 400); 
                let c1, c2;
                if(currentGraphMode === 'fuel') {
                     if (chartState.subView === 'top10') { c1=getCssVar('--safety-orange'); c2='#c2410c'; }
                     else { c1=getCssVar('--safety-yellow'); c2='#a16207'; }
                } else { // Maintenance Purple
                     if (chartState.subView === 'top10') { c1='#d946ef'; c2='#a21caf'; } 
                     else { c1=getCssVar('--status-purple'); c2='#581c87'; }
                }
                gradient.addColorStop(0, c1); gradient.addColorStop(1, c2);
                return gradient;
            };

            const filterAndSum = (filterFn, groupFn) => {
                const grouped = {};
                dataSource.forEach(item => {
                    if (filterFn(item)) {
                        const val = parseFloat(item[valueKey]) || 0;
                        currentTotal += val;
                        const key = groupFn(item);
                        grouped[key] = (grouped[key] || 0) + val;
                    }
                });
                return grouped;
            }

            if (chartState.view === 'year') {
                breadcrumb = isAllMachines ? `<span class="text-[var(--text-main)]">ทั้งหมด</span> > <span class="text-[var(--safety-yellow)]">รายปี</span>` : `<span class="text-[var(--text-main)]">${chartState.selectedMachine}</span> > <span class="text-[var(--safety-yellow)]">รายปี</span>`;
                currentScopeLabel = isAllMachines ? 'ตลอดเวลา' : `${chartState.selectedMachine}`;
                
                if (!isAllMachines || chartState.subView === 'trend') {
                    labelText = `รวม (${unitLabel})`;
                    const data = filterAndSum(
                        i => isAllMachines || i['รหัสรถ'] === chartState.selectedMachine, 
                        i => parseDate(i['วันที่'])?.getFullYear()
                    );
                    labels = Object.keys(data).sort(); values = labels.map(k => data[k]);
                } else {
                    labelText = '10 อันดับสูงสุด (ทั้งหมด)';
                    const data = filterAndSum(i => true, i => i['รหัสรถ']);
                    const sorted = Object.entries(data).sort(([,a], [,b]) => b - a).slice(0, 10);
                    labels = sorted.map(k => k[0]); values = sorted.map(k => k[1]);
                }
            } 
            else if (chartState.view === 'month') {
                breadcrumb = `${isAllMachines ? 'ทั้งหมด' : chartState.selectedMachine} > ${chartState.selectedYear} > <span class="text-[var(--safety-yellow)]">รายเดือน</span>`;
                currentScopeLabel = `ปี ${chartState.selectedYear}`;
                
                if (!isAllMachines || chartState.subView === 'trend') {
                    labelText = `รวม (${unitLabel})`;
                    const months = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
                    const data = filterAndSum(
                        i => (isAllMachines || i['รหัสรถ'] === chartState.selectedMachine) && parseDate(i['วันที่'])?.getFullYear() === chartState.selectedYear,
                        i => parseDate(i['วันที่'])?.getMonth()
                    );
                    labels = months; values = new Array(12).fill(0).map((_, i) => data[i] || 0);
                } else {
                    labelText = `10 อันดับสูงสุด: ปี ${chartState.selectedYear}`;
                    const data = filterAndSum(
                        i => parseDate(i['วันที่'])?.getFullYear() === chartState.selectedYear,
                        i => i['รหัสรถ']
                    );
                    const sorted = Object.entries(data).sort(([,a], [,b]) => b - a).slice(0, 10);
                    labels = sorted.map(k => k[0]); values = sorted.map(k => k[1]);
                }
            }
            else if (chartState.view === 'day') {
                const mName = new Date(chartState.selectedYear, chartState.selectedMonth).toLocaleString('th-TH', { month: 'long' });
                breadcrumb = `${isAllMachines ? 'ทั้งหมด' : chartState.selectedMachine} > ${chartState.selectedYear} > ${mName} > <span class="text-[var(--safety-yellow)]">รายวัน</span>`;
                currentScopeLabel = `เดือน ${mName} ${chartState.selectedYear}`;

                if (!isAllMachines || chartState.subView === 'trend') {
                    labelText = `รวม (${unitLabel})`;
                    const daysInMonth = new Date(chartState.selectedYear, chartState.selectedMonth + 1, 0).getDate();
                    const data = filterAndSum(
                        i => (isAllMachines || i['รหัสรถ'] === chartState.selectedMachine) && parseDate(i['วันที่'])?.getFullYear() === chartState.selectedYear && parseDate(i['วันที่'])?.getMonth() === chartState.selectedMonth,
                        i => parseDate(i['วันที่'])?.getDate()
                    );
                    labels = Array.from({length: daysInMonth}, (_, i) => i + 1); values = labels.map(d => data[d] || 0);
                } else {
                    labelText = `10 อันดับสูงสุด: ${mName}`;
                    const data = filterAndSum(
                        i => parseDate(i['วันที่'])?.getFullYear() === chartState.selectedYear && parseDate(i['วันที่'])?.getMonth() === chartState.selectedMonth,
                        i => i['รหัสรถ']
                    );
                    const sorted = Object.entries(data).sort(([,a], [,b]) => b - a).slice(0, 10);
                    labels = sorted.map(k => k[0]); values = sorted.map(k => k[1]);
                }
            }
            else if (chartState.view === 'single_day') {
                const mName = new Date(chartState.selectedYear, chartState.selectedMonth).toLocaleString('th-TH', { month: 'long' });
                breadcrumb = `ทั้งหมด > ${chartState.selectedYear} > ${mName} > ${chartState.selectedDay} > <span class="text-[var(--safety-orange)]">10 อันดับ</span>`;
                currentScopeLabel = `${chartState.selectedDay} ${mName} ${chartState.selectedYear}`;
                labelText = `10 อันดับสูงสุด: ${chartState.selectedDay} ${mName}`;
                
                const data = filterAndSum(
                    i => parseDate(i['วันที่'])?.getFullYear() === chartState.selectedYear && parseDate(i['วันที่'])?.getMonth() === chartState.selectedMonth && parseDate(i['วันที่'])?.getDate() === chartState.selectedDay,
                    i => i['รหัสรถ']
                );
                const sorted = Object.entries(data).sort(([,a], [,b]) => b - a).slice(0, 10);
                labels = sorted.map(k => k[0]); values = sorted.map(k => k[1]);
            }

            // Update Label based on mode
            if(currentGraphMode === 'fuel') {
                document.getElementById('total-fuel').innerText = formatNumber(currentTotal) + " ลิตร";
                document.getElementById('label-total-fuel').innerText = `น้ำมัน (${currentScopeLabel})`;
            } else if (currentGraphMode === 'maintenance') {
                document.getElementById('total-maintenance').innerText = formatNumber(currentTotal) + " บาท";
            }

            document.getElementById('chart-breadcrumb').innerHTML = breadcrumb;
            renderCanvas(labels, values, labelText, colorBarBg);
        }

        function renderCanvas(labels, data, labelText, colorFunc) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (chartState.instance) chartState.instance.destroy();

            chartState.instance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: labelText,
                        data: data,
                        backgroundColor: colorFunc(ctx),
                        borderRadius: 0, 
                        borderWidth: 1,
                        borderColor: getCssVar('--bg-body'),
                        hoverBackgroundColor: getCssVar('--text-main'),
                        hoverBorderColor: getCssVar('--safety-yellow')
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: getCssVar('--bg-panel'), 
                            titleColor: getCssVar('--safety-yellow'), 
                            bodyColor: getCssVar('--text-main'), 
                            borderColor: getCssVar('--border-color'), 
                            borderWidth: 1, 
                            titleFont: {family: 'Prompt'},
                            callbacks: { label: (c) => c.parsed.y.toLocaleString() + ' ' + (currentGraphMode==='fuel' || (currentGraphMode==='project' && chartState.subView==='fuel') ? 'ลิตร' : 'บาท') }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: getCssVar('--chart-grid'), borderDash: [2, 2] }, ticks: { color: getCssVar('--chart-text'), font: {family: 'Prompt', size: 10} } },
                        x: { grid: { display: false }, ticks: { color: getCssVar('--chart-text'), font: {family: 'Prompt', size: 10} } }
                    },
                    onClick: (e, activeEls) => { if (activeEls.length > 0) handleChartClick(activeEls[0].index, labels); },
                    onHover: (e, els) => e.native.target.style.cursor = els[0] ? 'pointer' : 'default'
                }
            });
        }

        function handleChartClick(index, labels) {
            // Project Mode: No drill down for now
            if(currentGraphMode === 'project') return;

            // Unified Click Logic for both Fuel & Maintenance
            if (chartState.subView === 'top10') {
                const machineCode = labels[index];
                let context = { view: 'year' }; 
                if (chartState.view === 'month') { context = { view: 'month', year: chartState.selectedYear }; } 
                else if (chartState.view === 'day' || chartState.view === 'single_day') { context = { view: 'day', year: chartState.selectedYear, month: chartState.selectedMonth }; }
                showMachineDetails(machineCode, context);
                return; 
            }

            if (chartState.view === 'year') {
                if (chartState.subView === 'trend') { chartState.selectedYear = parseInt(labels[index]); chartState.view = 'month'; updateChart(); }
            } else if (chartState.view === 'month') {
                if (chartState.subView === 'trend') { chartState.selectedMonth = index; chartState.view = 'day'; updateChart(); }
            } else if (chartState.view === 'day') {
                if (chartState.subView === 'trend' && chartState.selectedMachine === 'ALL') { chartState.selectedDay = index + 1; chartState.view = 'single_day'; chartState.subView = 'top10'; updateChart(); }
            }
        }

        loadData();
    </script>
</body>
</html>
