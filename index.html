<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üöú FleetManager ‚Äî V3.2 (Dark UI)</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<script>
  tailwind.config = {
    darkMode: 'class'
  }
</script>

<style>
body { transition: background .3s; }
.card { border-radius:1rem; padding:1rem; box-shadow:0 2px 8px rgba(0,0,0,.2); }
.kpi-blue{background:linear-gradient(135deg,#2563eb,#1e40af)}
.kpi-green{background:linear-gradient(135deg,#16a34a,#065f46)}
.kpi-red{background:linear-gradient(135deg,#dc2626,#7f1d1d)}
.kpi-orange{background:linear-gradient(135deg,#f97316,#7c2d12)}
</style>
</head>

<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">

<!-- TOP BAR -->
<div class="sticky top-0 z-50 backdrop-blur bg-white/80 dark:bg-slate-800/80 shadow">
  <div class="max-w-7xl mx-auto flex justify-between items-center p-3">
    <div class="flex items-center gap-3">
      <div class="bg-blue-600 text-white p-2 rounded-xl"><i class="fa-solid fa-truck"></i></div>
      <div>
        <div class="font-bold">FleetManager</div>
        <div class="text-xs opacity-60">V3.2 Dark UI</div>
      </div>
    </div>

    <div class="flex gap-2">
      <button id="darkToggle" class="px-3 py-1 rounded bg-slate-200 dark:bg-slate-700">üåô</button>
      <button id="reloadBtn" class="px-3 py-1 rounded bg-blue-600 text-white">üîÑ</button>
    </div>
  </div>

  <!-- FLOAT FILTER BAR -->
  <div class="max-w-7xl mx-auto px-3 pb-2">
    <div class="flex gap-2 overflow-auto">
      <select id="machineFilter" class="px-3 py-1 rounded dark:bg-slate-700">
        <option value="">üöú ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏±‡∏ô</option>
      </select>
      <input id="yearFilter" type="number" placeholder="‡∏õ‡∏µ" class="px-3 py-1 rounded dark:bg-slate-700 w-24" />
      <input id="monthFilter" type="number" placeholder="‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" class="px-3 py-1 rounded dark:bg-slate-700 w-24" />
      <button id="applyFilter" class="px-3 py-1 rounded bg-blue-600 text-white">‡∏Å‡∏£‡∏≠‡∏á</button>
    </div>
  </div>
</div>

<!-- KPI -->
<div class="max-w-7xl mx-auto p-3 grid grid-cols-2 md:grid-cols-4 gap-3">
  <div class="card kpi-blue text-white">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î<div id="kpiTotal" class="text-3xl font-bold">-</div></div>
  <div class="card kpi-green text-white">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô<div id="kpiActive" class="text-3xl font-bold">-</div></div>
  <div class="card kpi-red text-white">‡∏ã‡πà‡∏≠‡∏°<div id="kpiRepair" class="text-3xl font-bold">-</div></div>
  <div class="card kpi-orange text-white">Idle >30 ‡∏ß‡∏±‡∏ô<div id="kpiIdleLong" class="text-3xl font-bold">-</div></div>
</div>

<!-- CHARTS -->
<div class="max-w-7xl mx-auto px-3 grid md:grid-cols-2 gap-3">
  <div class="card bg-white dark:bg-slate-800"><canvas id="fuelChart"></canvas></div>
  <div class="card bg-white dark:bg-slate-800"><canvas id="maintChart"></canvas></div>
</div>

<!-- MOBILE CARD LIST -->
<div id="listArea" class="max-w-7xl mx-auto p-3 grid gap-3"></div>

<script>
const SHEETS = {
  machines: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQk9jak3sAnetueFVqbVYLXhHUYKFE7S7CxSZsEB_NQT_8vRyeN7j_B3OoIORlSPjRBLdDYU53k6fUl/pub?gid=2036292301&single=true&output=csv",
  fuel: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQk9jak3sAnetueFVqbVYLXhHUYKFE7S7CxSZsEB_NQT_8vRyeN7j_B3OoIORlSPjRBLdDYU53k6fUl/pub?gid=1215465404&single=true&output=csv",
  maintenance: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQk9jak3sAnetueFVqbVYLXhHUYKFE7S7CxSZsEB_NQT_8vRyeN7j_B3OoIORlSPjRBLdDYU53k6fUl/pub?gid=513299430&single=true&output=csv",
  location: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQk9jak3sAnetueFVqbVYLXhHUYKFE7S7CxSZsEB_NQT_8vRyeN7j_B3OoIORlSPjRBLdDYU53k6fUl/pub?gid=613103968&single=true&output=csv",
  insurance: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQk9jak3sAnetueFVqbVYLXhHUYKFE7S7CxSZsEB_NQT_8vRyeN7j_B3OoIORlSPjRBLdDYU53k6fUl/pub?gid=1698787286&single=true&output=csv"
};

const store={machines:[],fuel:[],maintenance:[],location:[],insurance:[]};
let fuelChart,maintChart;

function loadCSV(url){return new Promise(res=>Papa.parse(url,{download:true,header:true,complete:r=>res(r.data)}));}

async function loadData(){
 const [m,f,ma,l,i]=await Promise.all([
  loadCSV(SHEETS.machines),loadCSV(SHEETS.fuel),loadCSV(SHEETS.maintenance),loadCSV(SHEETS.location),loadCSV(SHEETS.insurance)
 ]);
 store.machines=m;store.fuel=f;store.maintenance=ma;store.location=l;store.insurance=i;
 buildFilters();renderAll();
}

function buildFilters(){
 machineFilter.innerHTML='<option value="">üöú ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏±‡∏ô</option>';
 store.machines.forEach(r=>{
  const op=document.createElement('option');op.value=r['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á'];op.textContent=r['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á'];machineFilter.appendChild(op);
 });
}

function renderAll(){renderKPI();renderCharts();renderCards();}

function renderKPI(){
 kpiTotal.innerText=store.machines.length;
 kpiActive.innerText=store.machines.filter(r=>r['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞']==='‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô').length;
 kpiRepair.innerText=store.machines.filter(r=>r['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞']==='‡∏ã‡πà‡∏≠‡∏°').length;
 const today=new Date();
 kpiIdleLong.innerText=store.location.filter(r=>!r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å']).filter(r=>((today-new Date(r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤']))/86400000)>30).length;
}

function renderCards(){
 listArea.innerHTML='';
 let rows=store.machines;
 if(machineFilter.value) rows=rows.filter(r=>r['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á']===machineFilter.value);

 rows.forEach(r=>{
  const div=document.createElement('div');
  div.className='card bg-white dark:bg-slate-800';
  div.innerHTML=`
   <div class='flex justify-between'>
     <div class='font-bold'>${r['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á']} - ${r['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á']}</div>
     <div>${r['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞']}</div>
   </div>
   <div class='text-sm opacity-70 mt-1'>${r['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó']} | ${r['‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô']}</div>
   <div class='text-right mt-2 font-semibold'>‚è± ${r['‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô']} ‡∏ä‡∏°.</div>
  `;
  listArea.appendChild(div);
 });
}

function renderCharts(){
 const agg=(arr,dateField,valField)=>{
  const o={};arr.forEach(r=>{if(!r[dateField])return;const m=r[dateField].slice(0,7);o[m]=(o[m]||0)+Number(r[valField]||0);});return o;}
 const fAgg=agg(store.fuel,'‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢(‡∏ö‡∏≤‡∏ó)');
 const mAgg=agg(store.maintenance,'‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ã‡πà‡∏≠‡∏°','‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢(‡∏ö‡∏≤‡∏ó)');

 const fLabels=Object.keys(fAgg).sort();const fVals=fLabels.map(k=>fAgg[k]);
 const mLabels=Object.keys(mAgg).sort();const mVals=mLabels.map(k=>mAgg[k]);

 if(fuelChart)fuelChart.destroy();
 fuelChart=new Chart(fuelChart,{type:'bar',data:{labels:fLabels,datasets:[{data:fVals}]}});

 if(maintChart)maintChart.destroy();
 maintChart=new Chart(maintChart,{type:'bar',data:{labels:mLabels,datasets:[{data:mVals}]}});
}

// Dark Mode Toggle
const toggle=document.getElementById('darkToggle');
toggle.onclick=()=>document.documentElement.classList.toggle('dark');

applyFilter.onclick=renderCards;
reloadBtn.onclick=loadData;

loadData();
</script>
</body>
</html>
