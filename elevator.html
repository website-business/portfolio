<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elevator Rescue - v34 Breaker Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* --- CORE --- */
        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: #0f172a; 
            height: 100dvh; width: 100vw; 
            overflow: hidden; display: flex; 
            user-select: none;
        }

        #game-window {
            width: 100%; height: 100%; background-color: #f8fafc;
            position: relative; display: flex; flex-direction: column; overflow: hidden;
        }

        @media (min-width: 1024px) { 
            #game-window { max-width: 1400px; max-height: 900px; border-radius: 12px; box-shadow: 0 0 50px rgba(0,0,0,0.6); border: 1px solid #334155; } 
        }

        /* --- SCENE --- */
        .scene { display: none; width: 100%; height: 100%; position: absolute; inset: 0; flex-direction: column; align-items: center; justify-content: center; }
        .scene.active { display: flex; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- ASSETS --- */
        .hallway-bg { position: absolute; inset: 0; z-index: 0; background: linear-gradient(to bottom, #f1f5f9 0%, #cbd5e1 50%, #94a3b8 100%); }
        /* Floor raised to 25% */
        .hallway-floor { position: absolute; bottom: 0; width: 100%; height: 25%; z-index: 5; background: radial-gradient(circle at 50% 0%, #475569 0%, #1e293b 80%); border-top: 8px solid #334155; box-shadow: inset 0 10px 50px rgba(0,0,0,0.5); }
        .hallway-ceiling { position: absolute; top: 0; width: 100%; height: 10%; z-index: 5; background: linear-gradient(to bottom, #ffffff, #e2e8f0); box-shadow: 0 5px 20px rgba(0,0,0,0.05); }

        /* Elevator */
        .elevator-frame-real {
            position: absolute; bottom: 25%; left: 50%; transform: translateX(-50%);
            width: min(400px, 60vw); height: 60%; z-index: 10;
            background: linear-gradient(90deg, #94a3b8, #cbd5e1, #94a3b8);
            border: 2px solid #64748b; border-top: 15px solid #475569; border-left: 20px solid #64748b; border-right: 20px solid #64748b;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6), inset 0 0 20px rgba(0,0,0,0.1);
            display: flex; align-items: flex-end; justify-content: center;
        }
        .elevator-door { width: 50%; height: 100%; background: linear-gradient(90deg, #e2e8f0, #cbd5e1 40%, #94a3b8); border: 1px solid #94a3b8; transition: transform 0.1s; position: relative; box-shadow: inset 2px 0 5px rgba(255,255,255,0.5); }
        .digital-display { position: absolute; top: -50px; left: 50%; transform: translateX(-50%); background: #000; padding: 5px 20px; border-radius: 4px; border: 4px solid #334155; box-shadow: 0 5px 15px rgba(0,0,0,0.4); z-index: 15; display: flex; gap: 10px; align-items: center; }
        .led-text { font-family: 'Orbitron', monospace; color: #ef4444; font-size: 18px; letter-spacing: 1px; text-shadow: 0 0 5px #ef4444; }

        /* --- PASSENGERS (Fixed Position) --- */
        #passengers { 
            position: absolute; 
            bottom: 30%; /* Lifted up from bottom 10px to 30% so they are visible */
            left: 50%; transform: translateX(-50%) scale(0); 
            display: flex; gap: 5px; z-index: 15; 
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        #passengers.safe { 
            transform: translateX(-50%) scale(1.2); /* Scale up, remove translateY push down */
            opacity: 1; transition: all 1s; 
        }
        .person { font-size: 4rem; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5)); }

        /* --- SIGNAGE --- */
        .wall-sign {
            position: absolute; top: 40%; z-index: 8; padding: 10px 14px; border-radius: 8px; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15); border: 3px solid white; min-width: 90px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; transition: transform 0.2s;
        }
        .wall-sign:active { transform: scale(0.95); }
        .sign-left { left: 5%; background: #2563eb; color: white; transform: translateY(-50%); }
        .sign-right { right: 5%; top: 30%; background: #16a34a; color: white; transform: translateY(-50%); }
        .sign-arrow { font-size: 20px; margin-bottom: 4px; }
        .sign-text { font-size: 11px; font-weight: bold; text-transform: uppercase; line-height: 1.2; }

        /* --- INTERACTIVE --- */
        .drop-zone { transition: all 0.2s; cursor: pointer; }
        .drop-zone.hint { border-color: #fbbf24; background: rgba(251,191,36,0.15); animation: pulse 1s infinite; }
        .drop-zone.hover { border-color: #22c55e; background: rgba(34,197,94,0.3); transform: scale(1.05); }
        @keyframes pulse { 50% { border-color: rgba(251,191,36,0.6); box-shadow: 0 0 15px rgba(251,191,36,0.2); } }
        .drag-ghost { position: fixed; width: 64px; height: 64px; pointer-events: none; z-index: 9999; background: rgba(30,41,59,0.95); border: 2px solid #fbbf24; border-radius: 12px; display: flex; align-items: center; justify-content: center; transform: translate(-50%, -50%); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }

        /* --- DECOR --- */
        .call-panel { position: absolute; right: -50px; top: 50%; transform: translateY(-50%); background: #cbd5e1; padding: 10px 5px; border-radius: 6px; border: 1px solid #94a3b8; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 5px; }
        .call-btn { width: 28px; height: 28px; background: #fff; border: 1px solid #cbd5e1; display: flex; align-items: center; justify-content: center; border-radius: 50%; color: #94a3b8; font-size: 10px; box-shadow: inset 0 -2px 2px rgba(0,0,0,0.1); }
        .call-btn.active { color: #ef4444; border-color: #ef4444; background: #fee2e2; box-shadow: 0 0 8px rgba(239,68,68,0.4); }
        .floor-sign { position: absolute; top: 15%; right: 15%; background: #1e293b; color: white; padding: 10px 20px; border-radius: 8px; font-family: 'Orbitron', monospace; font-size: 32px; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.2); border: 2px solid #475569; z-index: 5; }
        .phone-box { position: absolute; top: 40%; left: 20%; width: 50px; height: 70px; background: #e2e8f0; border: 2px solid #94a3b8; border-radius: 8px; box-shadow: 2px 5px 10px rgba(0,0,0,0.3); z-index: 15; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s; transform: translateY(-50%); }
        .phone-box:hover { transform: translateY(-50%) scale(1.05); border-color: #ef4444; }
        .cabinet-box { position: absolute; top: 40%; left: 15%; width: 50px; height: 80px; background: #94a3b8; border: 2px solid #475569; border-radius: 4px; box-shadow: 5px 5px 15px rgba(0,0,0,0.3); z-index: 15; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s; transform: translateY(-50%); }
        .cabinet-box:hover { transform: translateY(-50%) scale(1.05); border-color: #fbbf24; }

    </style>
</head>
<body>

<div id="game-window">

    <!-- HEADER -->
    <header class="h-14 bg-slate-900 border-b border-slate-700 flex items-center justify-between px-4 shrink-0 z-50">
        <div class="flex items-center gap-3">
            <div>
                <div class="text-[8px] text-slate-400 uppercase leading-none font-bold">Location</div>
                <div id="header-loc" class="text-yellow-400 font-bold text-xs truncate w-32">‡πÇ‡∏ñ‡∏á‡∏•‡∏¥‡∏ü‡∏ï‡πå ‡∏ä‡∏±‡πâ‡∏ô 1</div>
            </div>
        </div>
        <div class="text-right">
            <div id="status-badge" class="bg-red-600 text-white text-[8px] font-bold px-2 py-0.5 rounded inline-block animate-pulse">EMERGENCY</div>
            <div id="timer" class="text-white font-mono text-lg font-bold leading-none mt-0.5">00:00</div>
        </div>
    </header>

    <!-- CONTENT -->
    <div class="flex-1 relative overflow-hidden bg-slate-300">

        <!-- 1. TOOLS ROOM -->
        <div id="scene-tools" class="scene bg-slate-900 justify-start pt-6">
            <div class="w-full px-8 mb-4 flex justify-between items-center z-10">
                <h2 class="text-white font-bold text-2xl"><i class="fa-solid fa-warehouse text-yellow-400 mr-3"></i>‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
                <span class="text-xs text-slate-400 bg-slate-800 px-3 py-1 rounded-full"><i class="fa-solid fa-circle-info mr-1"></i>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô</span>
            </div>
            <div id="tools-grid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-7 gap-4 p-8 w-full overflow-y-auto custom-scroll"></div>
            <button onclick="goToFloor(1)" class="absolute bottom-8 left-8 bg-blue-600 text-white px-6 py-3 rounded-full font-bold shadow-lg flex items-center gap-2 hover:bg-blue-500 active:scale-95 z-30 transition">
                <i class="fa-solid fa-door-open"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÇ‡∏ñ‡∏á‡∏ä‡∏±‡πâ‡∏ô 1
            </button>
        </div>

        <!-- 2. CABINET ZOOM (Floor 20) -->
        <div id="scene-cabinet-zoom" class="scene bg-slate-800">
            <div class="relative w-80 max-h-[80%] aspect-[3/5] bg-slate-200 rounded-lg shadow-2xl border-4 border-slate-500">
                <div class="absolute inset-0 p-6 flex flex-col items-center pt-8">
                    <div class="text-xs font-bold text-slate-500 mb-6 bg-white/50 px-3 py-1 rounded">MRL BREAKER</div>
                    <div id="breaker" onclick="toggleBreaker()" class="w-20 h-28 bg-red-600 rounded border-b-8 border-red-800 hover:brightness-110 active:scale-95 transition-transform cursor-pointer shadow-xl"></div>
                    <div id="breaker-status" class="mt-6 text-2xl font-bold text-red-600">ON</div>
                    <div id="zone-sign" class="drop-zone w-full h-16 mt-auto border-2 border-dashed border-slate-400 rounded-lg flex items-center justify-center text-xs text-slate-400 transition" data-accept="sign">‡∏ß‡∏≤‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
                </div>
                <div id="cabinet-door" onclick="toggleCabinet()" class="absolute inset-0 bg-slate-300 border-r-4 border-slate-400 transition-transform duration-500 origin-left z-10 flex flex-col items-center justify-center cursor-pointer shadow-xl group">
                    <div class="border-2 border-slate-500 p-3 font-bold text-slate-600 tracking-widest bg-slate-100 mb-8">INSPECTION</div>
                    <div id="zone-key-insp" class="drop-zone w-20 h-20 rounded-full bg-slate-200 border-4 border-slate-400 flex items-center justify-center shadow-inner group-hover:border-slate-500" data-accept="key_insp">
                        <div class="w-2 h-8 bg-slate-700 rounded-full"></div>
                    </div>
                    <div id="cab-lock-status" class="mt-4 text-red-600 font-bold text-sm bg-red-100 px-2 rounded">LOCKED</div>
                </div>
            </div>
            <button onclick="travel('landing')" class="absolute bottom-4 left-4 bg-white text-slate-800 px-4 py-2 rounded-full font-bold shadow-lg flex items-center gap-2 hover:bg-slate-100 active:scale-95 z-30 text-sm">
                <i class="fa-solid fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÇ‡∏ñ‡∏á‡∏•‡∏¥‡∏ü‡∏ï‡πå
            </button>
        </div>

        <!-- 3. REALISTIC LANDING (FLOOR 1-20) -->
        <div id="scene-landing" class="scene bg-slate-100">
            <div class="hallway-bg"></div>
            <div class="hallway-ceiling"></div>
            <div class="hallway-floor"></div>
            <div class="floor-sign"><span id="landing-num">1</span></div>

            <div class="elevator-frame-real">
                <div class="digital-display">
                    <span class="text-[8px] text-slate-500 font-bold tracking-widest">STATUS</span>
                    <span class="led-text animate-pulse">EMERGENCY</span>
                </div>
                <div class="call-panel">
                    <div id="btn-up" class="call-btn"><i class="fa-solid fa-chevron-up"></i></div>
                    <div id="btn-down" class="call-btn"><i class="fa-solid fa-chevron-down"></i></div>
                </div>
                <!-- SHAFT VIEW -->
                <div id="shaft-view" class="absolute inset-0 bg-black flex items-center justify-center hidden" style="width: 90%; left: 5%;">
                    <div class="w-[90%] h-full bg-slate-600 border-x border-slate-500 relative flex flex-col items-center justify-end pb-4 overflow-hidden">
                        <!-- Passengers -->
                        <div id="passengers" class="flex items-end scale-0 origin-bottom transition-all duration-700">
                            <span class="person">üë©‚Äçüíº</span><span class="person">üë®‚Äçüîß</span><span class="person">üëµ</span>
                        </div>
                        <div class="absolute bottom-2 w-full text-center text-[8px] text-white bg-black/50 py-1 font-bold">LIFT CAR</div>
                    </div>
                </div>
                <div id="door-l" class="elevator-door border-r border-slate-400 z-20"></div>
                <div id="door-r" class="elevator-door border-l border-slate-400 z-20">
                    <div id="zone-key-door" class="drop-zone absolute top-1/2 left-2 w-10 h-10 rounded-full bg-slate-300 border-2 border-slate-400 flex items-center justify-center z-30 shadow-inner hover:bg-white transition" data-accept="key_door">
                        <div class="w-1 h-3 bg-black rounded-full"></div>
                    </div>
                </div>
            </div>

            <!-- Floor 1 Only -->
            <div id="floor1-assets" class="hidden">
                <div onclick="openIntercom()" class="phone-box">
                    <div class="w-8 h-10 bg-red-600 rounded mb-1 flex items-center justify-center shadow-inner"><i class="fa-solid fa-phone text-white text-xs animate-bounce"></i></div>
                    <span class="text-[8px] font-bold text-slate-500">SOS</span>
                </div>
                <div onclick="travel('tools')" class="wall-sign sign-left group bg-white border-2 border-blue-500 text-blue-600">
                    <i class="fa-solid fa-arrow-left sign-arrow"></i><div class="sign-text">‡∏´‡πâ‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á<br>Technician</div>
                </div>
            </div>

            <!-- All Floors -->
            <div onclick="openFloorModal()" class="wall-sign sign-right group bg-white border-2 border-green-500 text-green-600">
                <i class="fa-solid fa-arrow-right sign-arrow"></i><div class="sign-text">‡∏ó‡∏≤‡∏á‡∏´‡∏ô‡∏µ‡πÑ‡∏ü<br>Exit</div>
            </div>

            <!-- Floor 20 Only -->
            <div id="landing-cabinet-20" onclick="travel('cabinet-zoom')" class="cabinet-box hidden">
                <div class="text-[6px] font-bold text-slate-300 mb-1 bg-slate-800 px-1 rounded">INSPEC</div>
                <div class="w-1 h-10 bg-slate-600 rounded shadow-inner"></div>
            </div>

            <!-- Controls (Bottom Right) -->
            <div id="landing-controls" class="absolute bottom-28 right-4 w-72 bg-slate-800/90 backdrop-blur p-4 rounded-xl border border-slate-600 hidden z-30 shadow-2xl">
                <div class="flex justify-between text-white text-sm mb-3 font-bold">
                    <span>‡∏£‡∏∞‡∏¢‡∏∞: <span id="door-val" class="text-yellow-400">0</span> cm</span>
                    <button onclick="toggleFlashlight()" class="text-yellow-400 hover:text-white transition"><i class="fa-solid fa-flashlight mr-1"></i> ‡πÑ‡∏ü‡∏â‡∏≤‡∏¢</button>
                </div>
                <input type="range" id="door-slider" class="w-full h-6 bg-slate-600 rounded-lg appearance-none cursor-pointer mb-2 accent-yellow-500" min="0" max="100" value="0" oninput="updateDoor(this.value)">
                <div class="flex justify-between text-[10px] text-slate-400 mb-4 px-1"><span>0</span><span>15(‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢)</span><span>100(‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏∏‡∏î)</span></div>
                <div class="flex gap-3">
                    <button onclick="attemptRescue()" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-500 active:scale-95 transition shadow-lg text-sm">‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</button>
                    <button onclick="exitFloor()" class="flex-1 bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-500 active:scale-95 transition shadow-lg text-sm">‡∏õ‡∏¥‡∏î/‡∏≠‡∏≠‡∏Å</button>
                </div>
            </div>
            
            <div id="flashlight-beam" class="absolute w-96 h-96 bg-[radial-gradient(circle,rgba(255,255,255,0.3)_0%,transparent_70%)] pointer-events-none opacity-0 transform -translate-x-1/2 -translate-y-1/2 z-20 mix-blend-screen"></div>
        </div>

    </div>

    <!-- INVENTORY BAR -->
    <div class="h-24 bg-slate-950 border-t border-slate-800 flex items-center px-4 gap-4 shrink-0 z-40 shadow-[0_-5px_20px_rgba(0,0,0,0.5)]">
        <div class="text-xs text-slate-500 font-bold w-16 text-center leading-tight bg-slate-900 p-2 rounded border border-slate-800">BAG<br><span id="bag-txt-btm" class="text-white text-sm">0/6</span></div>
        <div id="inv-slots" class="flex-1 flex items-center gap-3 overflow-x-auto h-full py-2 custom-scroll"></div>
    </div>

    <!-- MODALS -->
    <!-- Summary Modal -->
    <div id="summary-modal" class="fixed inset-0 bg-black/95 z-[500] hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 p-8 rounded-2xl w-full max-w-md border shadow-2xl text-center">
            <div id="sum-icon" class="text-6xl mb-4"></div>
            <h2 id="sum-title" class="text-2xl font-bold mb-2"></h2>
            <p id="sum-desc" class="text-slate-400 text-sm mb-6"></p>
            <div id="sum-audit" class="bg-slate-900 p-4 rounded-lg text-left text-sm text-slate-300 mb-6 hidden">
                <h4 class="font-bold text-white border-b border-slate-700 pb-2 mb-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (Audit Log):</h4>
                <ul id="sum-list" class="list-disc pl-5 space-y-1 text-xs"></ul>
            </div>
            <button onclick="location.reload()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold transition">‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
        </div>
    </div>

    <div id="floor-modal" class="fixed inset-0 bg-black/90 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-slate-800 p-8 rounded-2xl w-full max-w-md border border-slate-600 shadow-2xl">
            <h2 class="text-2xl text-white font-bold mb-6 flex items-center gap-3"><i class="fa-solid fa-stairs text-green-500"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô</h2>
            <div id="floor-grid" class="grid grid-cols-5 gap-3 mb-8 max-h-[60vh] overflow-y-auto custom-scroll pr-2"></div>
            <button onclick="closeFloorModal()" class="w-full py-4 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-bold transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>

    <div id="intercom-modal" class="fixed inset-0 bg-black/80 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-slate-800 p-6 rounded-2xl w-full max-w-md border border-slate-600 shadow-2xl">
            <h3 class="text-yellow-400 font-bold mb-6 pb-2 border-b border-slate-700"><i class="fa-solid fa-phone animate-pulse"></i> ‡∏™‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤</h3>
            <div id="dia-text" class="text-slate-200 text-sm mb-6 bg-slate-900 p-4 rounded-lg min-h-[80px]">...</div>
            <div id="dia-btns" class="flex flex-col gap-3"></div>
        </div>
    </div>

    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full font-bold shadow-2xl border border-slate-600 transform -translate-y-40 transition-transform duration-300 z-[200] flex items-center gap-3 pointer-events-none w-max">
        <i class="fa-solid fa-circle-info text-blue-400"></i> <span id="toast-msg">Alert</span>
    </div>

    <script>
        const TOOLS = [
            { id: 'key_insp', name: '‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏ï‡∏π‡πâ‡πÑ‡∏ü', icon: 'fa-key', color: 'text-yellow-400' },
            { id: 'key_door', name: '‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏•‡∏¥‡∏ü‡∏ï‡πå', icon: 'fa-key', color: 'text-slate-300' },
            { id: 'sign', name: '‡∏õ‡πâ‡∏≤‡∏¢‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', icon: 'fa-triangle-exclamation', color: 'text-red-500' },
            { id: 'meds', name: '‡∏¢‡∏≤‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•', icon: 'fa-kit-medical', color: 'text-green-500' },
            { id: 'light', name: '‡πÑ‡∏ü‡∏â‡∏≤‡∏¢', icon: 'fa-lightbulb', color: 'text-yellow-300' },
            { id: 'ladder', name: '‡∏ö‡∏±‡∏ô‡πÑ‡∏î‡∏û‡∏±‡∏ö', icon: 'fa-ladder-water', color: 'text-orange-300' },
            { id: 'hammer', name: '‡∏Ñ‡πâ‡∏≠‡∏ô', icon: 'fa-hammer', color: 'text-gray-400' },
            { id: 'wrench', name: '‡∏õ‡∏£‡∏∞‡πÅ‡∏à', icon: 'fa-wrench', color: 'text-blue-400' },
            { id: 'saw', name: '‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏¢', icon: 'fa-lines-leaning', color: 'text-orange-500' },
            { id: 'oil', name: '‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô', icon: 'fa-oil-can', color: 'text-yellow-600' },
            { id: 'tape', name: '‡πÄ‡∏ó‡∏õ‡∏î‡∏≥', icon: 'fa-tape', color: 'text-gray-500' },
            { id: 'pliers', name: '‡∏Ñ‡∏µ‡∏°', icon: 'fa-scissors', color: 'text-red-400', style:'transform:rotate(90deg)' }
        ];

        let state = {
            time: 0, loc: 'landing', inv: [], target: Math.floor(Math.random() * 18) + 2, currFloor: 1, prevLoc: 'landing',
            flags: { cabUnlock: false, cabOpen: false, powerOff: false, sign: false, cabClosed: false, doorUnlock: false, light: false, peopleRescued: false, talkIntercom: false, floorKnown: false, isFainting: false, medsGiven: false },
            audit: []
        };
        let selectedItem = null;

        window.onload = () => {
            // Randomize fainting event at start
            state.flags.isFainting = Math.random() > 0.5; // 50% chance
            
            setInterval(() => { state.time++; updateUI(); }, 1000);
            renderTools(); renderInv(); goToFloor(1);
        };

        function updateUI() {
            const m = Math.floor(state.time/60).toString().padStart(2,'0');
            const s = (state.time%60).toString().padStart(2,'0');
            document.getElementById('timer').innerText = `${m}:${s}`;
            let locName = "";
            if (state.loc === 'tools') locName = "‡∏´‡πâ‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á ‡∏ä‡∏±‡πâ‡∏ô 1";
            else if (state.loc === 'cabinet-zoom') locName = "‡∏ï‡∏π‡πâ Inspection ‡∏ä‡∏±‡πâ‡∏ô 20";
            else locName = `‡πÇ‡∏ñ‡∏á‡∏•‡∏¥‡∏ü‡∏ï‡πå ‡∏ä‡∏±‡πâ‡∏ô ${state.currFloor}`;
            document.getElementById('header-loc').innerText = locName;
            document.getElementById('bag-txt-btm').innerText = `${state.inv.length}/6`;
            
            // Check Win Condition
            const medsCheck = state.flags.isFainting ? state.flags.medsGiven : true;
            if (state.flags.peopleRescued && medsCheck && !state.flags.powerOff && !state.flags.sign && state.flags.cabClosed && state.inv.length === 0 && document.getElementById('summary-modal').classList.contains('hidden')) {
                finishGame(true, "MISSION COMPLETE!");
            }
        }

        function finishGame(win, title) {
            const modal = document.getElementById('summary-modal');
            const icon = document.getElementById('sum-icon');
            const tit = document.getElementById('sum-title');
            const desc = document.getElementById('sum-desc');
            const auditBox = document.getElementById('sum-audit');
            const list = document.getElementById('sum-list');

            modal.classList.remove('hidden');
            tit.innerText = title;
            auditBox.classList.remove('hidden');
            list.innerHTML = '';

            if (!state.flags.talkIntercom) list.innerHTML += `<li class="text-red-400">‡∏•‡∏∑‡∏°‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢/‡∏Ñ‡∏∏‡∏¢‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡∏ä‡∏±‡πâ‡∏ô 1</li>`;
            else list.innerHTML += `<li class="text-green-400">‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</li>`;

            if (state.flags.isFainting && !state.flags.medsGiven) list.innerHTML += `<li class="text-red-400">‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏° ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</li>`;

            if (state.flags.powerOff) list.innerHTML += `<li class="text-red-400">‡∏•‡∏∑‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü (Breaker ON) ‡∏Ñ‡∏∑‡∏ô</li>`;
            if (state.flags.sign) list.innerHTML += `<li class="text-red-400">‡∏•‡∏∑‡∏°‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤</li>`;
            if (!state.flags.cabClosed) list.innerHTML += `<li class="text-red-400">‡∏•‡∏∑‡∏°‡∏õ‡∏¥‡∏î‡∏ï‡∏π‡πâ Inspection</li>`;
            if (state.inv.length > 0) list.innerHTML += `<li class="text-red-400">‡∏•‡∏∑‡∏°‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (${state.inv.length} ‡∏ä‡∏¥‡πâ‡∏ô)</li>`;

            if (win) {
                icon.innerHTML = 'üèÜ';
                tit.className = "text-2xl font-bold mb-2 text-green-500";
                desc.innerText = `‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô: ${document.getElementById('timer').innerText} ‡∏ô‡∏≤‡∏ó‡∏µ\n‡∏Ñ‡∏∏‡∏ì‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏Ñ‡∏ô‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`;
                modal.classList.add('border-green-500');
            } else {
                icon.innerHTML = 'üíÄ';
                tit.className = "text-2xl font-bold mb-2 text-red-500";
                desc.innerText = "‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß! ‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á";
                modal.classList.add('border-red-500');
            }
        }

        function toast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.style.transform = 'translate(-50%, 0)';
            setTimeout(() => t.style.transform = 'translate(-50%, -150px)', 2500);
        }

        function travel(dest) {
            if (state.loc === 'cabinet-zoom' && dest !== 'cabinet-zoom') {
                if (state.flags.peopleRescued) {
                    if (state.flags.powerOff) { alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏±‡∏ö‡πÑ‡∏ü‡∏Ç‡∏∂‡πâ‡∏ô (ON)!"); return; }
                    if (state.flags.sign) { alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏≠‡∏≤‡∏õ‡πâ‡∏≤‡∏¢‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å!"); return; }
                    if (!state.flags.cabClosed) { alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏¥‡∏î‡∏ï‡∏π‡πâ!"); return; }
                } else {
                    if (state.flags.powerOff && !state.flags.sign) { finishGame(false, "‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏•‡∏±‡∏î‡∏ß‡∏á‡∏à‡∏£! (‡∏ï‡∏±‡∏î‡πÑ‡∏ü‡πÑ‡∏°‡πà‡πÅ‡∏Ç‡∏ß‡∏ô‡∏õ‡πâ‡∏≤‡∏¢)"); return; }
                    if (state.flags.powerOff && state.flags.sign && !state.flags.cabClosed) { finishGame(false, "‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢! ‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î‡∏ï‡∏π‡πâ‡πÑ‡∏ü"); return; }
                }
            }

            if (dest === 'cabinet-zoom') state.prevLoc = state.loc; 

            state.loc = dest;
            document.querySelectorAll('.scene').forEach(s => s.classList.remove('active'));
            document.getElementById(`scene-${dest}`).classList.add('active');
            selectedItem = null; renderInv();
        }

        function openFloorModal() {
            const g = document.getElementById('floor-grid');
            g.innerHTML = '';
            for(let i=20; i>=1; i--) g.appendChild(mkBtn(i));
            document.getElementById('floor-modal').classList.remove('hidden');
        }
        function closeFloorModal() { document.getElementById('floor-modal').classList.add('hidden'); }
        function mkBtn(fl) {
            const b = document.createElement('button');
            let cls = 'bg-slate-700 hover:bg-slate-600';
            if (fl === 1) cls = 'bg-blue-900 hover:bg-blue-800 border-blue-700';
            if (fl === 20) cls = 'bg-purple-900 hover:bg-purple-800 border-purple-700';
            b.className = `p-4 rounded-xl font-bold text-white border shadow-md transition transform active:scale-95 ${cls}`;
            b.innerText = fl;
            b.onclick = () => goToFloor(fl);
            return b;
        }
        function goToFloor(fl) {
            closeFloorModal();
            state.currFloor = fl;
            travel('landing'); 
            setupLanding(fl);
        }

        function renderTools() {
            const g = document.getElementById('tools-grid');
            g.innerHTML = '';
            TOOLS.forEach(t => {
                const div = document.createElement('div');
                const has = state.inv.find(i=>i.id===t.id);
                div.className = `w-full aspect-square bg-slate-800 border-2 border-slate-600 rounded-xl flex flex-col items-center justify-center transition hover:border-yellow-400 hover:bg-slate-700 cursor-pointer ${has ? 'opacity-30 pointer-events-none' : ''}`;
                div.onclick = () => pickItem(t);
                div.innerHTML = `<i class="fa-solid ${t.icon} text-3xl ${t.color} mb-2"></i><span class="text-[10px] text-slate-300 text-center leading-none">${t.name}</span>`;
                g.appendChild(div);
            });
        }

        function renderInv() {
            const b = document.getElementById('inv-slots');
            b.innerHTML = '';
            state.inv.forEach(item => {
                const div = document.createElement('div');
                const isSel = selectedItem === item.id;
                div.className = `w-12 h-12 bg-slate-800 border-2 rounded-lg flex flex-col items-center justify-center shrink-0 relative transition cursor-pointer hover:bg-slate-700 ${isSel ? 'border-yellow-400 bg-slate-700 shadow-[0_0_15px_rgba(250,204,21,0.3)]' : 'border-slate-600'}`;
                if (state.loc === 'tools') {
                    div.innerHTML += `<div class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full flex items-center justify-center text-white text-[8px] shadow-md border border-slate-900"><i class="fa-solid fa-xmark"></i></div>`;
                    div.onclick = () => returnItem(item.id);
                } else {
                    div.onclick = () => selectItem(item.id);
                }
                div.innerHTML += `<i class="fa-solid ${item.icon} text-lg ${item.color} pointer-events-none drop-shadow-md" style="${item.style||''}"></i>`;
                div.addEventListener('touchstart', (e) => startDrag(e, item), {passive: false});
                div.addEventListener('mousedown', (e) => startDrag(e, item));
                b.appendChild(div);
            });
        }

        function pickItem(t) { if(state.inv.length>=6) return toast('‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏ï‡πá‡∏°!'); state.inv.push(t); renderTools(); renderInv(); toast(`‡πÄ‡∏Å‡πá‡∏ö ${t.name}`); }
        function returnItem(id) { state.inv = state.inv.filter(i=>i.id!==id); renderTools(); renderInv(); }
        function selectItem(id) {
            selectedItem = (selectedItem === id) ? null : id;
            renderInv();
            document.querySelectorAll('.drop-zone').forEach(z => {
                if(selectedItem && z.dataset.accept === selectedItem) z.classList.add('hint'); else z.classList.remove('hint');
            });
        }

        document.querySelectorAll('.drop-zone').forEach(z => {
            z.onclick = () => {
                if (z.id === 'zone-sign' && state.flags.sign && !state.flags.powerOff) { 
                    alert("‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü (ON) ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏≠‡∏≤‡∏õ‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å!"); 
                    return; 
                }
                if (z.id === 'zone-sign' && state.flags.sign) {
                    state.flags.sign = false;
                    z.innerHTML = '‡∏ß‡∏≤‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô';
                    z.className = "drop-zone w-full h-16 mt-auto border-2 border-dashed border-slate-400 rounded-lg flex items-center justify-center text-xs text-slate-400 transition";
                    if(state.inv.length < 6) {
                        state.inv.push(TOOLS.find(t=>t.id==='sign'));
                        renderTools(); renderInv();
                        toast('‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
                    } else {
                        alert("‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏ï‡πá‡∏°! ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô");
                        state.flags.sign = true; 
                    }
                    return;
                }

                if(selectedItem && z.dataset.accept === selectedItem) { handleAction(z.dataset.accept); selectedItem = null; renderInv(); } 
                else if(selectedItem) toast('‡πÉ‡∏ä‡πâ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ú‡∏¥‡∏î‡∏ó‡∏µ‡πà');
            };
        });

        function handleAction(type) {
            if (type === 'key_insp') {
                state.flags.cabUnlock = true;
                document.getElementById('zone-key-insp').style.display = 'none';
                document.getElementById('cab-lock-status').innerText = 'UNLOCKED';
                document.getElementById('cab-lock-status').className = 'mt-4 text-green-500 font-bold text-sm bg-green-100 px-2 rounded';
                toast('‡πÑ‡∏Ç‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            } else if (type === 'sign') {
                if(!state.flags.powerOff) return toast('‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢! ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏î‡πÑ‡∏ü‡∏Å‡πà‡∏≠‡∏ô');
                state.flags.sign = true;
                const zone = document.getElementById('zone-sign');
                zone.className = 'w-full h-20 mt-auto border-2 border-red-600 bg-white flex items-center justify-center text-red-600 font-bold shadow-inner cursor-pointer';
                zone.innerText = 'DANGER DO NOT OPERATE (‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö)';
                toast('‡πÅ‡∏Ç‡∏ß‡∏ô‡∏õ‡πâ‡∏≤‡∏¢‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
                state.inv = state.inv.filter(i=>i.id!=='sign');
            } else if (type === 'key_door') {
                state.flags.doorUnlock = true;
                document.getElementById('zone-key-door').style.display = 'none';
                document.getElementById('landing-controls').classList.remove('hidden');
                toast('‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÅ‡∏•‡πâ‡∏ß');
            } else if (type === 'meds' && state.flags.isFainting) {
                state.flags.medsGiven = true;
                document.getElementById('passengers').innerHTML = '<span class="person">üë©‚Äçüíº</span><span class="person text-green-500">üòÄ</span><span class="person">üëµ</span>';
                document.getElementById('status-badge').innerText = "SAFE";
                document.getElementById('status-badge').className = "bg-green-600 text-white text-[8px] font-bold px-2 py-0.5 rounded inline-block";
                toast('‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÅ‡∏•‡πâ‡∏ß! ‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢');
                state.inv = state.inv.filter(i=>i.id!=='meds');
                renderInv();
            }
        }

        function toggleCabinet() {
            if(!state.flags.cabUnlock) return toast('‡∏•‡πá‡∏≠‡∏Ñ‡∏≠‡∏¢‡∏π‡πà ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Å‡∏∏‡∏ç‡πÅ‡∏à');
            state.flags.cabOpen = !state.flags.cabOpen;
            document.getElementById('cabinet-door').style.transform = state.flags.cabOpen ? 'perspective(1000px) rotateY(-120deg)' : 'none';
            state.flags.cabClosed = !state.flags.cabOpen;
        }
        function toggleBreaker() {
            state.flags.powerOff = !state.flags.powerOff; // Toggle Value
            
            const b = document.getElementById('breaker');
            const s = document.getElementById('breaker-status');
            
            if(state.flags.powerOff) {
                b.className = 'w-20 h-28 bg-green-600 rounded border-t-8 border-green-800 cursor-pointer transition-transform rotate-180 shadow-inner';
                s.innerText = 'OFF'; 
                s.className = 'mt-6 text-2xl font-bold text-green-600';
            } else {
                b.className = 'w-20 h-28 bg-red-600 rounded border-b-8 border-red-800 cursor-pointer transition-transform shadow-xl';
                s.innerText = 'ON'; 
                s.className = 'mt-6 text-2xl font-bold text-red-600';
            }
        }
        
        function setupLanding(fl) {
            document.getElementById('landing-num').innerText = fl;
            document.getElementById('door-slider').value = 0; updateDoor(0);
            
            const phone = document.getElementById('landing-phone');
            if (phone) phone.style.display = (fl === 1) ? 'flex' : 'none';

            const cab20 = document.getElementById('landing-cabinet-20');
            if (cab20) cab20.style.display = (fl === 20) ? 'flex' : 'none';

            const btnUp = document.getElementById('btn-up');
            const btnDown = document.getElementById('btn-down');
            if (btnUp) btnUp.style.display = (fl === 20) ? 'none' : 'flex';
            if (btnDown) btnDown.style.display = (fl === 1) ? 'none' : 'flex';
            
            const floor1Assets = document.getElementById('floor1-assets');
            if (floor1Assets) floor1Assets.style.display = (fl === 1) ? 'block' : 'none';

            state.flags.doorUnlock = false;
            document.getElementById('zone-key-door').style.display = 'flex';
            document.getElementById('landing-controls').classList.add('hidden');
            
            const shaft = document.getElementById('shaft-view');
            shaft.classList.toggle('hidden', fl !== state.target);
            
            const p = document.getElementById('passengers');
            p.classList.remove('safe');
            p.innerHTML = '<span class="person">üë©‚Äçüíº</span><span class="person">üë®‚Äçüîß</span><span class="person">üëµ</span>';
            p.classList.remove('drop-zone');
            p.onclick = null;
        }

        function updateDoor(v) {
            document.getElementById('door-val').innerText = v;
            const percent = v; 
            document.getElementById('door-l').style.transform = `translateX(-${percent}%)`;
            document.getElementById('door-r').style.transform = `translateX(${percent}%)`;
            
            if (v > 15 && state.currFloor !== state.target) { finishGame(false, "GAME OVER! ‡∏ï‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏•‡∏¥‡∏ü‡∏ï‡πå (‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏¥‡∏ô)"); }
        }

        function toggleFlashlight() {
            if(!state.inv.find(i=>i.id==='light')) return toast('‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏â‡∏≤‡∏¢');
            state.flags.light = !state.flags.light;
            const b = document.getElementById('flashlight-beam');
            b.style.opacity = state.flags.light ? 1 : 0;
            const handler = (e) => {
                const cx = e.touches ? e.touches[0].clientX : e.clientX;
                const cy = e.touches ? e.touches[0].clientY : e.clientY;
                const rect = document.getElementById('scene-landing').getBoundingClientRect();
                b.style.left = (cx - rect.left) + 'px'; b.style.top = (cy - rect.top) + 'px';
            };
            if(state.flags.light) { window.addEventListener('mousemove', handler); window.addEventListener('touchmove', handler); }
            else { window.removeEventListener('mousemove', handler); window.removeEventListener('touchmove', handler); }
        }

        function attemptRescue() {
            if(state.currFloor !== state.target) return toast('‡∏ú‡∏¥‡∏î‡∏ä‡∏±‡πâ‡∏ô!');
            if(!state.flags.powerOff) { finishGame(false, "‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏î‡∏π‡∏î! (‡∏•‡∏∑‡∏°‡∏ï‡∏±‡∏î‡πÑ‡∏ü‡∏Ç‡∏ì‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏ô)"); return; }
            if(document.getElementById('door-slider').value < 60) return toast('‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ (>60cm)');
            
            const p = document.getElementById('passengers');
            p.classList.add('safe');
            state.flags.peopleRescued = true;
            
            if (state.flags.isFainting) {
                p.innerHTML = '<span class="person">üë©‚Äçüíº</span><span class="person text-red-500 animate-pulse">ü§ï</span><span class="person">üëµ</span>';
                document.getElementById('status-badge').className = "bg-orange-500 text-white text-[8px] font-bold px-2 py-0.5 rounded inline-block animate-bounce";
                document.getElementById('status-badge').innerText = "INJURED";
                toast("‡∏°‡∏µ‡∏Ñ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏°! ‡πÉ‡∏ä‡πâ‡∏ä‡∏∏‡∏î‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏î‡πà‡∏ß‡∏ô!");
                
                p.classList.add('drop-zone');
                p.dataset.accept = 'meds';
                p.onclick = () => { if(selectedItem === 'meds') handleAction('meds'); };
            } else {
                document.getElementById('status-badge').className = "bg-green-600 text-white text-[8px] font-bold px-2 py-0.5 rounded inline-block";
                document.getElementById('status-badge').innerText = "SAFE";
                toast("‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢! ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠");
            }
        }

        function exitFloor() {
            if(document.getElementById('door-slider').value > 0) return toast('‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏Å‡πà‡∏≠‡∏ô');
            openFloorModal();
        }

        function openIntercom() { document.getElementById('intercom-modal').classList.remove('hidden'); runDia(1); }
        function runDia(s) {
            const t = document.getElementById('dia-text');
            const b = document.getElementById('dia-btns');
            b.innerHTML = '';
            if(s==1) {
                t.innerText = '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ó‡πà‡∏≤‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡∏Ñ‡∏£‡∏±‡∏ö';
                b.appendChild(mkDiaBtn('‡∏£‡∏≠‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö...', 2));
            } else if(s==2) {
                t.innerText = '‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏Ñ‡πâ‡∏≤‡∏á! ‡πÑ‡∏ü‡∏î‡∏±‡∏ö! ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏ß‡∏¢!';
                const btnA = mkDiaBtn('‡πÉ‡∏à‡πÄ‡∏¢‡πá‡∏ô‡πÜ ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏£‡∏µ‡∏ö‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÇ‡∏î‡∏¢‡∏î‡πà‡∏ß‡∏ô', 3);
                const btnB = mkDiaBtn('‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏Å‡πÉ‡∏à‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö... ‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ß‡πà‡∏≤‡∏ó‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏•‡∏¥‡∏ü‡∏ï‡πå ‡∏à‡∏≤‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÉ‡∏î‡πÑ‡∏õ‡∏ä‡∏±‡πâ‡∏ô‡πÉ‡∏î...', 4);
                b.appendChild(btnA); b.appendChild(btnB);
            } else if(s==3) {
                t.innerText = '‡∏Ñ‡πà‡∏∞ ‡∏£‡∏µ‡∏ö‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞';
                state.flags.floorKnown = false;
                b.appendChild(mkDiaBtn('‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤', 0));
            } else if(s==4) {
                t.innerText = `‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏ä‡∏±‡πâ‡∏ô 1 ‡∏à‡∏∞‡πÑ‡∏õ‡∏ä‡∏±‡πâ‡∏ô ${state.target} ‡∏Ñ‡πà‡∏∞ ‡∏°‡∏µ 3 ‡∏Ñ‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡πÄ‡∏à‡πá‡∏ö‡∏Ñ‡πà‡∏∞`;
                state.flags.floorKnown = true;
                b.appendChild(mkDiaBtn('‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö', 0));
            } else {
                state.flags.talkIntercom = true;
                document.getElementById('intercom-modal').classList.add('hidden');
                if(state.flags.floorKnown) toast(`‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‡∏ä‡∏±‡πâ‡∏ô ${state.target}`);
                else toast(`‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏∏‡πà‡∏°‡∏´‡∏≤)`);
            }
        }
        function mkDiaBtn(txt, next) {
            const btn = document.createElement('button');
            btn.className = 'w-full bg-slate-700 text-white p-4 rounded-lg text-left hover:bg-slate-600 transition';
            btn.innerText = txt;
            btn.onclick = () => runDia(next);
            return btn;
        }

        let ghost = null;
        function startDrag(e, item) {
            if (state.loc === 'tools') return;
            e.preventDefault();
            ghost = document.createElement('div');
            ghost.className = 'drag-ghost';
            ghost.innerHTML = `<i class="fa-solid ${item.icon} text-3xl ${item.color}"></i>`;
            document.body.appendChild(ghost);
            
            const move = (ev) => {
                const cx = ev.touches ? ev.touches[0].clientX : ev.clientX;
                const cy = ev.touches ? ev.touches[0].clientY : ev.clientY;
                ghost.style.left = cx+'px'; ghost.style.top = cy+'px';
                document.querySelectorAll('.drop-zone').forEach(z => {
                    const r = z.getBoundingClientRect();
                    if(cx>=r.left && cx<=r.right && cy>=r.top && cy<=r.bottom) z.classList.add('hover'); else z.classList.remove('hover');
                });
            }
            
            const end = (ev) => {
                const cx = ev.changedTouches ? ev.changedTouches[0].clientX : ev.clientX;
                const cy = ev.changedTouches ? ev.changedTouches[0].clientY : ev.clientY;
                document.querySelectorAll('.drop-zone').forEach(z => {
                    z.classList.remove('hover');
                    const r = z.getBoundingClientRect();
                    if(cx>=r.left && cx<=r.right && cy>=r.top && cy<=r.bottom) {
                        if(z.dataset.accept === item.id) handleAction(item.id); else toast('‡πÉ‡∏ä‡πâ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ú‡∏¥‡∏î‡∏ó‡∏µ‡πà');
                    }
                });
                ghost.remove(); ghost = null;
                window.removeEventListener('touchmove', move); window.removeEventListener('touchend', end);
                window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', end);
            }
            window.addEventListener('touchmove', move, {passive:false}); window.addEventListener('touchend', end);
            window.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
        }
    </script>

</div>
</body>
</html>