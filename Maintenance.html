<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบประเมินผลช่างซ่อมบำรุง</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; overflow-x: hidden; background-color: #0f172a; color: #f8fafc; }
        
        /* Background */
        .animated-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
            background: radial-gradient(circle at 50% 50%, #1e293b 0%, #0f172a 100%);
        }
        .orbs { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; filter: blur(80px); opacity: 0.6; pointer-events: none; }
        .orb { position: absolute; border-radius: 50%; animation: float 20s infinite ease-in-out; }
        .orb-1 { width: 400px; height: 400px; background: #3b82f6; top: -100px; left: -100px; }
        .orb-2 { width: 300px; height: 300px; background: #8b5cf6; bottom: -50px; right: -50px; animation-delay: -5s; }
        @keyframes float { 0%, 100% { transform: translate(0, 0) scale(1); } 50% { transform: translate(30px, -50px) scale(1.1); } }

        /* Glassmorphism */
        .glass-card {
            background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        .glass-input {
            background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.1); color: white;
        }
        .glass-input:focus { border-color: #3b82f6; background: rgba(0, 0, 0, 0.4); outline: none; }
        
        .fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="antialiased">

    <div class="animated-bg"></div>
    <div class="orbs"><div class="orb orb-1"></div><div class="orb orb-2"></div></div>

    <!-- Navbar -->
    <nav id="main-navbar" class="hidden glass-card sticky top-4 mx-4 md:mx-8 rounded-2xl px-6 py-4 justify-between items-center z-50 mb-8 mt-4 transition-all duration-300">
        <div class="flex items-center gap-3 cursor-pointer group" onclick="navigateTo('home')">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white font-bold shadow-lg shadow-blue-500/30 group-hover:scale-110 transition-transform">
                <i data-lucide="wrench" class="w-5 h-5"></i>
            </div>
            <div class="leading-tight">
                <span class="block font-bold text-lg text-white tracking-wide">SkillMatrix<span class="text-blue-400">Pro</span></span>
                <span class="block text-xs font-medium text-slate-400">ระบบประเมินผลช่าง</span>
            </div>
        </div>
        <div class="flex gap-2 text-sm font-medium">
            <button onclick="navigateTo('home')" class="px-4 py-2 rounded-xl text-slate-300 hover:text-white hover:bg-white/10 transition-all" id="nav-home">หน้าหลัก</button>
            <button onclick="navigateTo('dashboard')" class="px-4 py-2 rounded-xl text-slate-300 hover:text-white hover:bg-white/10 transition-all" id="nav-dashboard">รายชื่อ</button>
            <button onclick="navigateTo('compare')" class="px-4 py-2 rounded-xl text-slate-300 hover:text-white hover:bg-white/10 transition-all" id="nav-compare">เปรียบเทียบ</button>
            <button onclick="logout()" class="px-3 py-2 rounded-xl text-red-400 hover:bg-red-500/10 transition-all"><i data-lucide="log-out" class="w-5 h-5"></i></button>
        </div>
    </nav>

    <!-- Content Area -->
    <main id="app-content" class="p-4 md:px-8 max-w-7xl mx-auto min-h-screen pb-20 relative z-10">
        <div class="flex flex-col items-center justify-center h-screen">
            <i data-lucide="loader-2" class="w-10 h-10 animate-spin text-blue-500 mb-4"></i>
            <p class="text-slate-400 animate-pulse">กำลังโหลดข้อมูล...</p>
        </div>
    </main>

    <script>
        // --- 1. CONFIGURATION ---
        const CONFIG = {
            ACCESS_PIN: "1234", 
            STAFF_CSV: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7_f0P5kNKDtPrfGRP4oxezwethRxQLmKZO8JdNanSLr8rGLIaLRqC6n_NZI0UHLd7yK4s4Kvdl8vw/pub?gid=1930878113&single=true&output=csv",
            SKILL_CSV: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7_f0P5kNKDtPrfGRP4oxezwethRxQLmKZO8JdNanSLr8rGLIaLRqC6n_NZI0UHLd7yK4s4Kvdl8vw/pub?gid=2028292203&single=true&output=csv",
            SCRIPT_URL: "https://script.google.com/macros/s/AKfycby7wjApfV3gKgR9dXqZKTgqIkxOq3YlYTzpNGEZqn510R4nvsS2dUoIRVXq91_pknb0tA/exec"
        };

        const ROLE_TARGETS = {
            "Senior Tech": { electrical: 4, mechanical: 4, troubleshooting: 4, safety: 5 },
            "Junior Tech": { electrical: 2, mechanical: 2, troubleshooting: 2, safety: 3 },
            "Technician": { electrical: 3, mechanical: 3, troubleshooting: 3, safety: 4 },
            "Expert/Trainer": { electrical: 5, mechanical: 5, troubleshooting: 5, safety: 5 }
        };

        // --- 2. STATE ---
        let state = {
            technicians: [],
            masterSkills: {
                electrical: { title: "ไฟฟ้า", icon: "zap", color: "text-yellow-400", bg: "bg-yellow-500", items: [] },
                mechanical: { title: "เครื่องกล", icon: "wrench", color: "text-blue-400", bg: "bg-blue-500", items: [] },
                troubleshooting: { title: "วิเคราะห์", icon: "search", color: "text-purple-400", bg: "bg-purple-500", items: [] },
                safety: { title: "ความปลอดภัย", icon: "shield", color: "text-green-400", bg: "bg-green-500", items: [] }
            },
            userSkillsMap: {}, 
            currentView: 'login', 
            selectedTech: null,
            status: 'loading',
            isEditing: false,
            tempSkills: [],
            sortBy: 'score', 
            filterTeam: 'All',
            dashboardTab: 'list', // list, analytics
            profileTab: 'skills',
            // Compare State
            compareTech1: '',
            compareTech2: '',
            selectedTeamsForRadar: [] // Array of team names
        };
        
        // Centralized chart instance storage
        let chartInstances = {
            profileRadar: null,
            teamBar: null,
            teamRadar: null,
            compareRadar: null
        };

        // --- 3. CORE FUNCTIONS ---
        function parseCSV(text) {
            const rows = text.trim().split('\n');
            if (rows.length === 0) return [];
            const headers = rows[0].replace(/^\uFEFF/, '').split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            return rows.slice(1).map(row => {
                const values = []; let inQuote = false; let cur = '';
                for (let i = 0; i < row.length; i++) {
                    const char = row[i];
                    if (char === '"') { inQuote && row[i+1] === '"' ? (cur += '"', i++) : (inQuote = !inQuote); }
                    else if (char === ',' && !inQuote) { values.push(cur.trim()); cur = ''; }
                    else { cur += char; }
                }
                values.push(cur.trim());
                let obj = {};
                headers.forEach((h, i) => { 
                    let val = values[i] || ''; 
                    if (val.startsWith('"') && val.endsWith('"')) val = val.slice(1, -1);
                    obj[h] = val; 
                });
                return obj;
            });
        }

        async function initData() {
            render(); 
            try {
                const [skillRes, staffRes] = await Promise.all([ fetch(CONFIG.SKILL_CSV), fetch(CONFIG.STAFF_CSV) ]);
                const skillRows = parseCSV(await skillRes.text());
                const skills = JSON.parse(JSON.stringify(state.masterSkills)); 

                skillRows.forEach(row => {
                    const code = row['Skill_Code'] || '';
                    const firstChar = code.charAt(0).toUpperCase();
                    let catKey = '';
                    if (firstChar === 'E') catKey = 'electrical';
                    else if (firstChar === 'M') catKey = 'mechanical';
                    else if (firstChar === 'T') catKey = 'troubleshooting';
                    else if (firstChar === 'S') catKey = 'safety';

                    if (catKey && skills[catKey]) {
                        const levelMatch = code.match(/[A-Z](\d+)\./); 
                        skills[catKey].items.push({
                            id: code,
                            level: levelMatch ? parseInt(levelMatch[1]) : 1,
                            text: row['Description'] || '',
                            weight: parseInt(row['Max_Score']) || 1
                        });
                    }
                });

                const staffRows = parseCSV(await staffRes.text());
                const techs = [];
                const userSkills = {};

                staffRows.forEach(row => {
                    const id = row['Tech_ID'];
                    if (!id) return;
                    techs.push({
                        id: id,
                        name: row['Name_TH'] || 'Unknown',
                        team: row['Team'] || row['Team_Zone'] || '-',
                        position: row['Position'] || 'Technician',
                        avatar: `bg-gradient-to-br from-slate-700 to-slate-${(id.charCodeAt(id.length-1)%9)*100}` 
                    });
                    const mySkills = [];
                    Object.keys(row).forEach(key => {
                        if (/^[A-Z]\d+\.\d+$/.test(key) && row[key]?.toUpperCase() === 'TRUE') {
                            mySkills.push(key);
                        }
                    });
                    userSkills[id] = mySkills;
                });

                state.technicians = techs;
                state.masterSkills = skills;
                state.userSkillsMap = userSkills;
                state.status = 'online';
                
                // Initialize selection
                const teams = [...new Set(techs.map(t => t.team))];
                state.selectedTeamsForRadar = teams.slice(0, Math.min(3, teams.length));
                if(techs.length > 1) { state.compareTech1 = techs[0].id; state.compareTech2 = techs[1].id; }

                if(state.currentView !== 'login') render();

            } catch (err) {
                console.error(err);
                state.status = 'offline';
            }
        }

        function calculateAllScores(skillsList) {
            const scores = { total: 0 };
            ['electrical', 'mechanical', 'troubleshooting', 'safety'].forEach(key => {
                const cat = state.masterSkills[key];
                if (!cat) return;
                const totalW = cat.items.reduce((s, i) => s + i.weight, 0);
                const userW = cat.items.reduce((s, i) => skillsList.includes(i.id) ? s + i.weight : s, 0);
                scores[key] = {
                    raw: userW, total: totalW,
                    percentage: totalW===0?0:Math.round((userW/totalW)*100),
                    normalized: totalW===0?0:(userW/totalW)*5
                };
                scores.total += userW;
            });
            scores.overallPercent = Math.round((scores.electrical.percentage + scores.mechanical.percentage + scores.troubleshooting.percentage + scores.safety.percentage)/4);
            return scores;
        }

        // --- 4. RENDER VIEWS ---

        function render() {
            const app = document.getElementById('app-content');
            const navbar = document.getElementById('main-navbar');
            const navHome = document.getElementById('nav-home');
            const navDash = document.getElementById('nav-dashboard');
            const navCompare = document.getElementById('nav-compare');

            if (state.currentView === 'login') {
                navbar.classList.add('hidden'); navbar.classList.remove('flex');
                app.innerHTML = renderLogin();
            } else {
                navbar.classList.remove('hidden'); navbar.classList.add('flex');
                const active = "bg-blue-600 text-white shadow-lg shadow-blue-500/40";
                const inactive = "text-slate-400 hover:text-white hover:bg-white/10";
                
                navHome.className = `px-4 py-2 rounded-xl transition-all duration-300 font-bold ${state.currentView === 'home' ? active : inactive}`;
                navDash.className = `px-4 py-2 rounded-xl transition-all duration-300 font-bold ${state.currentView === 'dashboard' ? active : inactive}`;
                navCompare.className = `px-4 py-2 rounded-xl transition-all duration-300 font-bold ${state.currentView === 'compare' ? active : inactive}`;

                if (state.currentView === 'home') app.innerHTML = renderHome();
                else if (state.currentView === 'dashboard') {
                    app.innerHTML = renderDashboard();
                    if(state.dashboardTab === 'analytics') {
                        setTimeout(() => { renderAllTeamsBar(); renderTeamRadar(); }, 100);
                    }
                } else if (state.currentView === 'profile') {
                    app.innerHTML = renderProfile();
                    if(state.profileTab === 'skills') renderChart();
                } else if (state.currentView === 'compare') {
                    app.innerHTML = renderCompare();
                    renderCompareChart();
                }
            }
            lucide.createIcons();
        }

        function renderLogin() {
            return `
                <div class="flex flex-col items-center justify-center min-h-[80vh] fade-in">
                    <div class="glass-card p-10 rounded-[2rem] w-full max-w-sm text-center relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
                        <div class="mb-8 inline-flex p-5 rounded-2xl bg-white/5 border border-white/10 shadow-inner"><i data-lucide="lock" class="w-10 h-10 text-blue-400"></i></div>
                        <h2 class="text-3xl font-bold text-white mb-2">เข้าสู่ระบบ</h2>
                        <div class="space-y-6 mt-8">
                            <input type="password" id="pin-input" maxlength="6" class="w-full text-center text-4xl font-bold tracking-[0.5em] py-4 rounded-xl border border-white/10 bg-black/20 focus:ring-2 focus:ring-blue-500 outline-none text-white placeholder:text-white/10 transition-all focus:bg-black/40" placeholder="••••" onkeyup="checkEnter(event)" autofocus>
                            <button onclick="handleLogin()" class="w-full py-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-bold text-lg hover:shadow-lg transition-all transform active:scale-95">Access System</button>
                        </div>
                        <div id="login-msg" class="h-6 mt-6 text-xs font-bold text-red-400 opacity-0 transition-opacity">รหัสผ่านไม่ถูกต้อง</div>
                    </div>
                </div>`;
        }

        function renderHome() {
            const isOnline = state.status === 'online';
            return `
                <div class="flex flex-col items-center justify-center min-h-[70vh] text-center fade-in">
                    <div class="relative mb-10"><div class="absolute -inset-1 bg-gradient-to-r from-blue-600 to-purple-600 rounded-full blur opacity-40"></div><div class="relative w-32 h-32 glass-card rounded-full flex items-center justify-center"><i data-lucide="activity" class="w-14 h-14 text-blue-400"></i></div></div>
                    <h1 class="text-5xl md:text-7xl font-black text-white mb-6">Maintenance <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">Evaluation</span></h1>
                    <p class="text-slate-400 text-xl max-w-2xl mb-12">ระบบประเมินสมรรถนะช่างซ่อมบำรุงระดับสูง <br> <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-green-500/10 border border-green-500/20 text-green-400 text-sm font-bold mt-2"><i data-lucide="check-circle" class="w-4 h-4"></i> Connected (${state.technicians.length} Staffs)</span></p>
                    <div class="flex gap-4">
                        <button onclick="navigateTo('dashboard')" class="px-10 py-4 bg-white text-slate-900 rounded-2xl font-bold text-lg hover:shadow-2xl transition-all hover:-translate-y-1">รายชื่อช่าง</button>
                        <button onclick="navigateTo('compare')" class="px-10 py-4 bg-slate-800 border border-slate-700 text-white rounded-2xl font-bold text-lg hover:bg-slate-700 transition-all hover:-translate-y-1">เปรียบเทียบ</button>
                    </div>
                </div>`;
        }

        function renderDashboard() {
            const isList = state.dashboardTab === 'list';
            const teams = ['All', ...new Set(state.technicians.map(t => t.team))];
            let displayList = state.technicians.filter(t => state.filterTeam === 'All' || t.team === state.filterTeam);
            
            const listWithScores = displayList.map(t => {
                const s = calculateAllScores(state.userSkillsMap[t.id] || []);
                return { ...t, score: s.total, percent: s.overallPercent, details: s };
            });

            if (state.sortBy === 'score') listWithScores.sort((a, b) => b.score - a.score);
            else listWithScores.sort((a, b) => a.name.localeCompare(b.name));

            const listItems = listWithScores.map((tech, index) => {
                let scoreColor = 'text-white bg-slate-700';
                let barColor = 'bg-slate-300';
                if(tech.percent >= 80) { scoreColor = 'text-green-900 bg-green-400'; barColor = 'bg-green-500'; }
                else if(tech.percent >= 60) { scoreColor = 'text-yellow-900 bg-yellow-400'; barColor = 'bg-yellow-500'; }
                else { scoreColor = 'text-red-100 bg-red-600'; barColor = 'bg-red-500'; }

                return `
                <div onclick="selectTech('${tech.id}')" class="glass-card p-5 rounded-2xl cursor-pointer hover:bg-white/5 transition-all duration-300 flex flex-col md:flex-row items-center gap-6 relative overflow-hidden group border-l-4 ${barColor.replace('bg-', 'border-')}">
                    <div class="flex items-center gap-5 w-full md:w-1/3">
                        <div class="w-16 h-16 rounded-2xl ${tech.avatar} flex items-center justify-center text-white font-bold text-2xl shadow-lg border border-white/10 group-hover:scale-110 transition-transform duration-300">${tech.name.charAt(0)}</div>
                        <div><div class="font-bold text-lg text-white group-hover:text-blue-400 transition-colors">${tech.name}</div><div class="text-sm text-slate-400 flex gap-2 mt-1"><span class="bg-white/10 px-2 py-0.5 rounded text-[10px] font-bold uppercase">${tech.team}</span><span>${tech.position}</span></div></div>
                    </div>
                    <div class="flex-1 w-full grid grid-cols-2 md:grid-cols-4 gap-4">
                        ${['electrical', 'mechanical', 'safety', 'troubleshooting'].map(key => `
                            <div class="flex flex-col gap-1.5"><span class="text-[9px] uppercase font-bold text-slate-500 tracking-wider">${key.substring(0,4)}</span><div class="h-1.5 bg-slate-700 rounded-full overflow-hidden"><div class="h-full rounded-full ${state.masterSkills[key]?.bg || 'bg-slate-500'}" style="width: ${tech.details[key].percentage}%"></div></div></div>
                        `).join('')}
                    </div>
                    <div class="flex items-center gap-6 w-full md:w-auto justify-between md:justify-end border-t md:border-t-0 pt-4 md:pt-0 border-white/5">
                        <div class="text-center min-w-[80px]"><div class="text-[9px] text-slate-500 font-bold uppercase mb-1 tracking-wider">Score</div><span class="text-2xl font-black text-white">${tech.score}</span></div>
                        <div class="w-14 h-14 rounded-full ${scoreColor} flex items-center justify-center font-bold text-sm shadow-lg">${tech.percent}%</div>
                    </div>
                </div>`;
            }).join('');

            return `
                <div class="fade-in">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-8">
                        <div><h2 class="text-3xl font-bold text-white">Dashboard</h2><p class="text-slate-400 mt-1 font-medium">จัดการรายชื่อและวิเคราะห์ภาพรวมทีม</p></div>
                        <div class="glass-card p-1 rounded-xl flex gap-1 bg-black/20">
                            <button onclick="switchTab('list')" class="px-5 py-2.5 rounded-lg text-sm font-bold transition-all ${isList ? 'bg-white/10 text-white shadow-lg border border-white/10' : 'text-slate-500 hover:text-white'} flex items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i> รายชื่อ</button>
                            <button onclick="switchTab('analytics')" class="px-5 py-2.5 rounded-lg text-sm font-bold transition-all ${!isList ? 'bg-white/10 text-white shadow-lg border border-white/10' : 'text-slate-500 hover:text-white'} flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-4 h-4"></i> วิเคราะห์</button>
                        </div>
                    </div>
                    
                    ${isList ? `
                        <div class="glass-card p-4 rounded-2xl mb-6 flex flex-col md:flex-row gap-4 items-center border border-white/5">
                            <div class="relative flex-1 w-full"><i data-lucide="search" class="absolute left-4 top-3.5 text-slate-500 w-5 h-5"></i><input type="text" id="search-input" onkeyup="filterList()" placeholder="ค้นหาชื่อ หรือ ทีม..." class="w-full pl-12 pr-4 py-3 bg-black/20 border border-white/10 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all text-white focus:bg-black/40"></div>
                            <div class="flex-1 w-full md:w-auto"><select onchange="setFilterTeam(this.value)" class="w-full glass-input px-4 py-3 rounded-xl appearance-none cursor-pointer"><option value="All" ${state.filterTeam==='All'?'selected':''}>ทุกทีม (All Teams)</option>${teams.filter(t=>t!=='All').map(t=>`<option value="${t}" ${state.filterTeam===t?'selected':''}>${t}</option>`).join('')}</select></div>
                            <div class="h-8 w-px bg-white/10 hidden md:block"></div>
                            <div class="flex gap-2"><button onclick="setSort('name')" class="p-2 rounded-xl border ${state.sortBy === 'name' ? 'bg-blue-500/20 border-blue-500/50 text-blue-400' : 'bg-transparent border-white/10 text-slate-500 hover:text-white'}" title="เรียงตามชื่อ"><i data-lucide="arrow-down-a-z" class="w-5 h-5"></i></button><button onclick="setSort('score')" class="p-2 rounded-xl border ${state.sortBy === 'score' ? 'bg-blue-500/20 border-blue-500/50 text-blue-400' : 'bg-transparent border-white/10 text-slate-500 hover:text-white'}" title="เรียงตามคะแนน"><i data-lucide="trophy" class="w-5 h-5"></i></button></div>
                        </div>
                        <div id="tech-list" class="space-y-4">${listItems}</div>
                    ` : `
                        <div class="space-y-6">
                            <div class="glass-card p-6 rounded-3xl border border-white/10">
                                <h3 class="font-bold text-white mb-6 text-center text-lg">ภาพรวมคะแนนเฉลี่ยทุกทีม (All Teams Overview)</h3>
                                <div class="relative h-[350px] w-full"><canvas id="allTeamsBarChart"></canvas></div>
                            </div>
                            <div class="glass-card p-6 rounded-3xl border border-white/10">
                                <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                                    <h3 class="font-bold text-white flex items-center gap-2"><i data-lucide="radar" class="w-5 h-5 text-blue-400"></i> เปรียบเทียบจุดแข็ง (เลือกได้สูงสุด 3 ทีม)</h3>
                                    <div class="flex gap-2 flex-wrap justify-end">
                                        ${teams.filter(t=>t!=='All').map(t => `
                                            <button onclick="toggleRadarTeam('${t}')" class="px-3 py-1 rounded-lg text-xs font-bold border transition-all ${state.selectedTeamsForRadar.includes(t) ? 'bg-blue-600 border-blue-500 text-white' : 'bg-transparent border-white/10 text-slate-500 hover:text-white'}">${t}</button>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="relative h-[400px] w-full"><canvas id="teamRadarChart"></canvas></div>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

        function renderProfile() {
            const tech = state.selectedTech;
            if (!tech) return '';
            const skillsToRender = state.isEditing ? state.tempSkills : (state.userSkillsMap[tech.id] || []);
            const scores = calculateAllScores(skillsToRender);
            const isSkillTab = state.profileTab === 'skills';

            return `
                <div class="fade-in pb-20">
                    <div class="glass-card p-6 rounded-3xl mb-8 sticky top-4 z-40 flex flex-col md:flex-row items-center justify-between gap-6 transition-all duration-300 border border-white/10 shadow-2xl shadow-black/20">
                        <div class="flex items-center gap-6 w-full md:w-auto">
                            <button onclick="navigateTo('dashboard')" class="p-3 rounded-xl bg-white/5 hover:bg-white/10 text-slate-400 hover:text-white border border-white/5 transition-all"><i data-lucide="arrow-left"></i></button>
                            <div class="flex items-center gap-5">
                                <div class="w-16 h-16 rounded-2xl ${tech.avatar} flex items-center justify-center text-white font-bold text-3xl shadow-lg border border-white/10">${tech.name.charAt(0)}</div>
                                <div><h1 class="text-2xl font-bold text-white tracking-tight">${tech.name}</h1><p class="text-slate-400 font-medium flex items-center gap-2 mt-1"><span class="bg-blue-500/20 text-blue-400 border border-blue-500/30 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider">${tech.id}</span> ${tech.position}</p></div>
                            </div>
                        </div>
                        <div class="flex gap-3 w-full md:w-auto">
                            ${state.isEditing 
                                ? `<button onclick="cancelEdit()" class="px-6 py-3 text-slate-400 font-bold hover:text-white hover:bg-white/10 rounded-xl transition-colors">ยกเลิก</button>
                                   <button id="save-btn" onclick="saveData()" class="px-8 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold rounded-xl shadow-lg hover:shadow-green-500/30 hover:-translate-y-1 transition-all flex items-center gap-2"><i data-lucide="save" class="w-5 h-5"></i> บันทึกผล</button>`
                                : `<button onclick="startEdit()" class="px-6 py-3 bg-white/5 border border-white/10 text-slate-300 font-bold rounded-xl shadow-sm hover:bg-white/10 hover:text-white hover:border-white/20 transition-all flex items-center gap-2"><i data-lucide="edit-3" class="w-5 h-5"></i> แก้ไข / ประเมิน</button>`
                            }
                        </div>
                    </div>
                    ${isSkillTab ? `
                        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                            <div class="lg:col-span-4 space-y-6">
                                <div class="glass-card p-8 rounded-3xl sticky top-36 border border-white/5">
                                    <h3 class="font-bold text-white mb-8 text-center text-lg">Competency Map</h3>
                                    <div class="relative h-64 w-full"><canvas id="skillRadarChart"></canvas></div>
                                    <div class="mt-8 flex justify-center gap-10 border-t border-white/5 pt-6">
                                        <div class="text-center"><div class="text-4xl font-black text-blue-500 drop-shadow-sm">${Math.round(scores.total)}</div><div class="text-[10px] text-slate-500 uppercase font-bold tracking-widest mt-1">Raw Score</div></div>
                                        <div class="text-center"><div class="text-4xl font-black ${scores.overallPercent > 70 ? 'text-green-500' : 'text-yellow-500'} drop-shadow-sm">${scores.overallPercent}%</div><div class="text-[10px] text-slate-500 uppercase font-bold tracking-widest mt-1">Overall</div></div>
                                    </div>
                                    ${state.isEditing ? `<div class="mt-6 p-4 bg-blue-500/10 text-blue-400 text-sm rounded-xl border border-blue-500/20 flex items-center justify-center gap-3 animate-pulse font-bold"><i data-lucide="pen-tool" class="w-4 h-4"></i> กำลังอยู่ในโหมดแก้ไข</div>` : ''}
                                </div>
                            </div>
                            <div class="lg:col-span-8 space-y-5">
                                ${renderAccordion('electrical', scores.electrical, skillsToRender)}
                                ${renderAccordion('mechanical', scores.mechanical, skillsToRender)}
                                ${renderAccordion('troubleshooting', scores.troubleshooting, skillsToRender)}
                                ${renderAccordion('safety', scores.safety, skillsToRender)}
                            </div>
                        </div>
                    ` : `<div><!-- History Tab Removed --></div>`}
                </div>
            `;
        }

        function renderCompare() {
            const techs = state.technicians;
            const t1 = techs.find(t => t.id === state.compareTech1) || techs[0];
            const t2 = techs.find(t => t.id === state.compareTech2) || techs[1];
            
            const s1 = calculateAllScores(state.userSkillsMap[t1.id] || []);
            const s2 = calculateAllScores(state.userSkillsMap[t2.id] || []);

            return `
                <div class="fade-in pb-20">
                    <div class="flex items-center gap-4 mb-8">
                        <button onclick="navigateTo('home')" class="p-2 rounded-full hover:bg-white/10 text-slate-400 hover:text-white transition-all"><i data-lucide="arrow-left"></i></button>
                        <h2 class="text-2xl font-bold text-white">เปรียบเทียบรายบุคคล (Head-to-Head)</h2>
                    </div>

                    <div class="glass-card p-6 rounded-3xl mb-8 border border-white/10">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                            <!-- Selectors -->
                            <div class="flex gap-4 items-center">
                                <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center font-bold text-white">A</div>
                                <select onchange="setCompareTech(1, this.value)" class="w-full glass-input px-4 py-2 rounded-xl appearance-none cursor-pointer">
                                    ${techs.map(t => `<option value="${t.id}" ${t.id === t1.id ? 'selected' : ''}>${t.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="flex gap-4 items-center">
                                <div class="w-10 h-10 rounded-full bg-red-500 flex items-center justify-center font-bold text-white">B</div>
                                <select onchange="setCompareTech(2, this.value)" class="w-full glass-input px-4 py-2 rounded-xl appearance-none cursor-pointer">
                                    ${techs.map(t => `<option value="${t.id}" ${t.id === t2.id ? 'selected' : ''}>${t.name}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Chart -->
                        <div class="glass-card p-8 rounded-3xl border border-white/10 flex flex-col justify-center">
                            <div class="relative h-[400px] w-full"><canvas id="compareChart"></canvas></div>
                        </div>

                        <!-- Stats Comparison -->
                        <div class="space-y-4">
                            ${['electrical', 'mechanical', 'troubleshooting', 'safety'].map(key => {
                                const cat = state.masterSkills[key];
                                const v1 = s1[key].percentage;
                                const v2 = s2[key].percentage;
                                const diff = v1 - v2;
                                return `
                                    <div class="glass-card p-4 rounded-2xl border border-white/5">
                                        <div class="flex justify-between items-center mb-2">
                                            <div class="flex items-center gap-2 text-slate-300 font-bold"><i data-lucide="${cat.icon}" class="w-4 h-4"></i> ${cat.title}</div>
                                            <div class="text-xs ${diff > 0 ? 'text-blue-400' : (diff < 0 ? 'text-red-400' : 'text-slate-500')}">${diff > 0 ? '+' + diff : diff}%</div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <div class="flex-1 h-2 bg-slate-800 rounded-full overflow-hidden flex">
                                                <div class="h-full bg-blue-500" style="width: ${v1}%"></div>
                                            </div>
                                            <div class="w-8 text-right text-xs text-blue-400 font-bold">${v1}%</div>
                                        </div>
                                        <div class="flex items-center gap-2 mt-1">
                                            <div class="flex-1 h-2 bg-slate-800 rounded-full overflow-hidden flex">
                                                <div class="h-full bg-red-500" style="width: ${v2}%"></div>
                                            </div>
                                            <div class="w-8 text-right text-xs text-red-400 font-bold">${v2}%</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                            
                             <div class="glass-card p-4 rounded-2xl border border-white/5 bg-white/5">
                                <div class="flex justify-between text-slate-400 text-xs uppercase font-bold mb-2"><div>Total Score</div><div>Winner</div></div>
                                <div class="flex justify-between items-end">
                                    <div class="flex gap-4">
                                        <div class="text-blue-400 font-black text-2xl">${s1.total}</div>
                                        <div class="text-red-400 font-black text-2xl">${s2.total}</div>
                                    </div>
                                    <div class="text-white font-bold">${s1.total > s2.total ? t1.name : (s2.total > s1.total ? t2.name : 'Tie')}</div>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAccordion(key, scoreData, userSkills) {
            const category = state.masterSkills[key];
            if (!category || category.items.length === 0) return '';
            const isOpen = state.isEditing;
            const accordionId = `acc-${key}`;
            let itemsHtml = '';
            for (let lvl = 1; lvl <= 5; lvl++) {
                const items = category.items.filter(i => i.level === lvl);
                if (items.length === 0) continue;
                itemsHtml += `
                    <div class="mb-6 pl-5 border-l-2 border-white/5 ml-2">
                        <div class="text-xs font-bold text-slate-500 uppercase mb-3 tracking-wider flex items-center gap-2"><span class="w-1.5 h-1.5 rounded-full bg-slate-600"></span> Level ${lvl}</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            ${items.map(item => {
                                const isChecked = userSkills.includes(item.id);
                                const action = state.isEditing ? `onclick="toggleSkill('${item.id}')"` : '';
                                const cursor = state.isEditing ? 'cursor-pointer hover:bg-white/5 active:scale-[0.99]' : 'cursor-default opacity-80';
                                const style = isChecked ? 'bg-gradient-to-r from-blue-500/10 to-purple-500/10 border-blue-500/40' : 'bg-transparent border-white/10';
                                const check = isChecked ? `<div class="w-5 h-5 bg-blue-500 rounded text-white flex items-center justify-center shadow-lg shadow-blue-500/40"><i data-lucide="check" class="w-3 h-3"></i></div>` : `<div class="w-5 h-5 bg-white/5 border border-white/10 rounded"></div>`;
                                return `<div ${action} class="flex gap-4 p-4 rounded-xl border transition-all duration-200 ${style} ${cursor}"><div class="shrink-0 pt-0.5">${check}</div><div class="flex-1"><div class="text-sm ${isChecked ? 'text-white font-medium' : 'text-slate-500'}">${item.text}</div><div class="text-[10px] text-slate-500 mt-1.5 font-mono flex gap-2 items-center"><span class="bg-white/5 px-1.5 py-0.5 rounded border border-white/5">${item.id}</span> <span>•</span> <span>${item.weight} pts</span></div></div></div>`;
                            }).join('')}
                        </div>
                    </div>`;
            }
            return `<div class="glass-card rounded-2xl overflow-hidden transition-all hover:shadow-lg duration-300 border border-white/5"><div onclick="toggleAccordion('${accordionId}')" class="p-6 flex justify-between items-center cursor-pointer bg-white/5 hover:bg-white/10 transition-colors"><div class="flex items-center gap-5 flex-1"><div class="p-3 rounded-2xl ${category.bg} text-white shadow-lg shadow-${category.theme}-500/30"><i data-lucide="${category.icon}" class="w-6 h-6"></i></div><div class="flex-1"><h3 class="font-bold text-xl ${category.color}">${category.title}</h3><div class="flex items-center gap-3 mt-2"><div class="w-48 h-1.5 bg-slate-800 rounded-full overflow-hidden shadow-inner"><div class="h-full ${category.bg} shadow-[0_0_10px_currentColor]" style="width: ${scoreData.percentage}%"></div></div><span class="text-xs text-slate-400 font-bold">${scoreData.percentage}%</span></div></div></div><div class="text-right hidden sm:block mr-6"><div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Total Score</div><div class="text-2xl font-black text-slate-200">${scoreData.raw} <span class="text-sm text-slate-500 font-medium">/ ${scoreData.total}</span></div></div><i id="icon-${accordionId}" data-lucide="chevron-down" class="text-slate-500 transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}"></i></div><div id="${accordionId}" class="transition-all duration-500 ease-in-out border-t border-white/5 bg-black/20 ${isOpen ? 'max-h-[3000px] opacity-100 p-6' : 'max-h-0 opacity-0 p-0 overflow-hidden'}">${itemsHtml}</div></div>`;
        }

        // --- 6. LOGIC ---
        function navigateTo(view) { state.currentView = view; render(); }
        function logout() { state.currentView = 'login'; render(); }
        function handleLogin() { const input = document.getElementById('pin-input'); if (input.value === CONFIG.ACCESS_PIN) { state.currentView = 'home'; render(); } else { document.getElementById('login-msg').classList.remove('opacity-0'); } }
        function checkEnter(e) { if(e.key === 'Enter') handleLogin(); }
        function selectTech(id) { state.selectedTech = state.technicians.find(t => t.id === id); state.currentView = 'profile'; render(); }
        function switchTab(tab) { state.dashboardTab = tab; render(); }
        function switchProfileTab(tab) { state.profileTab = tab; render(); }
        function setFilterTeam(team) { state.filterTeam = team; render(); }
        function setSort(type) { state.sortBy = type; render(); }
        function startEdit() { state.isEditing = true; state.profileTab = 'skills'; state.tempSkills = [...(state.userSkillsMap[state.selectedTech.id] || [])]; render(); }
        function cancelEdit() { state.isEditing = false; render(); }
        function toggleSkill(id) { const idx = state.tempSkills.indexOf(id); if (idx > -1) state.tempSkills.splice(idx, 1); else state.tempSkills.push(id); render(); }
        function toggleAccordion(id) { const el = document.getElementById(id); const icon = document.getElementById('icon-' + id); if (el.classList.contains('max-h-0')) { el.classList.remove('max-h-0', 'opacity-0', 'p-0', 'overflow-hidden'); el.classList.add('max-h-[3000px]', 'opacity-100', 'p-6'); icon.classList.add('rotate-180'); } else { el.classList.add('max-h-0', 'opacity-0', 'p-0', 'overflow-hidden'); el.classList.remove('max-h-[3000px]', 'opacity-100', 'p-6'); icon.classList.remove('rotate-180'); } }
        function filterList() { render(); }
        
        function setCompareTech(slot, id) {
            if(slot === 1) state.compareTech1 = id;
            else state.compareTech2 = id;
            render();
        }

        function toggleRadarTeam(team) {
            const idx = state.selectedTeamsForRadar.indexOf(team);
            if(idx > -1) state.selectedTeamsForRadar.splice(idx, 1);
            else if(state.selectedTeamsForRadar.length < 3) state.selectedTeamsForRadar.push(team);
            renderTeamRadar(); // Re-render chart only
            // Re-render buttons
            const btns = document.querySelectorAll('button[onclick^="toggleRadarTeam"]');
            btns.forEach(btn => {
                const tName = btn.innerText;
                if(state.selectedTeamsForRadar.includes(tName)) btn.className = "px-3 py-1 rounded-lg text-xs font-bold border transition-all bg-blue-600 border-blue-500 text-white";
                else btn.className = "px-3 py-1 rounded-lg text-xs font-bold border transition-all bg-transparent border-white/10 text-slate-500 hover:text-white";
            });
        }

        async function saveData() {
            if(!CONFIG.SCRIPT_URL.startsWith("http")) { alert("กรุณาใส่ลิงก์ Google Apps Script URL ก่อน"); return; }
            const btn = document.getElementById('save-btn'); btn.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> กำลังบันทึก...`; btn.disabled = true; lucide.createIcons();
            try {
                const response = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ techId: state.selectedTech.id, skills: state.tempSkills }) });
                const result = await response.json();
                if (result.status === 'success') {
                    state.userSkillsMap[state.selectedTech.id] = [...state.tempSkills];
                    if (state.historyLogs) state.historyLogs.unshift({ Timestamp: new Date().toISOString(), Tech_ID: state.selectedTech.id, Total_Skills: state.tempSkills.length, Skills_List: state.tempSkills.join(', ') });
                    state.isEditing = false;
                    alert("✅ บันทึกข้อมูลเรียบร้อย"); render();
                } else { throw new Error(result.message); }
            } catch (err) { console.error(err); alert("⚠️ บันทึกไม่สำเร็จ: " + err.message); btn.innerHTML = `<i data-lucide="save" class="w-5 h-5"></i> บันทึกผล`; btn.disabled = false; lucide.createIcons(); }
        }

        function calculateTeamStats() {
            const teams = {}; 
            state.technicians.forEach(tech => {
                const teamName = tech.team || 'Unknown';
                if (!teams[teamName]) teams[teamName] = { electrical: [], mechanical: [], troubleshooting: [], safety: [] };
                const scores = calculateAllScores(state.userSkillsMap[tech.id] || []);
                teams[teamName].electrical.push(scores.electrical.percentage);
                teams[teamName].mechanical.push(scores.mechanical.percentage);
                teams[teamName].troubleshooting.push(scores.troubleshooting.percentage);
                teams[teamName].safety.push(scores.safety.percentage);
            });
            return Object.keys(teams).map(team => {
                const t = teams[team];
                const avg = (arr) => arr.length ? Math.round(arr.reduce((a,b)=>a+b, 0)/arr.length) : 0;
                return { team, electrical: avg(t.electrical), mechanical: avg(t.mechanical), troubleshooting: avg(t.troubleshooting), safety: avg(t.safety) };
            });
        }

        function renderAllTeamsBar() {
            const ctx = document.getElementById('allTeamsBarChart'); if (!ctx) return;
            const data = calculateTeamStats();
            if (chartInstances.teamBar) chartInstances.teamBar.destroy();
            
            const labels = data.map(d => d.team);
            const datasets = [
                { label: 'Electrical', data: data.map(d => d.electrical), backgroundColor: '#facc15' },
                { label: 'Mechanical', data: data.map(d => d.mechanical), backgroundColor: '#3b82f6' },
                { label: 'Analysis', data: data.map(d => d.troubleshooting), backgroundColor: '#a855f7' },
                { label: 'Safety', data: data.map(d => d.safety), backgroundColor: '#22c55e' }
            ];

            chartInstances.teamBar = new Chart(ctx, { 
                type: 'bar', 
                data: { labels, datasets }, 
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { labels: { color: '#cbd5e1' } } }, 
                    scales: { y: { beginAtZero: true, max: 100, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8' } }, x: { grid: { display: false }, ticks: { color: '#cbd5e1' } } } 
                } 
            });
        }

        function renderTeamRadar() {
            const ctx = document.getElementById('teamRadarChart'); if (!ctx) return;
            const allData = calculateTeamStats();
            const selectedData = allData.filter(d => state.selectedTeamsForRadar.includes(d.team));
            if (chartInstances.teamRadar) chartInstances.teamRadar.destroy();
            
            const datasets = selectedData.map((t, i) => ({ 
                label: t.team,
                data: [t.electrical, t.mechanical, t.troubleshooting, t.safety],
                borderColor: ['#3b82f6', '#10b981', '#f59e0b'][i % 3],
                backgroundColor: ['rgba(59, 130, 246, 0.2)', 'rgba(16, 185, 129, 0.2)', 'rgba(245, 158, 11, 0.2)'][i % 3],
                borderWidth: 2
            }));

            chartInstances.teamRadar = new Chart(ctx, { 
                type: 'radar', 
                data: { labels: ['Electrical', 'Mechanical', 'Analysis', 'Safety'], datasets: datasets }, 
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    scales: { r: { min: 0, max: 100, grid: { color: 'rgba(255,255,255,0.1)' }, angleLines: { color: 'rgba(255,255,255,0.1)' }, pointLabels: { color: '#94a3b8', font: { family: 'Sarabun', size: 12 } }, ticks: { display: false, backdropColor: 'transparent' } } }, 
                    plugins: { legend: { position: 'bottom', labels: { color: '#cbd5e1', font: { family: 'Sarabun' } } } } 
                } 
            });
        }

        function renderCompareChart() {
            const ctx = document.getElementById('compareChart'); if (!ctx) return;
            const t1 = state.technicians.find(t => t.id === state.compareTech1);
            const t2 = state.technicians.find(t => t.id === state.compareTech2);
            if(!t1 || !t2) return;

            const s1 = calculateAllScores(state.userSkillsMap[t1.id] || []);
            const s2 = calculateAllScores(state.userSkillsMap[t2.id] || []);

            if (chartInstances.compareRadar) chartInstances.compareRadar.destroy();
            chartInstances.compareRadar = new Chart(ctx, { 
                type: 'radar', 
                data: { 
                    labels: ['Electrical', 'Mechanical', 'Analysis', 'Safety'], 
                    datasets: [
                        { label: t1.name, data: [s1.electrical.normalized, s1.mechanical.normalized, s1.troubleshooting.normalized, s1.safety.normalized], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.2)', borderWidth: 2 },
                        { label: t2.name, data: [s2.electrical.normalized, s2.mechanical.normalized, s2.troubleshooting.normalized, s2.safety.normalized], borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.2)', borderWidth: 2 }
                    ] 
                }, 
                options: { responsive: true, maintainAspectRatio: false, scales: { r: { min: 0, max: 5, grid: { color: 'rgba(255,255,255,0.1)' }, angleLines: { color: 'rgba(255,255,255,0.1)' }, pointLabels: { color: '#94a3b8' }, ticks: { display: false } } }, plugins: { legend: { labels: { color: '#cbd5e1' } } } } 
            });
        }

        function renderChart() {
            const ctx = document.getElementById('skillRadarChart'); if (!ctx) return;
            const tech = state.selectedTech;
            const skills = state.isEditing ? state.tempSkills : (state.userSkillsMap[tech.id] || []);
            const s = calculateAllScores(skills);
            const targets = ROLE_TARGETS[tech.position] || { electrical: 3, mechanical: 3, troubleshooting: 3, safety: 3 };
            if (chartInstances.profileRadar) chartInstances.profileRadar.destroy();
            chartInstances.profileRadar = new Chart(ctx, { type: 'radar', data: { labels: ['Electrical', 'Mechanical', 'Troubleshoot', 'Safety'], datasets: [{ label: 'Actual', data: [s.electrical.normalized, s.mechanical.normalized, s.troubleshooting.normalized, s.safety.normalized], backgroundColor: 'rgba(59, 130, 246, 0.4)', borderColor: '#3b82f6', borderWidth: 2, pointBackgroundColor: '#3b82f6', pointBorderColor: '#fff', pointHoverBackgroundColor: '#fff', pointHoverBorderColor: '#3b82f6' }, { label: 'Target', data: [targets.electrical, targets.mechanical, targets.troubleshooting, targets.safety], borderColor: 'rgba(148, 163, 184, 0.5)', borderDash: [5, 5], borderWidth: 2, fill: false, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { r: { min: 0, max: 5, ticks: { display: false, stepSize: 1 }, grid: { color: 'rgba(0,0,0,0.05)' }, angleLines: { color: 'rgba(0,0,0,0.05)' }, pointLabels: { font: { size: 12, weight: 'bold', family: 'Sarabun' }, color: '#64748b' } } }, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, font: { family: 'Sarabun' }, color: '#cbd5e1' } } } } });
        }

        window.onload = initData;
    </script>
</body>
</html>